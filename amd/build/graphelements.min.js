define(["qtype_coderunner/graphutil"],function(a){function b(a,b,c){this.parent=a,this.x=b,this.y=c,this.mouseOffsetX=0,this.mouseOffsetY=0,this.isAcceptState=!1,this.textBox=new i("",this),this.caretPosition=0}function c(a,b,c){this.parent=a,this.nodeA=b,this.nodeB=c,this.textBox=new i("",this),this.lineAngleAdjust=0,this.caretPosition=0,this.parallelPart=.5,this.perpendicularPart=0}function d(a,b,c){this.parent=a,this.node=b,this.anchorAngle=0,this.mouseOffsetAngle=0,this.textBox=new i("",this),c&&this.setAnchorPoint(c.x,c.y)}function e(a,b,c){this.parent=a,this.node=b,this.deltaX=0,this.deltaY=0,c&&this.setAnchorPoint(c.x,c.y)}function f(a,b,c){this.parent=a,this.from=b,this.to=c}function g(a,b,c,d){this.BUTTON_WIDTH=60,this.BUTTON_HEIGHT=25,this.TEXT_OFFSET_X=30,this.TEXT_OFFSET_Y=17,this.topX=b,this.topY=c,this.parent=a,this.text=d,this.highLighted=!1}function h(a,b,c){g.call(this,a,b,c,"Help"),this.helpOpen=!1,this.LINE_HEIGHT=18,this.HELP_INDENT=5}function i(a,b){this.text=a,this.parent=b,this.caretPosition=a.length,this.relDist=.5,this.offset=b.parent.textOffset(),this.dragged=!1,this.boundingBox={}}return b.prototype.setMouseStart=function(a,b){this.mouseOffsetX=this.x-a,this.mouseOffsetY=this.y-b},b.prototype.setAnchorPoint=function(a,b){this.x=a+this.mouseOffsetX,this.y=b+this.mouseOffsetY},b.prototype.trackMouse=function(a,b){this.x=this.mouseOffsetX+a,this.y=this.mouseOffsetY+b},b.prototype.draw=function(a){a.beginPath(),a.arc(this.x,this.y,this.parent.nodeRadius(),0,2*Math.PI,!1),a.stroke(),this.textBox.draw(this.x,this.y,null,this),this.isAcceptState&&(a.beginPath(),a.arc(this.x,this.y,this.parent.nodeRadius()-6,0,2*Math.PI,!1),a.stroke())},b.prototype.closestPointOnCircle=function(a,b){var c=a-this.x,d=b-this.y,e=Math.sqrt(c*c+d*d);return{x:this.x+c*this.parent.nodeRadius()/e,y:this.y+d*this.parent.nodeRadius()/e}},b.prototype.containsPoint=function(a,b){return(a-this.x)*(a-this.x)+(b-this.y)*(b-this.y)<this.parent.nodeRadius()*this.parent.nodeRadius()},b.prototype.neighbours=function(a){for(var b,d=[],e=0;e<a.length;e++)b=a[e],b instanceof c&&(b.nodeA!==this||d.includes(b.nodeB)?b.nodeB!==this||d.includes(b.nodeA)||d.push(b.nodeA):d.push(b.nodeB));return d},b.prototype.traverseGraph=function(a,b){var c,d;if(!b.includes(this)){b.push(this),c=this.neighbours(a);for(var e=0;e<c.length;e++)d=c[e],b.includes(d)||d.traverseGraph(a,b)}return b},c.prototype.getAnchorPoint=function(){var a=this.nodeB.x-this.nodeA.x,b=this.nodeB.y-this.nodeA.y,c=Math.sqrt(a*a+b*b);return{x:this.nodeA.x+a*this.parallelPart-b*this.perpendicularPart/c,y:this.nodeA.y+b*this.parallelPart+a*this.perpendicularPart/c}},c.prototype.setAnchorPoint=function(a,b){var c=this.nodeB.x-this.nodeA.x,d=this.nodeB.y-this.nodeA.y,e=Math.sqrt(c*c+d*d);this.parallelPart=(c*(a-this.nodeA.x)+d*(b-this.nodeA.y))/(e*e),this.perpendicularPart=(c*(b-this.nodeA.y)-d*(a-this.nodeA.x))/e,this.parallelPart>0&&this.parallelPart<1&&Math.abs(this.perpendicularPart)<this.parent.SNAP_TO_PADDING&&(this.lineAngleAdjust=(this.perpendicularPart<0)*Math.PI,this.perpendicularPart=0)},c.prototype.getEndPointsAndCircle=function(){if(0===this.perpendicularPart){var b=(this.nodeA.x+this.nodeB.x)/2,c=(this.nodeA.y+this.nodeB.y)/2,d=this.nodeA.closestPointOnCircle(b,c),e=this.nodeB.closestPointOnCircle(b,c);return{hasCircle:!1,startX:d.x,startY:d.y,endX:e.x,endY:e.y}}var f=this.getAnchorPoint(),g=a.circleFromThreePoints(this.nodeA.x,this.nodeA.y,this.nodeB.x,this.nodeB.y,f.x,f.y),h=this.perpendicularPart>0,i=h?1:-1,j=i*this.parent.nodeRadius()/g.radius,k=Math.atan2(this.nodeA.y-g.y,this.nodeA.x-g.x)-j,l=Math.atan2(this.nodeB.y-g.y,this.nodeB.x-g.x)+j,m=g.x+g.radius*Math.cos(k),n=g.y+g.radius*Math.sin(k),o=g.x+g.radius*Math.cos(l),p=g.y+g.radius*Math.sin(l);return{hasCircle:!0,startX:m,startY:n,endX:o,endY:p,startAngle:k,endAngle:l,circleX:g.x,circleY:g.y,circleRadius:g.radius,reverseScale:i,isReversed:h}},c.prototype.draw=function(a){var b,c,d,e,f=this.getEndPointsAndCircle();if(a.beginPath(),f.hasCircle?a.arc(f.circleX,f.circleY,f.circleRadius,f.startAngle,f.endAngle,f.isReversed):(a.moveTo(f.startX,f.startY),a.lineTo(f.endX,f.endY)),a.stroke(),f.hasCircle?this.parent.arrowIfReqd(a,f.endX,f.endY,f.endAngle-f.reverseScale*(Math.PI/2)):this.parent.arrowIfReqd(a,f.endX,f.endY,Math.atan2(f.endY-f.startY,f.endX-f.startX)),e=this.textBox.relDist,f.hasCircle){var g=f.startAngle,h=f.endAngle;h<g&&(h+=2*Math.PI),d=(1-e)*g+e*h,f.isReversed&&(d+=(1-e)*(2*Math.PI)),b=f.circleX+f.circleRadius*Math.cos(d),c=f.circleY+f.circleRadius*Math.sin(d),this.textBox.draw(b,c,d,this)}else b=(1-e)*f.startX+e*f.endX,c=(1-e)*f.startY+e*f.endY,d=Math.atan2(f.endX-f.startX,f.startY-f.endY),this.textBox.draw(b,c,d+this.lineAngleAdjust,this)},c.prototype.containsPoint=function(a,b){var c,d,e,f=this.getEndPointsAndCircle();if(!f.hasCircle){c=f.endX-f.startX,d=f.endY-f.startY;var g=Math.sqrt(c*c+d*d),h=(c*(a-f.startX)+d*(b-f.startY))/(g*g);return e=(c*(b-f.startY)-d*(a-f.startX))/g,h>0&&h<1&&Math.abs(e)<this.parent.HIT_TARGET_PADDING}if(c=a-f.circleX,d=b-f.circleY,e=Math.sqrt(c*c+d*d)-f.circleRadius,Math.abs(e)<this.parent.HIT_TARGET_PADDING){var i=Math.atan2(d,c),j=f.startAngle,k=f.endAngle;if(f.isReversed){var l=j;j=k,k=l}return k<j&&(k+=2*Math.PI),i<j?i+=2*Math.PI:i>k&&(i-=2*Math.PI),i>j&&i<k}return!1},d.prototype.setMouseStart=function(a,b){this.mouseStartX=a,this.mouseStartY=b},d.prototype.setAnchorPoint=function(a,b){this.anchorAngle=Math.atan2(b-this.node.y,a-this.node.x)+this.mouseOffsetAngle;var c=Math.round(this.anchorAngle/(Math.PI/2))*(Math.PI/2);Math.abs(this.anchorAngle-c)<.1&&(this.anchorAngle=c),this.anchorAngle<-Math.PI&&(this.anchorAngle+=2*Math.PI),this.anchorAngle>Math.PI&&(this.anchorAngle-=2*Math.PI)},d.prototype.getEndPointsAndCircle=function(){var a=this.node.x+1.5*this.parent.nodeRadius()*Math.cos(this.anchorAngle),b=this.node.y+1.5*this.parent.nodeRadius()*Math.sin(this.anchorAngle),c=.75*this.parent.nodeRadius(),d=this.anchorAngle-.8*Math.PI,e=this.anchorAngle+.8*Math.PI,f=a+c*Math.cos(d),g=b+c*Math.sin(d),h=a+c*Math.cos(e),i=b+c*Math.sin(e);return{hasCircle:!0,startX:f,startY:g,endX:h,endY:i,startAngle:d,endAngle:e,circleX:a,circleY:b,circleRadius:c}},d.prototype.draw=function(a){var b=this.getEndPointsAndCircle();a.beginPath(),a.arc(b.circleX,b.circleY,b.circleRadius,b.startAngle,b.endAngle,!1),a.stroke();var c=this.textBox.relDist,d=b.startAngle*(1-c)+b.endAngle*c,e=b.circleX+b.circleRadius*Math.cos(d),f=b.circleY+b.circleRadius*Math.sin(d);this.textBox.draw(e,f,d,this),this.parent.arrowIfReqd(a,b.endX,b.endY,b.endAngle+.4*Math.PI)},d.prototype.containsPoint=function(a,b){var c=this.getEndPointsAndCircle(),d=a-c.circleX,e=b-c.circleY,f=Math.sqrt(d*d+e*e)-c.circleRadius;return Math.abs(f)<this.parent.HIT_TARGET_PADDING},e.prototype.setAnchorPoint=function(a,b){this.deltaX=a-this.node.x,this.deltaY=b-this.node.y,Math.abs(this.deltaX)<this.parent.SNAP_TO_PADDING&&(this.deltaX=0),Math.abs(this.deltaY)<this.parent.SNAP_TO_PADDING&&(this.deltaY=0)},e.prototype.getEndPoints=function(){var a=this.node.x+this.deltaX,b=this.node.y+this.deltaY,c=this.node.closestPointOnCircle(a,b);return{startX:a,startY:b,endX:c.x,endY:c.y}},e.prototype.draw=function(a){var b=this.getEndPoints();a.beginPath(),a.moveTo(b.startX,b.startY),a.lineTo(b.endX,b.endY),a.stroke(),this.parent.arrowIfReqd(a,b.endX,b.endY,Math.atan2(-this.deltaY,-this.deltaX))},e.prototype.containsPoint=function(a,b){var c=this.getEndPoints(),d=c.endX-c.startX,e=c.endY-c.startY,f=Math.sqrt(d*d+e*e),g=(d*(a-c.startX)+e*(b-c.startY))/(f*f),h=(d*(b-c.startY)-e*(a-c.startX))/f;return g>0&&g<1&&Math.abs(h)<this.parent.HIT_TARGET_PADDING},f.prototype.draw=function(a){a.beginPath(),a.moveTo(this.to.x,this.to.y),a.lineTo(this.from.x,this.from.y),a.stroke(),this.parent.arrowIfReqd(a,this.to.x,this.to.y,Math.atan2(this.to.y-this.from.y,this.to.x-this.from.x))},g.prototype.containsPoint=function(b,c){return a.isInside({x:b,y:c},{x:this.topX,y:this.topY,width:this.BUTTON_WIDTH,height:this.BUTTON_HEIGHT})},g.prototype.draw=function(a){this.highLighted?a.fillStyle="#FFFFFF":a.fillStyle="#F0F0F0",a.fillRect(this.topX,this.topY,this.BUTTON_WIDTH,this.BUTTON_HEIGHT),a.lineWidth=.5,a.strokeStyle="#000000",a.strokeRect(this.topX,this.topY,this.BUTTON_WIDTH,this.BUTTON_HEIGHT),a.font="12pt Arial",a.fillStyle="#000000",a.textAlign="center",a.fillText(this.text,this.topX+this.TEXT_OFFSET_X,this.topY+this.TEXT_OFFSET_Y),a.textAlign="left"},g.prototype.onClick=function(){},h.prototype=new g,h.prototype.draw=function(a){var b,c,d,e;if(g.prototype.draw.call(this,a),this.helpOpen)for(e=this.parent.helpText,a.font="12pt Arial",b=e.split("\n"),d=this.topY+this.BUTTON_HEIGHT,c=0;c<b.length;c+=1)d+=this.LINE_HEIGHT,a.fillText(b[c],this.topX+this.HELP_INDENT,d)},h.prototype.onClick=function(){this.helpOpen=!this.helpOpen,this.parent.draw()},i.prototype.insertChar=function(a){this.text=this.text.slice(0,this.caretPosition)+a+this.text.slice(this.caretPosition),this.caretRight()},i.prototype.deleteChar=function(){this.caretPosition>0&&(this.text=this.text.slice(0,this.caretPosition-1)+this.text.slice(this.caretPosition),this.caretLeft())},i.prototype.caretLeft=function(){this.caretPosition>0&&this.caretPosition--},i.prototype.caretRight=function(){this.caretPosition<this.text.length&&this.caretPosition++},i.prototype.containsPoint=function(b,c){var d={x:b,y:c};return a.isInside(d,this.boundingBox)},i.prototype.setMouseStart=function(a,b){this.mouseOffsetX=this.position.x-a,this.mouseOffsetY=this.position.y-b},i.prototype.setAnchorPoint=function(b,c){b+=this.mouseOffsetX||0,c+=this.mouseOffsetY||0;var d,e,f=this.parent.getEndPointsAndCircle();if(f.hasCircle){var g=Math.atan2(c-f.circleY,b-f.circleX);g<f.startAngle&&(g+=2*Math.PI),f.endAngle<f.startAngle&&(f.endAngle+=2*Math.PI),d=f.isReversed?(g-f.startAngle-2*Math.PI)/(f.endAngle-f.startAngle-2*Math.PI):(g-f.startAngle)/(f.endAngle-f.startAngle),e=a.vectorMagnitude({x:b-f.circleX,y:c-f.circleY})-f.circleRadius}else{var h={x:b-f.startX,y:c-f.startY},i={x:f.endX-f.startX,y:f.endY-f.startY},j=a.scalarProjection(h,i);d=j/a.vectorMagnitude(i),e=Math.sqrt(Math.pow(a.vectorMagnitude(h),2)-Math.pow(j,2));var k=a.isCCW(h,i),l=0!=this.parent.lineAngleAdjust;(!k&&l||k&&!l)&&(e*=-1)}d>0&&d<1&&(this.relDist=d,this.offset=Math.round(e),this.dragged=!0)},i.prototype.draw=function(b,c,d,e){var f=e.parent,g=f.getCanvas().getContext("2d");g.font=f.fontSize()+"px Arial";var h=a.convertLatexShortcuts(this.text.slice(0,this.caretPosition)),i=a.convertLatexShortcuts(this.text.slice(this.caretPosition)),j=g.measureText(h+i).width,k=Math.round(f.fontSize()/2);if(null!==d){var l=Math.cos(d),m=Math.sin(d);if(b+=this.offset*l,c+=this.offset*m,!this.dragged){var n=j/2*(l>0?1:-1),o=k/2*(m>0?1:-1),p=m*Math.pow(Math.abs(m),40)*n-l*Math.pow(Math.abs(l),10)*o;b+=n-m*p,c+=o+l*p}this.position={x:Math.round(b),y:Math.round(c)}}if(b-=j/2,b=Math.round(b),c=Math.round(c),"advancedFillText"in g)g.advancedFillText(this.text,this.text,b+j/2,c,d);else{var q=g.fillStyle;g.fillStyle="rgba(255, 255, 255, 0.7)",g.fillRect(b,c-k,j,2*k),g.fillStyle=q,k=Math.round(f.fontSize()/3),g.fillText(h,b,c+k);var r=b+g.measureText(h).width;g.fillText(i,r,c+k),k=Math.round(f.fontSize()/2),e==f.selectedObject&&f.caretVisible&&f.hasFocus()&&document.hasFocus()&&(g.beginPath(),g.moveTo(r,c-k),g.lineTo(r,c+k),g.stroke())}this.boundingBox={x:b,y:c-k,height:2*k,width:j}},{Node:b,Link:c,SelfLink:d,TemporaryLink:f,StartLink:e,Button:g,HelpBox:h,TextBox:i}});