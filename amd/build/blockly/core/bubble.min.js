'use strict';goog.provide("Blockly.Bubble");goog.require("Blockly.Scrollbar");goog.require("Blockly.Touch");goog.require("Blockly.utils");goog.require("Blockly.utils.Coordinate");goog.require("Blockly.utils.dom");goog.require("Blockly.utils.math");goog.require("Blockly.utils.userAgent");goog.require("Blockly.Workspace");goog.requireType("Blockly.utils.Metrics");Blockly.Bubble=function(a,b,c,d,e,f){this.workspace_=a;this.content_=b;this.shape_=c;this.resizeCallback_=null;this.moveCallback_=null;this.onMouseDownBubbleWrapper_=null;this.onMouseDownResizeWrapper_=null;this.disposed=!1;var g=Blockly.Bubble.ARROW_ANGLE;if(this.workspace_.RTL){g=-g}this.arrow_radians_=Blockly.utils.math.toRadians(g);var h=a.getBubbleCanvas();h.appendChild(this.createDom_(b,!!(e&&f)));this.setAnchorLocation(d);if(!e||!f){var i=this.content_.getBBox();e=i.width+2*Blockly.Bubble.BORDER_WIDTH;f=i.height+2*Blockly.Bubble.BORDER_WIDTH}this.setBubbleSize(e,f);this.positionBubble_();this.renderArrow_();this.rendered_=!0};Blockly.Bubble.BORDER_WIDTH=6;Blockly.Bubble.ARROW_THICKNESS=5;Blockly.Bubble.ARROW_ANGLE=20;Blockly.Bubble.ARROW_BEND=4;Blockly.Bubble.ANCHOR_RADIUS=8;Blockly.Bubble.onMouseUpWrapper_=null;Blockly.Bubble.onMouseMoveWrapper_=null;Blockly.Bubble.unbindDragEvents_=function(){if(Blockly.Bubble.onMouseUpWrapper_){Blockly.unbindEvent_(Blockly.Bubble.onMouseUpWrapper_);Blockly.Bubble.onMouseUpWrapper_=null}if(Blockly.Bubble.onMouseMoveWrapper_){Blockly.unbindEvent_(Blockly.Bubble.onMouseMoveWrapper_);Blockly.Bubble.onMouseMoveWrapper_=null}};Blockly.Bubble.bubbleMouseUp_=function(){Blockly.Touch.clearTouchIdentifier();Blockly.Bubble.unbindDragEvents_()};Blockly.Bubble.prototype.rendered_=!1;Blockly.Bubble.prototype.anchorXY_=null;Blockly.Bubble.prototype.relativeLeft_=0;Blockly.Bubble.prototype.relativeTop_=0;Blockly.Bubble.prototype.width_=0;Blockly.Bubble.prototype.height_=0;Blockly.Bubble.prototype.autoLayout_=!0;Blockly.Bubble.prototype.createDom_=function(a,b){this.bubbleGroup_=Blockly.utils.dom.createSvgElement("g",{},null);var c={filter:"url(#"+this.workspace_.getRenderer().getConstants().embossFilterId+")"};if(Blockly.utils.userAgent.JAVA_FX){c={}}var d=Blockly.utils.dom.createSvgElement("g",c,this.bubbleGroup_);this.bubbleArrow_=Blockly.utils.dom.createSvgElement("path",{},d);this.bubbleBack_=Blockly.utils.dom.createSvgElement("rect",{class:"blocklyDraggable",x:0,y:0,rx:Blockly.Bubble.BORDER_WIDTH,ry:Blockly.Bubble.BORDER_WIDTH},d);if(b){this.resizeGroup_=Blockly.utils.dom.createSvgElement("g",{class:this.workspace_.RTL?"blocklyResizeSW":"blocklyResizeSE"},this.bubbleGroup_);var e=2*Blockly.Bubble.BORDER_WIDTH;Blockly.utils.dom.createSvgElement("polygon",{points:"0,x x,x x,0".replace(/x/g,e.toString())},this.resizeGroup_);Blockly.utils.dom.createSvgElement("line",{class:"blocklyResizeLine",x1:e/3,y1:e-1,x2:e-1,y2:e/3},this.resizeGroup_);Blockly.utils.dom.createSvgElement("line",{class:"blocklyResizeLine",x1:2*e/3,y1:e-1,x2:e-1,y2:2*e/3},this.resizeGroup_)}else{this.resizeGroup_=null}if(!this.workspace_.options.readOnly){this.onMouseDownBubbleWrapper_=Blockly.bindEventWithChecks_(this.bubbleBack_,"mousedown",this,this.bubbleMouseDown_);if(this.resizeGroup_){this.onMouseDownResizeWrapper_=Blockly.bindEventWithChecks_(this.resizeGroup_,"mousedown",this,this.resizeMouseDown_)}}this.bubbleGroup_.appendChild(a);return this.bubbleGroup_};Blockly.Bubble.prototype.getSvgRoot=function(){return this.bubbleGroup_};Blockly.Bubble.prototype.setSvgId=function(a){if(this.bubbleGroup_.dataset){this.bubbleGroup_.dataset.blockId=a}};Blockly.Bubble.prototype.bubbleMouseDown_=function(a){var b=this.workspace_.getGesture(a);if(b){b.handleBubbleStart(a,this)}};Blockly.Bubble.prototype.showContextMenu=function(){};Blockly.Bubble.prototype.isDeletable=function(){return!1};Blockly.Bubble.prototype.resizeMouseDown_=function(a){this.promote();Blockly.Bubble.unbindDragEvents_();if(Blockly.utils.isRightButton(a)){a.stopPropagation();return}this.workspace_.startDrag(a,new Blockly.utils.Coordinate(this.workspace_.RTL?-this.width_:this.width_,this.height_));Blockly.Bubble.onMouseUpWrapper_=Blockly.bindEventWithChecks_(document,"mouseup",this,Blockly.Bubble.bubbleMouseUp_);Blockly.Bubble.onMouseMoveWrapper_=Blockly.bindEventWithChecks_(document,"mousemove",this,this.resizeMouseMove_);Blockly.hideChaff();a.stopPropagation()};Blockly.Bubble.prototype.resizeMouseMove_=function(a){this.autoLayout_=!1;var b=this.workspace_.moveDrag(a);this.setBubbleSize(this.workspace_.RTL?-b.x:b.x,b.y);if(this.workspace_.RTL){this.positionBubble_()}};Blockly.Bubble.prototype.registerResizeEvent=function(a){this.resizeCallback_=a};Blockly.Bubble.prototype.registerMoveEvent=function(a){this.moveCallback_=a};Blockly.Bubble.prototype.promote=function(){var a=this.bubbleGroup_.parentNode;if(a.lastChild!==this.bubbleGroup_){a.appendChild(this.bubbleGroup_);return!0}return!1};Blockly.Bubble.prototype.setAnchorLocation=function(a){this.anchorXY_=a;if(this.rendered_){this.positionBubble_()}};Blockly.Bubble.prototype.layoutBubble_=function(){var a=this.workspace_.getMetrics();a.viewLeft/=this.workspace_.scale;a.viewWidth/=this.workspace_.scale;a.viewTop/=this.workspace_.scale;a.viewHeight/=this.workspace_.scale;var b=this.getOptimalRelativeLeft_(a),c=this.getOptimalRelativeTop_(a),d=this.shape_.getBBox(),e={x:b,y:-this.height_-this.workspace_.getRenderer().getConstants().MIN_BLOCK_HEIGHT},f={x:-this.width_-30,y:c},g={x:d.width,y:c},h={x:b,y:d.height},i=d.width<d.height?g:h,j=d.width<d.height?h:g,k=this.getOverlap_(e,a),l=this.getOverlap_(f,a),m=this.getOverlap_(i,a),n=this.getOverlap_(j,a),o=Math.max(k,l,m,n);if(k==o){this.relativeLeft_=e.x;this.relativeTop_=e.y;return}if(l==o){this.relativeLeft_=f.x;this.relativeTop_=f.y;return}if(m==o){this.relativeLeft_=i.x;this.relativeTop_=i.y;return}this.relativeLeft_=j.x;this.relativeTop_=j.y};Blockly.Bubble.prototype.getOverlap_=function(a,b){var c={x:this.workspace_.RTL?this.anchorXY_.x-a.x-this.width_:a.x+this.anchorXY_.x,y:a.y+this.anchorXY_.y},d={x:c.x+this.width_,y:c.y+this.height_},e={x:b.viewLeft,y:b.viewTop},f={x:b.viewLeft+b.viewWidth,y:b.viewTop+b.viewHeight},g=Math.min(d.x,f.x)-Math.max(c.x,e.x),h=Math.min(d.y,f.y)-Math.max(c.y,e.y);return Math.max(0,Math.min(1,g*h/(this.width_*this.height_)))};Blockly.Bubble.prototype.getOptimalRelativeLeft_=function(a){var b=-this.width_/4;if(this.width_>a.viewWidth){return b}if(this.workspace_.RTL){var c=this.anchorXY_.x-b,d=c-this.width_,e=a.viewLeft+a.viewWidth,f=a.viewLeft+Blockly.Scrollbar.scrollbarThickness/this.workspace_.scale}else{var d=b+this.anchorXY_.x,c=d+this.width_,f=a.viewLeft,e=a.viewLeft+a.viewWidth-Blockly.Scrollbar.scrollbarThickness/this.workspace_.scale}if(this.workspace_.RTL){if(d<f){b=-(f-this.anchorXY_.x+this.width_)}else if(c>e){b=-(e-this.anchorXY_.x)}}else{if(d<f){b=f-this.anchorXY_.x}else if(c>e){b=e-this.anchorXY_.x-this.width_}}return b};Blockly.Bubble.prototype.getOptimalRelativeTop_=function(a){var b=-this.height_/4;if(this.height_>a.viewHeight){return b}var c=this.anchorXY_.y+b,d=c+this.height_,e=a.viewTop,f=a.viewTop+a.viewHeight-Blockly.Scrollbar.scrollbarThickness/this.workspace_.scale,g=this.anchorXY_.y;if(c<e){b=e-g}else if(d>f){b=f-g-this.height_}return b};Blockly.Bubble.prototype.positionBubble_=function(){var a=this.anchorXY_.x;if(this.workspace_.RTL){a-=this.relativeLeft_+this.width_}else{a+=this.relativeLeft_}var b=this.relativeTop_+this.anchorXY_.y;this.moveTo(a,b)};Blockly.Bubble.prototype.moveTo=function(a,b){this.bubbleGroup_.setAttribute("transform","translate("+a+","+b+")")};Blockly.Bubble.prototype.setDragging=function(a){if(!a&&this.moveCallback_){this.moveCallback_()}};Blockly.Bubble.prototype.getBubbleSize=function(){return new Blockly.utils.Size(this.width_,this.height_)};Blockly.Bubble.prototype.setBubbleSize=function(a,b){var c=2*Blockly.Bubble.BORDER_WIDTH;a=Math.max(a,c+45);b=Math.max(b,c+20);this.width_=a;this.height_=b;this.bubbleBack_.setAttribute("width",a);this.bubbleBack_.setAttribute("height",b);if(this.resizeGroup_){if(this.workspace_.RTL){var d=2*Blockly.Bubble.BORDER_WIDTH;this.resizeGroup_.setAttribute("transform","translate("+d+","+(b-c)+") scale(-1 1)")}else{this.resizeGroup_.setAttribute("transform","translate("+(a-c)+","+(b-c)+")")}}if(this.autoLayout_){this.layoutBubble_()}this.positionBubble_();this.renderArrow_();if(this.resizeCallback_){this.resizeCallback_()}};Blockly.Bubble.prototype.renderArrow_=function(){var a=[],b=this.width_/2,c=this.height_/2,d=-this.relativeLeft_,e=-this.relativeTop_;if(b==d&&c==e){a.push("M "+b+","+c)}else{var f=e-c,g=d-b;if(this.workspace_.RTL){g*=-1}var h=Math.sqrt(f*f+g*g),i=Math.acos(g/h);if(0>f){i=2*Math.PI-i}var j=i+Math.PI/2;if(j>2*Math.PI){j-=2*Math.PI}var k=Math.sin(j),l=Math.cos(j),m=this.getBubbleSize(),n=(m.width+m.height)/Blockly.Bubble.ARROW_THICKNESS;n=Math.min(n,m.width,m.height)/4;var o=1-Blockly.Bubble.ANCHOR_RADIUS/h;d=b+o*g;e=c+o*f;var p=b+n*l,q=c+n*k,r=b-n*l,s=c-n*k,t=i+this.arrow_radians_;if(t>2*Math.PI){t-=2*Math.PI}var u=Math.sin(t)*h/Blockly.Bubble.ARROW_BEND,v=Math.cos(t)*h/Blockly.Bubble.ARROW_BEND;a.push("M"+p+","+q);a.push("C"+(p+v)+","+(q+u)+" "+d+","+e+" "+d+","+e);a.push("C"+d+","+e+" "+(r+v)+","+(s+u)+" "+r+","+s)}a.push("z");this.bubbleArrow_.setAttribute("d",a.join(" "))};Blockly.Bubble.prototype.setColour=function(a){this.bubbleBack_.setAttribute("fill",a);this.bubbleArrow_.setAttribute("fill",a)};Blockly.Bubble.prototype.dispose=function(){if(this.onMouseDownBubbleWrapper_){Blockly.unbindEvent_(this.onMouseDownBubbleWrapper_)}if(this.onMouseDownResizeWrapper_){Blockly.unbindEvent_(this.onMouseDownResizeWrapper_)}Blockly.Bubble.unbindDragEvents_();Blockly.utils.dom.removeNode(this.bubbleGroup_);this.disposed=!0};Blockly.Bubble.prototype.moveDuringDrag=function(a,b){if(a){a.translateSurface(b.x,b.y)}else{this.moveTo(b.x,b.y)}if(this.workspace_.RTL){this.relativeLeft_=this.anchorXY_.x-b.x-this.width_}else{this.relativeLeft_=b.x-this.anchorXY_.x}this.relativeTop_=b.y-this.anchorXY_.y;this.renderArrow_()};Blockly.Bubble.prototype.getRelativeToSurfaceXY=function(){return new Blockly.utils.Coordinate(this.workspace_.RTL?-this.relativeLeft_+this.anchorXY_.x-this.width_:this.anchorXY_.x+this.relativeLeft_,this.anchorXY_.y+this.relativeTop_)};Blockly.Bubble.prototype.setAutoLayout=function(a){this.autoLayout_=a};
//# sourceMappingURL=bubble.min.js.map
