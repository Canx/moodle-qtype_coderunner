'use strict';goog.provide("Blockly.Xml");goog.require("Blockly.Events");goog.require("Blockly.Events.BlockCreate");goog.require("Blockly.Events.FinishedLoading");goog.require("Blockly.Events.VarCreate");goog.require("Blockly.utils");goog.require("Blockly.utils.dom");goog.require("Blockly.utils.global");goog.require("Blockly.utils.xml");Blockly.Xml.workspaceToDom=function(a,b){var c=Blockly.utils.xml.createElement("xml"),d=Blockly.Xml.variablesToDom(Blockly.Variables.allUsedVarModels(a));if(d.hasChildNodes()){c.appendChild(d)}for(var e=a.getTopComments(!0),f=0,g;g=e[f];f++){c.appendChild(g.toXmlWithXY(b))}for(var h=a.getTopBlocks(!0),f=0,j;j=h[f];f++){c.appendChild(Blockly.Xml.blockToDomWithXY(j,b))}return c};Blockly.Xml.variablesToDom=function(a){for(var b=Blockly.utils.xml.createElement("variables"),c=0,d,e;d=a[c];c++){e=Blockly.utils.xml.createElement("variable");e.appendChild(Blockly.utils.xml.createTextNode(d.name));if(d.type){e.setAttribute("type",d.type)}e.id=d.getId();b.appendChild(e)}return b};Blockly.Xml.blockToDomWithXY=function(a,b){if(a.isInsertionMarker()){a=a.getChildren(!1)[0];if(!a){return new DocumentFragment}}var c;if(a.workspace.RTL){c=a.workspace.getWidth()}var d=Blockly.Xml.blockToDom(a,b),e=a.getRelativeToSurfaceXY();d.setAttribute("x",Math.round(a.workspace.RTL?c-e.x:e.x));d.setAttribute("y",Math.round(e.y));return d};Blockly.Xml.fieldToDom_=function(a){if(a.isSerializable()){var b=Blockly.utils.xml.createElement("field");b.setAttribute("name",a.name||"");return a.toXml(b)}return null};Blockly.Xml.allFieldsToDom_=function(a,b){for(var c=0,d;d=a.inputList[c];c++){for(var e=0,f,g;f=d.fieldRow[e];e++){g=Blockly.Xml.fieldToDom_(f);if(g){b.appendChild(g)}}}};Blockly.Xml.blockToDom=function(a,b){if(a.isInsertionMarker()){var c=a.getChildren(!1)[0];if(c){return Blockly.Xml.blockToDom(c)}else{return new DocumentFragment}}var d=Blockly.utils.xml.createElement(a.isShadow()?"shadow":"block");d.setAttribute("type",a.type);if(!b){d.setAttribute("id",a.id)}if(a.mutationToDom){var e=a.mutationToDom();if(e&&(e.hasChildNodes()||e.hasAttributes())){d.appendChild(e)}}Blockly.Xml.allFieldsToDom_(a,d);var f=a.getCommentText();if(f){var g=a.commentModel.size,h=a.commentModel.pinned,j=Blockly.utils.xml.createElement("comment");j.appendChild(Blockly.utils.xml.createTextNode(f));j.setAttribute("pinned",h);j.setAttribute("h",g.height);j.setAttribute("w",g.width);d.appendChild(j)}if(a.data){var k=Blockly.utils.xml.createElement("data");k.appendChild(Blockly.utils.xml.createTextNode(a.data));d.appendChild(k)}for(var l=0,m;m=a.inputList[l];l++){var n,o=!0;if(m.type==Blockly.DUMMY_INPUT){continue}else{var p=m.connection.targetBlock();if(m.type==Blockly.INPUT_VALUE){n=Blockly.utils.xml.createElement("value")}else if(m.type==Blockly.NEXT_STATEMENT){n=Blockly.utils.xml.createElement("statement")}var q=m.connection.getShadowDom();if(q&&(!p||!p.isShadow())){n.appendChild(Blockly.Xml.cloneShadow_(q,b))}if(p){var r=Blockly.Xml.blockToDom(p,b);if(r.nodeType==Blockly.utils.dom.NodeType.ELEMENT_NODE){n.appendChild(r);o=!1}}}n.setAttribute("name",m.name);if(!o){d.appendChild(n)}}if(a.inputsInline!=void 0&&a.inputsInline!=a.inputsInlineDefault){d.setAttribute("inline",a.inputsInline)}if(a.isCollapsed()){d.setAttribute("collapsed",!0)}if(!a.isEnabled()){d.setAttribute("disabled",!0)}if(!a.isDeletable()&&!a.isShadow()){d.setAttribute("deletable",!1)}if(!a.isMovable()&&!a.isShadow()){d.setAttribute("movable",!1)}if(!a.isEditable()){d.setAttribute("editable",!1)}var s=a.getNextBlock();if(s){var r=Blockly.Xml.blockToDom(s,b);if(r.nodeType==Blockly.utils.dom.NodeType.ELEMENT_NODE){var n=Blockly.utils.xml.createElement("next");n.appendChild(r);d.appendChild(n)}}var q=a.nextConnection&&a.nextConnection.getShadowDom();if(q&&(!s||!s.isShadow())){n.appendChild(Blockly.Xml.cloneShadow_(q,b))}return d};Blockly.Xml.cloneShadow_=function(a,b){a=a.cloneNode(!0);var c=a,d;while(c){if(b&&"shadow"==c.nodeName){c.removeAttribute("id")}if(c.firstChild){c=c.firstChild}else{while(c&&!c.nextSibling){d=c;c=c.parentNode;if(d.nodeType==Blockly.utils.dom.NodeType.TEXT_NODE&&""==d.data.trim()&&c.firstChild!=d){Blockly.utils.dom.removeNode(d)}}if(c){d=c;c=c.nextSibling;if(d.nodeType==Blockly.utils.dom.NodeType.TEXT_NODE&&""==d.data.trim()){Blockly.utils.dom.removeNode(d)}}}}return a};Blockly.Xml.domToText=function(a){var b=Blockly.utils.xml.domToText(a),c;do{c=b;b=b.replace(/(<[^/](?:[^>]*[^/])?>[^<]*)\n([^<]*<\/)/,"$1&#10;$2")}while(b!=c);return b.replace(/<(\w+)([^<]*)\/>/g,"<$1$2></$1>")};Blockly.Xml.domToPrettyText=function(a){for(var b=Blockly.Xml.domToText(a),c=b.split("<"),d="",e=1,f;e<c.length;e++){f=c[e];if("/"==f[0]){d=d.substring(2)}c[e]=d+"<"+f;if("/"!=f[0]&&"/>"!=f.slice(-2)){d+="  "}}var g=c.join("\n");g=g.replace(/(<(\w+)\b[^>]*>[^\n]*)\n *<\/\2>/g,"$1</$2>");return g.replace(/^\n/,"")};Blockly.Xml.textToDom=function(a){var b=Blockly.utils.xml.textToDomDocument(a);if(!b||!b.documentElement||b.getElementsByTagName("parsererror").length){throw Error("textToDom was unable to parse: "+a)}return b.documentElement};Blockly.Xml.clearWorkspaceAndLoadFromXml=function(a,b){b.setResizesEnabled(!1);b.clear();var c=Blockly.Xml.domToWorkspace(a,b);b.setResizesEnabled(!0);return c};Blockly.Xml.domToWorkspace=function(a,b){if(a instanceof Blockly.Workspace){var c=a;a=b;b=c;console.warn("Deprecated call to Blockly.Xml.domToWorkspace, swap the arguments.")}var d;if(b.RTL){d=b.getWidth()}var e=[];Blockly.utils.dom.startTextWidthCache();var f=Blockly.Events.getGroup();if(!f){Blockly.Events.setGroup(!0)}if(b.setResizesEnabled){b.setResizesEnabled(!1)}var g=!0;try{for(var h=0,j;j=a.childNodes[h];h++){var k=j.nodeName.toLowerCase(),l=j;if("block"==k||"shadow"==k&&!Blockly.Events.recordUndo){var m=Blockly.Xml.domToBlock(l,b);e.push(m.id);var n=l.hasAttribute("x")?parseInt(l.getAttribute("x"),10):10,o=l.hasAttribute("y")?parseInt(l.getAttribute("y"),10):10;if(!isNaN(n)&&!isNaN(o)){m.moveBy(b.RTL?d-n:n,o)}g=!1}else if("shadow"==k){throw TypeError("Shadow block cannot be a top-level block.")}else if("comment"==k){if(b.rendered){if(!Blockly.WorkspaceCommentSvg){console.warn("Missing require for Blockly.WorkspaceCommentSvg, ignoring workspace comment.")}else{Blockly.WorkspaceCommentSvg.fromXml(l,b,d)}}else{if(!Blockly.WorkspaceComment){console.warn("Missing require for Blockly.WorkspaceComment, ignoring workspace comment.")}else{Blockly.WorkspaceComment.fromXml(l,b)}}}else if("variables"==k){if(g){Blockly.Xml.domToVariables(l,b)}else{throw Error("'variables' tag must exist once before block and shadow tag elements in the workspace XML, but it was found in another location.")}g=!1}}}finally{if(!f){Blockly.Events.setGroup(!1)}Blockly.utils.dom.stopTextWidthCache()}if(b.setResizesEnabled){b.setResizesEnabled(!0)}Blockly.Events.fire(new Blockly.Events.FinishedLoading(b));return e};Blockly.Xml.appendDomToWorkspace=function(a,b){var c;if(b.hasOwnProperty("scale")){c=b.getBlocksBoundingBox()}var d=Blockly.Xml.domToWorkspace(a,b);if(c&&c.top!=c.bottom){for(var e=0,f=0,g=c.bottom,h=b.RTL?c.right:c.left,j=1/0,k=-Infinity,l=1/0,m=10,n=0,o;n<d.length;n++){o=b.getBlockById(d[n]).getRelativeToSurfaceXY();if(o.y<l){l=o.y}if(o.x<j){j=o.x}if(o.x>k){k=o.x}}e=g-l+m;f=b.RTL?h-k:h-j;for(var n=0,p;n<d.length;n++){p=b.getBlockById(d[n]);p.moveBy(f,e)}}return d};Blockly.Xml.domToBlock=function(a,b){if(a instanceof Blockly.Workspace){var c=a;a=b;b=c;console.warn("Deprecated call to Blockly.Xml.domToBlock, swap the arguments.")}Blockly.Events.disable();var d=b.getAllVariables();try{var e=Blockly.Xml.domToBlockHeadless_(a,b),f=e.getDescendants(!1);if(b.rendered){e.setConnectionTracking(!1);for(var g=f.length-1;0<=g;g--){f[g].initSvg()}for(var g=f.length-1;0<=g;g--){f[g].render(!1)}setTimeout(function(){if(!e.disposed){e.setConnectionTracking(!0)}},1);e.updateDisabled();b.resizeContents()}else{for(var g=f.length-1;0<=g;g--){f[g].initModel()}}}finally{Blockly.Events.enable()}if(Blockly.Events.isEnabled()){for(var h=Blockly.Variables.getAddedVariables(b,d),g=0,j;g<h.length;g++){j=h[g];Blockly.Events.fire(new Blockly.Events.VarCreate(j))}Blockly.Events.fire(new Blockly.Events.BlockCreate(e))}return e};Blockly.Xml.domToVariables=function(a,b){for(var c=0,d;d=a.childNodes[c];c++){if(d.nodeType!=Blockly.utils.dom.NodeType.ELEMENT_NODE){continue}var e=d.getAttribute("type"),f=d.getAttribute("id"),g=d.textContent;b.createVariable(g,e,f)}};Blockly.Xml.domToBlockHeadless_=function(a,b){var c=null,d=a.getAttribute("type");if(!d){throw TypeError("Block type unspecified: "+a.outerHTML)}var e=a.getAttribute("id");c=b.newBlock(d,e);for(var f=null,g=0,h;h=a.childNodes[g];g++){if(h.nodeType==Blockly.utils.dom.NodeType.TEXT_NODE){continue}for(var k,l=null,m=null,n=0,o;o=h.childNodes[n];n++){if(o.nodeType==Blockly.utils.dom.NodeType.ELEMENT_NODE){if("block"==o.nodeName.toLowerCase()){l=o}else if("shadow"==o.nodeName.toLowerCase()){m=o}}}if(!l&&m){l=m}var p=h.getAttribute("name"),q=h;switch(h.nodeName.toLowerCase()){case"mutation":if(c.domToMutation){c.domToMutation(q);if(c.initSvg){c.initSvg()}}break;case"comment":if(!Blockly.Comment){console.warn("Missing require for Blockly.Comment, ignoring block comment.");break}var r=q.textContent,s="true"==q.getAttribute("pinned"),t=parseInt(q.getAttribute("w"),10),u=parseInt(q.getAttribute("h"),10);c.setCommentText(r);c.commentModel.pinned=s;if(!isNaN(t)&&!isNaN(u)){c.commentModel.size=new Blockly.utils.Size(t,u)}if(s&&c.getCommentIcon&&!c.isInFlyout){setTimeout(function(){c.getCommentIcon().setVisible(!0)},1)}break;case"data":c.data=h.textContent;break;case"title":case"field":Blockly.Xml.domToField_(c,p,q);break;case"value":case"statement":k=c.getInput(p);if(!k){console.warn("Ignoring non-existent input "+p+" in block "+d);break}if(m){k.connection.setShadowDom(m)}if(l){f=Blockly.Xml.domToBlockHeadless_(l,b);if(f.outputConnection){k.connection.connect(f.outputConnection)}else if(f.previousConnection){k.connection.connect(f.previousConnection)}else{throw TypeError("Child block does not have output or previous statement.")}}break;case"next":if(m&&c.nextConnection){c.nextConnection.setShadowDom(m)}if(l){if(!c.nextConnection){throw TypeError("Next statement does not exist.")}if(c.nextConnection.isConnected()){throw TypeError("Next statement is already connected.")}f=Blockly.Xml.domToBlockHeadless_(l,b);if(!f.previousConnection){throw TypeError("Next block does not have previous statement.")}c.nextConnection.connect(f.previousConnection)}break;default:console.warn("Ignoring unknown tag: "+h.nodeName);}}var v=a.getAttribute("inline");if(v){c.setInputsInline("true"==v)}var w=a.getAttribute("disabled");if(w){c.setEnabled("true"!=w&&"disabled"!=w)}var x=a.getAttribute("deletable");if(x){c.setDeletable("true"==x)}var y=a.getAttribute("movable");if(y){c.setMovable("true"==y)}var z=a.getAttribute("editable");if(z){c.setEditable("true"==z)}var A=a.getAttribute("collapsed");if(A){c.setCollapsed("true"==A)}if("shadow"==a.nodeName.toLowerCase()){for(var B=c.getChildren(!1),g=0,C;C=B[g];g++){if(!C.isShadow()){throw TypeError("Shadow block not allowed non-shadow child.")}}if(c.getVarModels().length){throw TypeError("Shadow blocks cannot have variable references.")}c.setShadow(!0)}return c};Blockly.Xml.domToField_=function(a,b,c){var d=a.getField(b);if(!d){console.warn("Ignoring non-existent field "+b+" in block "+a.type);return}d.fromXml(c)};Blockly.Xml.deleteNext=function(a){for(var b=0,c;c=a.childNodes[b];b++){if("next"==c.nodeName.toLowerCase()){a.removeChild(c);break}}};
//# sourceMappingURL=xml.min.js.map
