'use strict';goog.provide("Blockly.BlockDragger");goog.require("Blockly.blockAnimations");goog.require("Blockly.Events");goog.require("Blockly.Events.BlockMove");goog.require("Blockly.Events.Ui");goog.require("Blockly.InsertionMarkerManager");goog.require("Blockly.utils.Coordinate");goog.require("Blockly.utils.dom");Blockly.BlockDragger=function(a,b){this.draggingBlock_=a;this.workspace_=b;this.draggedConnectionManager_=new Blockly.InsertionMarkerManager(this.draggingBlock_);this.deleteArea_=null;this.wouldDeleteBlock_=!1;this.startXY_=this.draggingBlock_.getRelativeToSurfaceXY();this.dragIconData_=Blockly.BlockDragger.initIconData_(a)};Blockly.BlockDragger.prototype.dispose=function(){this.dragIconData_.length=0;if(this.draggedConnectionManager_){this.draggedConnectionManager_.dispose()}};Blockly.BlockDragger.initIconData_=function(a){for(var b=[],c=a.getDescendants(!1),d=0,e,f;e=c[d];d++){f=e.getIcons();for(var g=0,h;g<f.length;g++){h={location:f[g].getIconLocation(),icon:f[g]};b.push(h)}}return b};Blockly.BlockDragger.prototype.startBlockDrag=function(a,b){if(!Blockly.Events.getGroup()){Blockly.Events.setGroup(!0)}this.fireDragStartEvent_();if(this.workspace_.isMutator){this.draggingBlock_.bringToFront()}Blockly.utils.dom.startTextWidthCache();this.workspace_.setResizesEnabled(!1);Blockly.blockAnimations.disconnectUiStop();if(this.draggingBlock_.getParent()||b&&this.draggingBlock_.nextConnection&&this.draggingBlock_.nextConnection.targetBlock()){this.draggingBlock_.unplug(b);var c=this.pixelsToWorkspaceUnits_(a),d=Blockly.utils.Coordinate.sum(this.startXY_,c);this.draggingBlock_.translate(d.x,d.y);Blockly.blockAnimations.disconnectUiEffect(this.draggingBlock_);this.draggedConnectionManager_.updateAvailableConnections()}this.draggingBlock_.setDragging(!0);this.draggingBlock_.moveToDragSurface();var e=this.workspace_.getToolbox();if(e&&"function"==typeof e.addStyle){var f=this.draggingBlock_.isDeletable()?"blocklyToolboxDelete":"blocklyToolboxGrab";e.addStyle(f)}};Blockly.BlockDragger.prototype.fireDragStartEvent_=function(){var a=new Blockly.Events.Ui(this.draggingBlock_,"dragStart",null,this.draggingBlock_.getDescendants(!1));Blockly.Events.fire(a)};Blockly.BlockDragger.prototype.dragBlock=function(a,b){var c=this.pixelsToWorkspaceUnits_(b),d=Blockly.utils.Coordinate.sum(this.startXY_,c);this.draggingBlock_.moveDuringDrag(d);this.dragIcons_(c);this.deleteArea_=this.workspace_.isDeleteArea(a);this.draggedConnectionManager_.update(c,this.deleteArea_);this.updateCursorDuringBlockDrag_()};Blockly.BlockDragger.prototype.endBlockDrag=function(a,b){this.dragBlock(a,b);this.dragIconData_=[];this.fireDragEndEvent_();Blockly.utils.dom.stopTextWidthCache();Blockly.blockAnimations.disconnectUiStop();var c=this.pixelsToWorkspaceUnits_(b),d=Blockly.utils.Coordinate.sum(this.startXY_,c);this.draggingBlock_.moveOffDragSurface(d);var e=this.maybeDeleteBlock_();if(!e){this.draggingBlock_.moveConnections(c.x,c.y);this.draggingBlock_.setDragging(!1);this.fireMoveEvent_();if(this.draggedConnectionManager_.wouldConnectBlock()){this.draggedConnectionManager_.applyConnections()}else{this.draggingBlock_.render()}this.draggingBlock_.scheduleSnapAndBump()}this.workspace_.setResizesEnabled(!0);var f=this.workspace_.getToolbox();if(f&&"function"==typeof f.removeStyle){var g=this.draggingBlock_.isDeletable()?"blocklyToolboxDelete":"blocklyToolboxGrab";f.removeStyle(g)}Blockly.Events.setGroup(!1)};Blockly.BlockDragger.prototype.fireDragEndEvent_=function(){var a=new Blockly.Events.Ui(this.draggingBlock_,"dragStop",this.draggingBlock_.getDescendants(!1),null);Blockly.Events.fire(a)};Blockly.BlockDragger.prototype.fireMoveEvent_=function(){var a=new Blockly.Events.BlockMove(this.draggingBlock_);a.oldCoordinate=this.startXY_;a.recordNew();Blockly.Events.fire(a)};Blockly.BlockDragger.prototype.maybeDeleteBlock_=function(){var a=this.workspace_.trashcan;if(this.wouldDeleteBlock_){if(a){setTimeout(a.close.bind(a),100)}this.fireMoveEvent_();this.draggingBlock_.dispose(!1,!0);Blockly.draggingConnections=[]}else if(a){a.close()}return this.wouldDeleteBlock_};Blockly.BlockDragger.prototype.updateCursorDuringBlockDrag_=function(){this.wouldDeleteBlock_=this.draggedConnectionManager_.wouldDeleteBlock();var a=this.workspace_.trashcan;if(this.wouldDeleteBlock_){this.draggingBlock_.setDeleteStyle(!0);if(this.deleteArea_==Blockly.DELETE_AREA_TRASH&&a){a.setOpen(!0)}}else{this.draggingBlock_.setDeleteStyle(!1);if(a){a.setOpen(!1)}}};Blockly.BlockDragger.prototype.pixelsToWorkspaceUnits_=function(a){var b=new Blockly.utils.Coordinate(a.x/this.workspace_.scale,a.y/this.workspace_.scale);if(this.workspace_.isMutator){var c=this.workspace_.options.parentWorkspace.scale;b.scale(1/c)}return b};Blockly.BlockDragger.prototype.dragIcons_=function(a){for(var b=0,c;b<this.dragIconData_.length;b++){c=this.dragIconData_[b];c.icon.setIconLocation(Blockly.utils.Coordinate.sum(c.location,a))}};Blockly.BlockDragger.prototype.getInsertionMarkers=function(){if(this.draggedConnectionManager_&&this.draggedConnectionManager_.getInsertionMarkers){return this.draggedConnectionManager_.getInsertionMarkers()}return[]};
//# sourceMappingURL=block_dragger.min.js.map
