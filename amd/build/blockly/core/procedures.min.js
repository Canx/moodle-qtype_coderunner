'use strict';goog.provide("Blockly.Procedures");goog.require("Blockly.Blocks");goog.require("Blockly.constants");goog.require("Blockly.Events");goog.require("Blockly.Events.BlockChange");goog.require("Blockly.Field");goog.require("Blockly.Msg");goog.require("Blockly.Names");goog.require("Blockly.utils.xml");goog.require("Blockly.Workspace");goog.require("Blockly.Xml");Blockly.Procedures.NAME_TYPE=Blockly.PROCEDURE_CATEGORY_NAME;Blockly.Procedures.DEFAULT_ARG="x";Blockly.Procedures.ProcedureBlock;Blockly.Procedures.allProcedures=function(a){var b=a.getBlocksByType("procedures_defnoreturn",!1).map(function(a){return a.getProcedureDef()}),c=a.getBlocksByType("procedures_defreturn",!1).map(function(a){return a.getProcedureDef()});b.sort(Blockly.Procedures.procTupleComparator_);c.sort(Blockly.Procedures.procTupleComparator_);return[b,c]};Blockly.Procedures.procTupleComparator_=function(a,b){return a[0].toLowerCase().localeCompare(b[0].toLowerCase())};Blockly.Procedures.findLegalName=function(a,b){if(b.isInFlyout){return a}a=a||Blockly.Msg.UNNAMED_KEY||"unnamed";while(!Blockly.Procedures.isLegalName_(a,b.workspace,b)){var c=a.match(/^(.*?)(\d+)$/);if(!c){a+="2"}else{a=c[1]+(parseInt(c[2],10)+1)}}return a};Blockly.Procedures.isLegalName_=function(a,b,c){return!Blockly.Procedures.isNameUsed(a,b,c)};Blockly.Procedures.isNameUsed=function(a,b,c){for(var d=b.getAllBlocks(!1),e=0;e<d.length;e++){if(d[e]==c){continue}if(d[e].getProcedureDef){var f=d[e],g=f.getProcedureDef();if(Blockly.Names.equals(g[0],a)){return!0}}}return!1};Blockly.Procedures.rename=function(a){a=a.trim();var b=Blockly.Procedures.findLegalName(a,this.getSourceBlock()),c=this.getValue();if(c!=a&&c!=b){for(var d=this.getSourceBlock().workspace.getAllBlocks(!1),e=0;e<d.length;e++){if(d[e].renameProcedure){var f=d[e];f.renameProcedure(c,b)}}}return b};Blockly.Procedures.flyoutCategory=function(a){var c=[];if(Blockly.Blocks.procedures_defnoreturn){var d=Blockly.utils.xml.createElement("block");d.setAttribute("type","procedures_defnoreturn");d.setAttribute("gap",16);var e=Blockly.utils.xml.createElement("field");e.setAttribute("name","NAME");e.appendChild(Blockly.utils.xml.createTextNode(Blockly.Msg.PROCEDURES_DEFNORETURN_PROCEDURE));d.appendChild(e);c.push(d)}if(Blockly.Blocks.procedures_defreturn){var d=Blockly.utils.xml.createElement("block");d.setAttribute("type","procedures_defreturn");d.setAttribute("gap",16);var e=Blockly.utils.xml.createElement("field");e.setAttribute("name","NAME");e.appendChild(Blockly.utils.xml.createTextNode(Blockly.Msg.PROCEDURES_DEFRETURN_PROCEDURE));d.appendChild(e);c.push(d)}if(Blockly.Blocks.procedures_ifreturn){var d=Blockly.utils.xml.createElement("block");d.setAttribute("type","procedures_ifreturn");d.setAttribute("gap",16);c.push(d)}if(c.length){c[c.length-1].setAttribute("gap",24)}function b(a,b){for(var d=0;d<a.length;d++){var e=a[d][0],f=a[d][1],g=Blockly.utils.xml.createElement("block");g.setAttribute("type",b);g.setAttribute("gap",16);var h=Blockly.utils.xml.createElement("mutation");h.setAttribute("name",e);g.appendChild(h);for(var k=0,l;k<f.length;k++){l=Blockly.utils.xml.createElement("arg");l.setAttribute("name",f[k]);h.appendChild(l)}c.push(g)}}var f=Blockly.Procedures.allProcedures(a);b(f[0],"procedures_callnoreturn");b(f[1],"procedures_callreturn");return c};Blockly.Procedures.updateMutatorFlyout_=function(a){for(var b=[],c=a.getBlocksByType("procedures_mutatorarg",!1),d=0,e;e=c[d];d++){b.push(e.getFieldValue("NAME"))}var f=Blockly.utils.xml.createElement("xml"),g=Blockly.utils.xml.createElement("block");g.setAttribute("type","procedures_mutatorarg");var h=Blockly.utils.xml.createElement("field");h.setAttribute("name","NAME");var j=Blockly.Variables.generateUniqueNameFromOptions(Blockly.Procedures.DEFAULT_ARG,b),k=Blockly.utils.xml.createTextNode(j);h.appendChild(k);g.appendChild(h);f.appendChild(g);a.updateToolbox(f)};Blockly.Procedures.mutatorOpenListener=function(a){if(a.type!=Blockly.Events.UI||"mutatorOpen"!=a.element||!a.newValue){return}var b=a.workspaceId,c=Blockly.Workspace.getById(b).getBlockById(a.blockId),d=c.type;if("procedures_defnoreturn"!=d&&"procedures_defreturn"!=d){return}var e=c.mutator.getWorkspace();Blockly.Procedures.updateMutatorFlyout_(e);e.addChangeListener(Blockly.Procedures.mutatorChangeListener_)};Blockly.Procedures.mutatorChangeListener_=function(a){if(a.type!=Blockly.Events.BLOCK_CREATE&&a.type!=Blockly.Events.BLOCK_DELETE&&a.type!=Blockly.Events.BLOCK_CHANGE){return}var b=a.workspaceId,c=Blockly.Workspace.getById(b);Blockly.Procedures.updateMutatorFlyout_(c)};Blockly.Procedures.getCallers=function(a,b){for(var c=[],d=b.getAllBlocks(!1),e=0;e<d.length;e++){if(d[e].getProcedureCall){var f=d[e],g=f.getProcedureCall();if(g&&Blockly.Names.equals(g,a)){c.push(d[e])}}}return c};Blockly.Procedures.mutateCallers=function(a){for(var b=Blockly.Events.recordUndo,c=a.getProcedureDef()[0],d=a.mutationToDom(!0),e=Blockly.Procedures.getCallers(c,a.workspace),f=0,g;g=e[f];f++){var h=g.mutationToDom(),j=h&&Blockly.Xml.domToText(h);g.domToMutation(d);var k=g.mutationToDom(),l=k&&Blockly.Xml.domToText(k);if(j!=l){Blockly.Events.recordUndo=!1;Blockly.Events.fire(new Blockly.Events.BlockChange(g,"mutation",null,j,l));Blockly.Events.recordUndo=b}}};Blockly.Procedures.getDefinition=function(a,b){for(var c=b.getTopBlocks(!1),d=0;d<c.length;d++){if(c[d].getProcedureDef){var e=c[d],f=e.getProcedureDef();if(f&&Blockly.Names.equals(f[0],a)){return c[d]}}}return null};
//# sourceMappingURL=procedures.min.js.map
