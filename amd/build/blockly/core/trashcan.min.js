'use strict';goog.provide("Blockly.Trashcan");goog.require("Blockly.Scrollbar");goog.require("Blockly.utils.dom");goog.require("Blockly.utils.Rect");goog.require("Blockly.Xml");goog.requireType("Blockly.IDeleteArea");Blockly.Trashcan=function(a){this.workspace_=a;this.contents_=[];this.flyout=null;if(0>=this.workspace_.options.maxTrashcanContents){return}var b=new Blockly.Options({scrollbars:!0,parentWorkspace:this.workspace_,rtl:this.workspace_.RTL,oneBasedIndex:this.workspace_.options.oneBasedIndex,renderer:this.workspace_.options.renderer,rendererOverrides:this.workspace_.options.rendererOverrides});if(this.workspace_.horizontalLayout){b.toolboxPosition=this.workspace_.toolboxPosition==Blockly.TOOLBOX_AT_TOP?Blockly.TOOLBOX_AT_BOTTOM:Blockly.TOOLBOX_AT_TOP;if(!Blockly.HorizontalFlyout){throw Error("Missing require for Blockly.HorizontalFlyout")}this.flyout=new Blockly.HorizontalFlyout(b)}else{b.toolboxPosition=this.workspace_.toolboxPosition==Blockly.TOOLBOX_AT_RIGHT?Blockly.TOOLBOX_AT_LEFT:Blockly.TOOLBOX_AT_RIGHT;if(!Blockly.VerticalFlyout){throw Error("Missing require for Blockly.VerticalFlyout")}this.flyout=new Blockly.VerticalFlyout(b)}this.workspace_.addChangeListener(this.onDelete_.bind(this))};Blockly.Trashcan.prototype.WIDTH_=47;Blockly.Trashcan.prototype.BODY_HEIGHT_=44;Blockly.Trashcan.prototype.LID_HEIGHT_=16;Blockly.Trashcan.prototype.MARGIN_BOTTOM_=20;Blockly.Trashcan.prototype.MARGIN_SIDE_=20;Blockly.Trashcan.prototype.MARGIN_HOTSPOT_=10;Blockly.Trashcan.prototype.SPRITE_LEFT_=0;Blockly.Trashcan.prototype.SPRITE_TOP_=32;Blockly.Trashcan.prototype.HAS_BLOCKS_LID_ANGLE_=.1;Blockly.Trashcan.ANIMATION_LENGTH_=80;Blockly.Trashcan.ANIMATION_FRAMES_=4;Blockly.Trashcan.OPACITY_MIN_=.4;Blockly.Trashcan.OPACITY_MAX_=.8;Blockly.Trashcan.MAX_LID_ANGLE_=45;Blockly.Trashcan.prototype.isOpen=!1;Blockly.Trashcan.prototype.minOpenness_=0;Blockly.Trashcan.prototype.svgGroup_=null;Blockly.Trashcan.prototype.svgLid_=null;Blockly.Trashcan.prototype.lidTask_=0;Blockly.Trashcan.prototype.lidOpen_=0;Blockly.Trashcan.prototype.left_=0;Blockly.Trashcan.prototype.top_=0;Blockly.Trashcan.prototype.createDom=function(){this.svgGroup_=Blockly.utils.dom.createSvgElement("g",{class:"blocklyTrash"},null);var a,b=(Math.random()+"").substring(2);a=Blockly.utils.dom.createSvgElement("clipPath",{id:"blocklyTrashBodyClipPath"+b},this.svgGroup_);Blockly.utils.dom.createSvgElement("rect",{width:this.WIDTH_,height:this.BODY_HEIGHT_,y:this.LID_HEIGHT_},a);var c=Blockly.utils.dom.createSvgElement("image",{width:Blockly.SPRITE.width,x:-this.SPRITE_LEFT_,height:Blockly.SPRITE.height,y:-this.SPRITE_TOP_,"clip-path":"url(#blocklyTrashBodyClipPath"+b+")"},this.svgGroup_);c.setAttributeNS(Blockly.utils.dom.XLINK_NS,"xlink:href",this.workspace_.options.pathToMedia+Blockly.SPRITE.url);a=Blockly.utils.dom.createSvgElement("clipPath",{id:"blocklyTrashLidClipPath"+b},this.svgGroup_);Blockly.utils.dom.createSvgElement("rect",{width:this.WIDTH_,height:this.LID_HEIGHT_},a);this.svgLid_=Blockly.utils.dom.createSvgElement("image",{width:Blockly.SPRITE.width,x:-this.SPRITE_LEFT_,height:Blockly.SPRITE.height,y:-this.SPRITE_TOP_,"clip-path":"url(#blocklyTrashLidClipPath"+b+")"},this.svgGroup_);this.svgLid_.setAttributeNS(Blockly.utils.dom.XLINK_NS,"xlink:href",this.workspace_.options.pathToMedia+Blockly.SPRITE.url);Blockly.bindEventWithChecks_(this.svgGroup_,"mouseup",this,this.click);Blockly.bindEvent_(c,"mouseover",this,this.mouseOver_);Blockly.bindEvent_(c,"mouseout",this,this.mouseOut_);this.animateLid_();return this.svgGroup_};Blockly.Trashcan.prototype.init=function(a){if(0<this.workspace_.options.maxTrashcanContents){Blockly.utils.dom.insertAfter(this.flyout.createDom("svg"),this.workspace_.getParentSvg());this.flyout.init(this.workspace_)}this.verticalSpacing_=this.MARGIN_BOTTOM_+a;this.setOpen(!1);return this.verticalSpacing_+this.BODY_HEIGHT_+this.LID_HEIGHT_};Blockly.Trashcan.prototype.dispose=function(){if(this.svgGroup_){Blockly.utils.dom.removeNode(this.svgGroup_);this.svgGroup_=null}this.svgLid_=null;this.workspace_=null;clearTimeout(this.lidTask_)};Blockly.Trashcan.prototype.contentsIsOpen=function(){return this.flyout.isVisible()};Blockly.Trashcan.prototype.emptyContents=function(){if(!this.contents_.length){return}this.contents_.length=0;this.setMinOpenness_(0);if(this.contentsIsOpen()){this.flyout.hide()}};Blockly.Trashcan.prototype.position=function(){if(!this.verticalSpacing_){return}var a=this.workspace_.getMetrics();if(!a){return}if(a.toolboxPosition==Blockly.TOOLBOX_AT_LEFT||this.workspace_.horizontalLayout&&!this.workspace_.RTL){this.left_=a.viewWidth+a.absoluteLeft-this.WIDTH_-this.MARGIN_SIDE_-Blockly.Scrollbar.scrollbarThickness}else{this.left_=this.MARGIN_SIDE_+Blockly.Scrollbar.scrollbarThickness}if(a.toolboxPosition==Blockly.TOOLBOX_AT_BOTTOM){this.top_=this.verticalSpacing_}else{this.top_=a.viewHeight+a.absoluteTop-(this.BODY_HEIGHT_+this.LID_HEIGHT_)-this.verticalSpacing_}this.svgGroup_.setAttribute("transform","translate("+this.left_+","+this.top_+")")};Blockly.Trashcan.prototype.getClientRect=function(){if(!this.svgGroup_){return null}var a=this.svgGroup_.getBoundingClientRect(),b=a.top+this.SPRITE_TOP_-this.MARGIN_HOTSPOT_,c=b+this.LID_HEIGHT_+this.BODY_HEIGHT_+2*this.MARGIN_HOTSPOT_,d=a.left+this.SPRITE_LEFT_-this.MARGIN_HOTSPOT_,e=d+this.WIDTH_+2*this.MARGIN_HOTSPOT_;return new Blockly.utils.Rect(b,c,d,e)};Blockly.Trashcan.prototype.setOpen=function(a){if(this.isOpen==a){return}clearTimeout(this.lidTask_);this.isOpen=a;this.animateLid_()};Blockly.Trashcan.prototype.animateLid_=function(){var a=Blockly.Trashcan.ANIMATION_FRAMES_,b=1/(a+1);this.lidOpen_+=this.isOpen?b:-b;this.lidOpen_=Math.min(Math.max(this.lidOpen_,this.minOpenness_),1);this.setLidAngle_(this.lidOpen_*Blockly.Trashcan.MAX_LID_ANGLE_);var c=Blockly.Trashcan.OPACITY_MIN_,d=Blockly.Trashcan.OPACITY_MAX_,e=c+this.lidOpen_*(d-c);this.svgGroup_.style.opacity=e;if(this.lidOpen_>this.minOpenness_&&1>this.lidOpen_){this.lidTask_=setTimeout(this.animateLid_.bind(this),Blockly.Trashcan.ANIMATION_LENGTH_/a)}};Blockly.Trashcan.prototype.setLidAngle_=function(a){var b=this.workspace_.toolboxPosition==Blockly.TOOLBOX_AT_RIGHT||this.workspace_.horizontalLayout&&this.workspace_.RTL;this.svgLid_.setAttribute("transform","rotate("+(b?-a:a)+","+(b?4:this.WIDTH_-4)+","+(this.LID_HEIGHT_-2)+")")};Blockly.Trashcan.prototype.setMinOpenness_=function(a){this.minOpenness_=a;if(!this.isOpen){this.setLidAngle_(a*Blockly.Trashcan.MAX_LID_ANGLE_)}};Blockly.Trashcan.prototype.close=function(){this.setOpen(!1)};Blockly.Trashcan.prototype.click=function(){if(!this.contents_.length){return}for(var a=[],b=0,c;c=this.contents_[b];b++){a[b]=Blockly.Xml.textToDom(c)}this.flyout.show(a)};Blockly.Trashcan.prototype.mouseOver_=function(){if(this.contents_.length){this.setOpen(!0)}};Blockly.Trashcan.prototype.mouseOut_=function(){this.setOpen(!1)};Blockly.Trashcan.prototype.onDelete_=function(a){if(0>=this.workspace_.options.maxTrashcanContents){return}if(a.type==Blockly.Events.BLOCK_DELETE&&"shadow"!=a.oldXml.tagName.toLowerCase()){var b=this.cleanBlockXML_(a.oldXml);if(-1!=this.contents_.indexOf(b)){return}this.contents_.unshift(b);while(this.contents_.length>this.workspace_.options.maxTrashcanContents){this.contents_.pop()}this.setMinOpenness_(this.HAS_BLOCKS_LID_ANGLE_)}};Blockly.Trashcan.prototype.cleanBlockXML_=function(a){var b=a.cloneNode(!0),c=b;while(c){if(c.removeAttribute){c.removeAttribute("x");c.removeAttribute("y");c.removeAttribute("id");c.removeAttribute("disabled");if("comment"==c.nodeName){c.removeAttribute("h");c.removeAttribute("w");c.removeAttribute("pinned")}}var d=c.firstChild||c.nextSibling;if(!d){d=c.parentNode;while(d){if(d.nextSibling){d=d.nextSibling;break}d=d.parentNode}}c=d}return Blockly.Xml.domToText(b)};
//# sourceMappingURL=trashcan.min.js.map
