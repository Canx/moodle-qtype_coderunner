'use strict';goog.provide("Blockly.WorkspaceSvg");goog.require("Blockly.BlockSvg");goog.require("Blockly.blockRendering");goog.require("Blockly.ConnectionDB");goog.require("Blockly.constants");goog.require("Blockly.Events");goog.require("Blockly.Events.BlockCreate");goog.require("Blockly.Gesture");goog.require("Blockly.Grid");goog.require("Blockly.MarkerManager");goog.require("Blockly.Msg");goog.require("Blockly.navigation");goog.require("Blockly.Options");goog.require("Blockly.registry");goog.require("Blockly.ThemeManager");goog.require("Blockly.Themes.Classic");goog.require("Blockly.TouchGesture");goog.require("Blockly.utils");goog.require("Blockly.utils.Coordinate");goog.require("Blockly.utils.dom");goog.require("Blockly.utils.Metrics");goog.require("Blockly.utils.object");goog.require("Blockly.utils.Rect");goog.require("Blockly.utils.toolbox");goog.require("Blockly.Workspace");goog.require("Blockly.WorkspaceAudio");goog.require("Blockly.WorkspaceDragSurfaceSvg");goog.require("Blockly.Xml");goog.requireType("Blockly.blockRendering.Renderer");goog.requireType("Blockly.IASTNodeLocationSvg");goog.requireType("Blockly.IBoundedElement");Blockly.WorkspaceSvg=function(e,o,t){Blockly.WorkspaceSvg.superClass_.constructor.call(this,e);this.getMetrics=e.getMetrics||Blockly.WorkspaceSvg.getTopLevelWorkspaceMetrics_;this.setMetrics=e.setMetrics||Blockly.WorkspaceSvg.setTopLevelWorkspaceMetrics_;this.connectionDBList=Blockly.ConnectionDB.init();if(o){this.blockDragSurface_=o}if(t){this.workspaceDragSurface_=t}this.useWorkspaceDragSurface_=!!this.workspaceDragSurface_&&Blockly.utils.is3dSupported();this.highlightedBlocks_=[];this.audioManager_=new Blockly.WorkspaceAudio(e.parentWorkspace);this.grid_=this.options.gridPattern?new Blockly.Grid(this.options.gridPattern,e.gridOptions):null;this.markerManager_=new Blockly.MarkerManager(this);this.toolboxCategoryCallbacks_={};this.flyoutButtonCallbacks_={};if(Blockly.Variables&&Blockly.Variables.flyoutCategory){this.registerToolboxCategoryCallback(Blockly.VARIABLE_CATEGORY_NAME,Blockly.Variables.flyoutCategory)}if(Blockly.VariablesDynamic&&Blockly.VariablesDynamic.flyoutCategory){this.registerToolboxCategoryCallback(Blockly.VARIABLE_DYNAMIC_CATEGORY_NAME,Blockly.VariablesDynamic.flyoutCategory)}if(Blockly.Procedures&&Blockly.Procedures.flyoutCategory){this.registerToolboxCategoryCallback(Blockly.PROCEDURE_CATEGORY_NAME,Blockly.Procedures.flyoutCategory);this.addChangeListener(Blockly.Procedures.mutatorOpenListener)}this.themeManager_=this.options.parentWorkspace?this.options.parentWorkspace.getThemeManager():new Blockly.ThemeManager(this,this.options.theme||Blockly.Themes.Classic);this.themeManager_.subscribeWorkspace(this);this.renderer_=Blockly.blockRendering.init(this.options.renderer||"geras",this.getTheme(),this.options.rendererOverrides);this.cachedParentSvg_=null;this.keyboardAccessibilityMode=!1;this.topBoundedElements_=[]};Blockly.utils.object.inherits(Blockly.WorkspaceSvg,Blockly.Workspace);Blockly.WorkspaceSvg.prototype.resizeHandlerWrapper_=null;Blockly.WorkspaceSvg.prototype.rendered=!0;Blockly.WorkspaceSvg.prototype.isVisible_=!0;Blockly.WorkspaceSvg.prototype.isFlyout=!1;Blockly.WorkspaceSvg.prototype.isMutator=!1;Blockly.WorkspaceSvg.prototype.resizesEnabled_=!0;Blockly.WorkspaceSvg.prototype.scrollX=0;Blockly.WorkspaceSvg.prototype.scrollY=0;Blockly.WorkspaceSvg.prototype.startScrollX=0;Blockly.WorkspaceSvg.prototype.startScrollY=0;Blockly.WorkspaceSvg.prototype.dragDeltaXY_=null;Blockly.WorkspaceSvg.prototype.scale=1;Blockly.WorkspaceSvg.prototype.trashcan=null;Blockly.WorkspaceSvg.prototype.scrollbar=null;Blockly.WorkspaceSvg.prototype.flyout_=null;Blockly.WorkspaceSvg.prototype.toolbox_=null;Blockly.WorkspaceSvg.prototype.currentGesture_=null;Blockly.WorkspaceSvg.prototype.blockDragSurface_=null;Blockly.WorkspaceSvg.prototype.workspaceDragSurface_=null;Blockly.WorkspaceSvg.prototype.useWorkspaceDragSurface_=!1;Blockly.WorkspaceSvg.prototype.isDragSurfaceActive_=!1;Blockly.WorkspaceSvg.prototype.injectionDiv_=null;Blockly.WorkspaceSvg.prototype.lastRecordedPageScroll_=null;Blockly.WorkspaceSvg.prototype.configureContextMenu;Blockly.WorkspaceSvg.prototype.targetWorkspace=null;Blockly.WorkspaceSvg.prototype.inverseScreenCTM_=null;Blockly.WorkspaceSvg.prototype.inverseScreenCTMDirty_=!0;Blockly.WorkspaceSvg.prototype.getMarkerManager=function(){return this.markerManager_};Blockly.WorkspaceSvg.prototype.setCursorSvg=function(e){this.markerManager_.setCursorSvg(e)};Blockly.WorkspaceSvg.prototype.setMarkerSvg=function(e){this.markerManager_.setMarkerSvg(e)};Blockly.WorkspaceSvg.prototype.getMarker=function(e){if(this.markerManager_){return this.markerManager_.getMarker(e)}return null};Blockly.WorkspaceSvg.prototype.getCursor=function(){if(this.markerManager_){return this.markerManager_.getCursor()}return null};Blockly.WorkspaceSvg.prototype.getRenderer=function(){return this.renderer_};Blockly.WorkspaceSvg.prototype.getThemeManager=function(){return this.themeManager_};Blockly.WorkspaceSvg.prototype.getTheme=function(){return this.themeManager_.getTheme()};Blockly.WorkspaceSvg.prototype.setTheme=function(e){if(!e){e=Blockly.Themes.Classic}this.themeManager_.setTheme(e)};Blockly.WorkspaceSvg.prototype.refreshTheme=function(){if(this.svgGroup_){this.renderer_.refreshDom(this.svgGroup_,this.getTheme())}this.updateBlockStyles_(this.getAllBlocks(!1).filter(function(e){return e.getStyleName()!==void 0}));this.refreshToolboxSelection();if(this.toolbox_){this.toolbox_.refreshTheme()}if(this.isVisible()){this.setVisible(!0)}var e=new Blockly.Events.Ui(null,"theme",null,null);e.workspaceId=this.id;Blockly.Events.fire(e)};Blockly.WorkspaceSvg.prototype.updateBlockStyles_=function(e){for(var o=0,t,r;t=e[o];o++){r=t.getStyleName();if(r){t.setStyle(r);if(t.mutator){t.mutator.updateBlockStyle()}}}};Blockly.WorkspaceSvg.prototype.getInverseScreenCTM=function(){if(this.inverseScreenCTMDirty_){var e=this.getParentSvg().getScreenCTM();if(e){this.inverseScreenCTM_=e.inverse();this.inverseScreenCTMDirty_=!1}}return this.inverseScreenCTM_};Blockly.WorkspaceSvg.prototype.updateInverseScreenCTM=function(){this.inverseScreenCTMDirty_=!0};Blockly.WorkspaceSvg.prototype.isVisible=function(){return this.isVisible_};Blockly.WorkspaceSvg.prototype.getSvgXY=function(e){var o=0,t=0,r=1;if(Blockly.utils.dom.containsNode(this.getCanvas(),e)||Blockly.utils.dom.containsNode(this.getBubbleCanvas(),e)){r=this.scale}do{var s=Blockly.utils.getRelativeXY(e);if(e==this.getCanvas()||e==this.getBubbleCanvas()){r=1}o+=s.x*r;t+=s.y*r;e=e.parentNode}while(e&&e!=this.getParentSvg());return new Blockly.utils.Coordinate(o,t)};Blockly.WorkspaceSvg.prototype.getOriginOffsetInPixels=function(){return Blockly.utils.getInjectionDivXY_(this.getCanvas())};Blockly.WorkspaceSvg.prototype.getInjectionDiv=function(){if(!this.injectionDiv_){var e=this.svgGroup_;while(e){var o=e.getAttribute("class")||"";if(-1!=(" "+o+" ").indexOf(" injectionDiv ")){this.injectionDiv_=e;break}e=e.parentNode}}return this.injectionDiv_};Blockly.WorkspaceSvg.prototype.getBlockCanvas=function(){return this.svgBlockCanvas_};Blockly.WorkspaceSvg.prototype.setResizeHandlerWrapper=function(e){this.resizeHandlerWrapper_=e};Blockly.WorkspaceSvg.prototype.createDom=function(e){this.svgGroup_=Blockly.utils.dom.createSvgElement("g",{class:"blocklyWorkspace"},null);if(e){this.svgBackground_=Blockly.utils.dom.createSvgElement("rect",{height:"100%",width:"100%",class:e},this.svgGroup_);if("blocklyMainBackground"==e&&this.grid_){this.svgBackground_.style.fill="url(#"+this.grid_.getPatternId()+")"}else{this.themeManager_.subscribe(this.svgBackground_,"workspaceBackgroundColour","fill")}}this.svgBlockCanvas_=Blockly.utils.dom.createSvgElement("g",{class:"blocklyBlockCanvas"},this.svgGroup_);this.svgBubbleCanvas_=Blockly.utils.dom.createSvgElement("g",{class:"blocklyBubbleCanvas"},this.svgGroup_);if(!this.isFlyout){Blockly.bindEventWithChecks_(this.svgGroup_,"mousedown",this,this.onMouseDown_,!1,!0);Blockly.bindEventWithChecks_(this.svgGroup_,"wheel",this,this.onMouseWheel_)}if(this.options.hasCategories){if(!Blockly.Toolbox){throw Error("Missing require for Blockly.Toolbox")}var o=Blockly.registry.getClassFromOptions(Blockly.registry.Type.TOOLBOX,this.options);this.toolbox_=new o(this)}if(this.grid_){this.grid_.update(this.scale)}this.recordDeleteAreas();this.markerManager_.setCursor(new Blockly.Cursor);this.markerManager_.registerMarker(Blockly.navigation.MARKER_NAME,new Blockly.Marker);this.renderer_.createDom(this.svgGroup_,this.getTheme());return this.svgGroup_};Blockly.WorkspaceSvg.prototype.dispose=function(){this.rendered=!1;if(this.currentGesture_){this.currentGesture_.cancel()}if(this.svgGroup_){Blockly.utils.dom.removeNode(this.svgGroup_);this.svgGroup_=null}this.svgBlockCanvas_=null;this.svgBubbleCanvas_=null;if(this.toolbox_){this.toolbox_.dispose();this.toolbox_=null}if(this.flyout_){this.flyout_.dispose();this.flyout_=null}if(this.trashcan){this.trashcan.dispose();this.trashcan=null}if(this.scrollbar){this.scrollbar.dispose();this.scrollbar=null}if(this.zoomControls_){this.zoomControls_.dispose();this.zoomControls_=null}if(this.audioManager_){this.audioManager_.dispose();this.audioManager_=null}if(this.grid_){this.grid_.dispose();this.grid_=null}this.renderer_.dispose();if(this.markerManager_){this.markerManager_.dispose();this.markerManager_=null}Blockly.WorkspaceSvg.superClass_.dispose.call(this);if(this.themeManager_){this.themeManager_.unsubscribeWorkspace(this);this.themeManager_.unsubscribe(this.svgBackground_);if(!this.options.parentWorkspace){this.themeManager_.dispose();this.themeManager_=null}}this.connectionDBList=null;this.toolboxCategoryCallbacks_=null;this.flyoutButtonCallbacks_=null;if(!this.options.parentWorkspace){var e=this.getParentSvg().parentNode;if(e){Blockly.utils.dom.removeNode(e)}}if(this.resizeHandlerWrapper_){Blockly.unbindEvent_(this.resizeHandlerWrapper_);this.resizeHandlerWrapper_=null}};Blockly.WorkspaceSvg.prototype.newBlock=function(e,o){return new Blockly.BlockSvg(this,e,o)};Blockly.WorkspaceSvg.prototype.addTrashcan=function(){if(!Blockly.Trashcan){throw Error("Missing require for Blockly.Trashcan")}this.trashcan=new Blockly.Trashcan(this);var e=this.trashcan.createDom();this.svgGroup_.insertBefore(e,this.svgBlockCanvas_)};Blockly.WorkspaceSvg.prototype.addZoomControls=function(){if(!Blockly.ZoomControls){throw Error("Missing require for Blockly.ZoomControls")}this.zoomControls_=new Blockly.ZoomControls(this);var e=this.zoomControls_.createDom();this.svgGroup_.appendChild(e)};Blockly.WorkspaceSvg.prototype.addFlyout=function(e){var o=new Blockly.Options({parentWorkspace:this,rtl:this.RTL,oneBasedIndex:this.options.oneBasedIndex,horizontalLayout:this.horizontalLayout,renderer:this.options.renderer,rendererOverrides:this.options.rendererOverrides});o.toolboxPosition=this.options.toolboxPosition;if(this.horizontalLayout){if(!Blockly.HorizontalFlyout){throw Error("Missing require for Blockly.HorizontalFlyout")}this.flyout_=new Blockly.HorizontalFlyout(o)}else{if(!Blockly.VerticalFlyout){throw Error("Missing require for Blockly.VerticalFlyout")}this.flyout_=new Blockly.VerticalFlyout(o)}this.flyout_.autoClose=!1;this.flyout_.getWorkspace().setVisible(!0);return this.flyout_.createDom(e)};Blockly.WorkspaceSvg.prototype.getFlyout=function(e){if(this.flyout_||e){return this.flyout_}if(this.toolbox_){return this.toolbox_.getFlyout()}return null};Blockly.WorkspaceSvg.prototype.getToolbox=function(){return this.toolbox_};Blockly.WorkspaceSvg.prototype.updateScreenCalculations_=function(){this.updateInverseScreenCTM();this.recordDeleteAreas()};Blockly.WorkspaceSvg.prototype.resizeContents=function(){if(!this.resizesEnabled_||!this.rendered){return}if(this.scrollbar){this.scrollbar.resize()}this.updateInverseScreenCTM()};Blockly.WorkspaceSvg.prototype.resize=function(){if(this.toolbox_){this.toolbox_.position()}if(this.flyout_){this.flyout_.position()}if(this.trashcan){this.trashcan.position()}if(this.zoomControls_){this.zoomControls_.position()}if(this.scrollbar){this.scrollbar.resize()}this.updateScreenCalculations_()};Blockly.WorkspaceSvg.prototype.updateScreenCalculationsIfScrolled=function(){var e=Blockly.utils.getDocumentScroll();if(!Blockly.utils.Coordinate.equals(this.lastRecordedPageScroll_,e)){this.lastRecordedPageScroll_=e;this.updateScreenCalculations_()}};Blockly.WorkspaceSvg.prototype.getCanvas=function(){return this.svgBlockCanvas_};Blockly.WorkspaceSvg.prototype.getBubbleCanvas=function(){return this.svgBubbleCanvas_};Blockly.WorkspaceSvg.prototype.getParentSvg=function(){if(!this.cachedParentSvg_){var e=this.svgGroup_;while(e){if("svg"==e.tagName){this.cachedParentSvg_=e;break}e=e.parentNode}}return this.cachedParentSvg_};Blockly.WorkspaceSvg.prototype.translate=function(e,o){if(this.useWorkspaceDragSurface_&&this.isDragSurfaceActive_){this.workspaceDragSurface_.translateSurface(e,o)}else{var t="translate("+e+","+o+") scale("+this.scale+")";this.svgBlockCanvas_.setAttribute("transform",t);this.svgBubbleCanvas_.setAttribute("transform",t)}if(this.blockDragSurface_){this.blockDragSurface_.translateAndScaleGroup(e,o,this.scale)}if(this.grid_){this.grid_.moveTo(e,o)}};Blockly.WorkspaceSvg.prototype.resetDragSurface=function(){if(!this.useWorkspaceDragSurface_){return}this.isDragSurfaceActive_=!1;var e=this.workspaceDragSurface_.getSurfaceTranslation();this.workspaceDragSurface_.clearAndHide(this.svgGroup_);var o="translate("+e.x+","+e.y+") scale("+this.scale+")";this.svgBlockCanvas_.setAttribute("transform",o);this.svgBubbleCanvas_.setAttribute("transform",o)};Blockly.WorkspaceSvg.prototype.setupDragSurface=function(){if(!this.useWorkspaceDragSurface_){return}if(this.isDragSurfaceActive_){return}this.isDragSurfaceActive_=!0;var e=this.svgBlockCanvas_.previousSibling,o=parseInt(this.getParentSvg().getAttribute("width"),10),t=parseInt(this.getParentSvg().getAttribute("height"),10),r=Blockly.utils.getRelativeXY(this.getCanvas());this.workspaceDragSurface_.setContentsAndShow(this.getCanvas(),this.getBubbleCanvas(),e,o,t,this.scale);this.workspaceDragSurface_.translateSurface(r.x,r.y)};Blockly.WorkspaceSvg.prototype.getBlockDragSurface=function(){return this.blockDragSurface_};Blockly.WorkspaceSvg.prototype.getWidth=function(){var e=this.getMetrics();return e?e.viewWidth/this.scale:0};Blockly.WorkspaceSvg.prototype.setVisible=function(e){this.isVisible_=e;if(!this.svgGroup_){return}if(this.scrollbar){this.scrollbar.setContainerVisible(e)}if(this.getFlyout()){this.getFlyout().setContainerVisible(e)}this.getParentSvg().style.display=e?"block":"none";if(this.toolbox_){this.toolbox_.setVisible(e)}if(e){for(var o=this.getAllBlocks(!1),t=o.length-1;0<=t;t--){o[t].markDirty()}this.render();if(this.toolbox_){this.toolbox_.position()}}else{Blockly.hideChaff(!0)}};Blockly.WorkspaceSvg.prototype.render=function(){for(var e=this.getAllBlocks(!1),o=e.length-1;0<=o;o--){e[o].render(!1)}if(this.currentGesture_){for(var t=this.currentGesture_.getInsertionMarkers(),o=0;o<t.length;o++){t[o].render(!1)}}this.markerManager_.updateMarkers()};Blockly.WorkspaceSvg.prototype.traceOn=function(){console.warn("Deprecated call to traceOn, delete this.")};Blockly.WorkspaceSvg.prototype.highlightBlock=function(e,o){if(o===void 0){for(var t=0,r;r=this.highlightedBlocks_[t];t++){r.setHighlighted(!1)}this.highlightedBlocks_.length=0}var r=e?this.getBlockById(e):null;if(r){var s=o===void 0||o;if(!s){Blockly.utils.arrayRemove(this.highlightedBlocks_,r)}else if(-1==this.highlightedBlocks_.indexOf(r)){this.highlightedBlocks_.push(r)}r.setHighlighted(s)}};Blockly.WorkspaceSvg.prototype.paste=function(e){if(!this.rendered||e.getElementsByTagName("block").length>=this.remainingCapacity()){return}if(this.currentGesture_){this.currentGesture_.cancel()}if("comment"==e.tagName.toLowerCase()){this.pasteWorkspaceComment_(e)}else{this.pasteBlock_(e)}};Blockly.WorkspaceSvg.prototype.pasteBlock_=function(e){Blockly.Events.disable();try{var o=Blockly.Xml.domToBlock(e,this),t=this.getMarker(Blockly.navigation.MARKER_NAME).getCurNode();if(this.keyboardAccessibilityMode&&t&&t.isConnection()){var r=t.getLocation();Blockly.navigation.insertBlock(o,r);return}var s=parseInt(e.getAttribute("x"),10),a=parseInt(e.getAttribute("y"),10);if(!isNaN(s)&&!isNaN(a)){if(this.RTL){s=-s}do{for(var n=!1,l=this.getAllBlocks(!1),c=0,p,g;p=l[c];c++){g=p.getRelativeToSurfaceXY();if(1>=Math.abs(s-g.x)&&1>=Math.abs(a-g.y)){n=!0;break}}if(!n){for(var u=o.getConnections_(!1),c=0,d,v;d=u[c];c++){v=d.closest(Blockly.SNAP_RADIUS,new Blockly.utils.Coordinate(s,a));if(v.connection){n=!0;break}}}if(n){if(this.RTL){s-=Blockly.SNAP_RADIUS}else{s+=Blockly.SNAP_RADIUS}a+=2*Blockly.SNAP_RADIUS}}while(n);o.moveBy(s,a)}}finally{Blockly.Events.enable()}if(Blockly.Events.isEnabled()&&!o.isShadow()){Blockly.Events.fire(new Blockly.Events.BlockCreate(o))}o.select()};Blockly.WorkspaceSvg.prototype.pasteWorkspaceComment_=function(e){Blockly.Events.disable();try{var o=Blockly.WorkspaceCommentSvg.fromXml(e,this),t=parseInt(e.getAttribute("x"),10),r=parseInt(e.getAttribute("y"),10);if(!isNaN(t)&&!isNaN(r)){if(this.RTL){t=-t}t+=50;r+=50;o.moveBy(t,r)}}finally{Blockly.Events.enable()}if(Blockly.Events.isEnabled()){}o.select()};Blockly.WorkspaceSvg.prototype.refreshToolboxSelection=function(){var e=this.isFlyout?this.targetWorkspace:this;if(e&&!e.currentGesture_&&e.toolbox_&&e.toolbox_.getFlyout()){e.toolbox_.refreshSelection()}};Blockly.WorkspaceSvg.prototype.renameVariableById=function(e,o){Blockly.WorkspaceSvg.superClass_.renameVariableById.call(this,e,o);this.refreshToolboxSelection()};Blockly.WorkspaceSvg.prototype.deleteVariableById=function(e){Blockly.WorkspaceSvg.superClass_.deleteVariableById.call(this,e);this.refreshToolboxSelection()};Blockly.WorkspaceSvg.prototype.createVariable=function(e,o,t){var r=Blockly.WorkspaceSvg.superClass_.createVariable.call(this,e,o,t);this.refreshToolboxSelection();return r};Blockly.WorkspaceSvg.prototype.recordDeleteAreas=function(){if(this.trashcan&&this.svgGroup_.parentNode){this.deleteAreaTrash_=this.trashcan.getClientRect()}else{this.deleteAreaTrash_=null}if(this.flyout_){this.deleteAreaToolbox_=this.flyout_.getClientRect()}else if(this.toolbox_&&"function"==typeof this.toolbox_.getClientRect){this.deleteAreaToolbox_=this.toolbox_.getClientRect()}else{this.deleteAreaToolbox_=null}};Blockly.WorkspaceSvg.prototype.isDeleteArea=function(o){if(this.deleteAreaTrash_&&this.deleteAreaTrash_.contains(o.clientX,o.clientY)){return Blockly.DELETE_AREA_TRASH}if(this.deleteAreaToolbox_&&this.deleteAreaToolbox_.contains(o.clientX,o.clientY)){return Blockly.DELETE_AREA_TOOLBOX}return Blockly.DELETE_AREA_NONE};Blockly.WorkspaceSvg.prototype.onMouseDown_=function(o){var e=this.getGesture(o);if(e){e.handleWsStart(o,this)}};Blockly.WorkspaceSvg.prototype.startDrag=function(o,e){var t=Blockly.utils.mouseToSvg(o,this.getParentSvg(),this.getInverseScreenCTM());t.x/=this.scale;t.y/=this.scale;this.dragDeltaXY_=Blockly.utils.Coordinate.difference(e,t)};Blockly.WorkspaceSvg.prototype.moveDrag=function(o){var e=Blockly.utils.mouseToSvg(o,this.getParentSvg(),this.getInverseScreenCTM());e.x/=this.scale;e.y/=this.scale;return Blockly.utils.Coordinate.sum(this.dragDeltaXY_,e)};Blockly.WorkspaceSvg.prototype.isDragging=function(){return null!=this.currentGesture_&&this.currentGesture_.isDragging()};Blockly.WorkspaceSvg.prototype.isDraggable=function(){return this.options.moveOptions&&this.options.moveOptions.drag};Blockly.WorkspaceSvg.prototype.isContentBounded=function(){return this.options.moveOptions&&this.options.moveOptions.scrollbars||this.options.moveOptions&&this.options.moveOptions.wheel||this.options.moveOptions&&this.options.moveOptions.drag||this.options.zoomOptions&&this.options.zoomOptions.controls||this.options.zoomOptions&&this.options.zoomOptions.wheel||this.options.zoomOptions&&this.options.zoomOptions.pinch};Blockly.WorkspaceSvg.prototype.isMovable=function(){return this.options.moveOptions&&this.options.moveOptions.scrollbars||this.options.moveOptions&&this.options.moveOptions.wheel||this.options.moveOptions&&this.options.moveOptions.drag||this.options.zoomOptions&&this.options.zoomOptions.wheel||this.options.zoomOptions&&this.options.zoomOptions.pinch};Blockly.WorkspaceSvg.prototype.onMouseWheel_=function(o){if(Blockly.Gesture.inProgress()){o.preventDefault();o.stopPropagation();return}var e=this.options.zoomOptions&&this.options.zoomOptions.wheel,t=this.options.moveOptions&&this.options.moveOptions.wheel;if(!e&&!t){return}var r=Blockly.utils.getScrollDeltaPixels(o);if(e&&(o.ctrlKey||!t)){var s=-r.y/50,a=Blockly.utils.mouseToSvg(o,this.getParentSvg(),this.getInverseScreenCTM());this.zoom(a.x,a.y,s)}else{var n=this.scrollX-r.x,l=this.scrollY-r.y;if(o.shiftKey&&!r.x){n=this.scrollX-r.y;l=this.scrollY}this.scroll(n,l)}o.preventDefault()};Blockly.WorkspaceSvg.prototype.getBlocksBoundingBox=function(){var e=this.getTopBoundedElements();if(!e.length){return new Blockly.utils.Rect(0,0,0,0)}for(var o=e[0].getBoundingRectangle(),t=1,r;t<e.length;t++){r=e[t].getBoundingRectangle();if(r.top<o.top){o.top=r.top}if(r.bottom>o.bottom){o.bottom=r.bottom}if(r.left<o.left){o.left=r.left}if(r.right>o.right){o.right=r.right}}return o};Blockly.WorkspaceSvg.prototype.cleanUp=function(){this.setResizesEnabled(!1);Blockly.Events.setGroup(!0);for(var e=this.getTopBlocks(!0),o=0,t=0,r;r=e[t];t++){if(!r.isMovable()){continue}var s=r.getRelativeToSurfaceXY();r.moveBy(-s.x,o-s.y);r.snapToGrid();o=r.getRelativeToSurfaceXY().y+r.getHeightWidth().height+this.renderer_.getConstants().MIN_BLOCK_HEIGHT}Blockly.Events.setGroup(!1);this.setResizesEnabled(!0)};Blockly.WorkspaceSvg.prototype.showContextMenu=function(o){if(this.options.readOnly||this.isFlyout){return}var r=[],s=this.getTopBlocks(!0),a=Blockly.utils.genUid(),n=this,l={};l.text=Blockly.Msg.UNDO;l.enabled=0<this.undoStack_.length;l.callback=this.undo.bind(this,!1);r.push(l);var c={text:Blockly.Msg.REDO,enabled:0<this.redoStack_.length,callback:this.undo.bind(this,!0)};r.push(c);if(this.isMovable()){var p={text:Blockly.Msg.CLEAN_UP,enabled:1<s.length,callback:this.cleanUp.bind(this)};r.push(p)}if(this.options.collapse){for(var g=!1,u=!1,d=0,v;d<s.length;d++){v=s[d];while(v){if(v.isCollapsed()){g=!0}else{u=!0}v=v.getNextBlock()}}var k=function(e){for(var o=0,t=0,r;t<s.length;t++){r=s[t];while(r){setTimeout(r.setCollapsed.bind(r,e),o);r=r.getNextBlock();o+=10}}},_={enabled:u};_.text=Blockly.Msg.COLLAPSE_ALL;_.callback=function(){k(!0)};r.push(_);var y={enabled:g,text:Blockly.Msg.EXPAND_ALL,callback:function(){k(!1)}};r.push(y)}var S=[];function e(o){if(o.isDeletable()){S=S.concat(o.getDescendants(!1))}else{for(var t=o.getChildren(!1),r=0;r<t.length;r++){e(t[r])}}}for(var d=0;d<s.length;d++){e(s[d])}function t(){Blockly.Events.setGroup(a);var e=S.shift();if(e){if(e.workspace){e.dispose(!1,!0);setTimeout(t,10)}else{t()}}Blockly.Events.setGroup(!1)}var b={text:1==S.length?Blockly.Msg.DELETE_BLOCK:Blockly.Msg.DELETE_X_BLOCKS.replace("%1",S.length+""),enabled:0<S.length,callback:function callback(){if(n.currentGesture_){n.currentGesture_.cancel()}if(2>S.length){t()}else{Blockly.confirm(Blockly.Msg.DELETE_ALL_BLOCKS.replace("%1",S.length),function(e){if(e){t()}})}}};r.push(b);if(this.configureContextMenu){this.configureContextMenu(r,o)}Blockly.ContextMenu.show(o,r,this.RTL)};Blockly.WorkspaceSvg.prototype.updateToolbox=function(e){if(!Array.isArray(e)){e=Blockly.Options.parseToolboxTree(e)}e=Blockly.utils.toolbox.convertToolboxToJSON(e);if(!e){if(this.options.languageTree){throw Error("Can't nullify an existing toolbox.")}return}if(!this.options.languageTree){throw Error("Existing toolbox is null.  Can't create new toolbox.")}if(Blockly.utils.toolbox.hasCategories(e)){if(!this.toolbox_){throw Error("Existing toolbox has no categories.  Can't change mode.")}this.options.languageTree=e;this.toolbox_.render(e)}else{if(!this.flyout_){throw Error("Existing toolbox has categories.  Can't change mode.")}this.options.languageTree=e;this.flyout_.show(e)}};Blockly.WorkspaceSvg.prototype.markFocused=function(){if(this.options.parentWorkspace){this.options.parentWorkspace.markFocused()}else{Blockly.mainWorkspace=this;this.setBrowserFocus()}};Blockly.WorkspaceSvg.prototype.setBrowserFocus=function(){if(document.activeElement){document.activeElement.blur()}try{this.getParentSvg().focus({preventScroll:!0})}catch(o){try{this.getParentSvg().parentNode.setActive()}catch(o){this.getParentSvg().parentNode.focus({preventScroll:!0})}}};Blockly.WorkspaceSvg.prototype.zoom=function(e,o,t){var r=this.options.zoomOptions.scaleSpeed,s=Math.pow(r,t),a=this.scale*s;if(this.scale==a){return}if(a>this.options.zoomOptions.maxScale){s=this.options.zoomOptions.maxScale/this.scale}else if(a<this.options.zoomOptions.minScale){s=this.options.zoomOptions.minScale/this.scale}var n=this.getCanvas().getCTM(),l=this.getParentSvg().createSVGPoint();l.x=e;l.y=o;l=l.matrixTransform(n.inverse());e=l.x;o=l.y;n=n.translate(e*(1-s),o*(1-s)).scale(s);this.scrollX=n.e;this.scrollY=n.f;this.setScale(a)};Blockly.WorkspaceSvg.prototype.zoomCenter=function(e){var o=this.getMetrics();if(this.flyout_){var t=o.svgWidth?o.svgWidth/2:0,r=o.svgHeight?o.svgHeight/2:0}else{var t=o.viewWidth/2+o.absoluteLeft,r=o.viewHeight/2+o.absoluteTop}this.zoom(t,r,e)};Blockly.WorkspaceSvg.prototype.zoomToFit=function(){if(!this.isMovable()){console.warn("Tried to move a non-movable workspace. This could result in blocks becoming inaccessible.");return}var e=this.getMetrics(),o=e.viewWidth,t=e.viewHeight,r=this.getBlocksBoundingBox(),s=r.right-r.left,a=r.bottom-r.top;if(!s){return}if(this.flyout_){if(this.horizontalLayout){t+=this.flyout_.getHeight();a+=this.flyout_.getHeight()/this.scale}else{o+=this.flyout_.getWidth();s+=this.flyout_.getWidth()/this.scale}}var n=o/s,l=t/a;this.setScale(Math.min(n,l));this.scrollCenter()};Blockly.WorkspaceSvg.prototype.beginCanvasTransition=function(){Blockly.utils.dom.addClass(this.svgBlockCanvas_,"blocklyCanvasTransitioning");Blockly.utils.dom.addClass(this.svgBubbleCanvas_,"blocklyCanvasTransitioning")};Blockly.WorkspaceSvg.prototype.endCanvasTransition=function(){Blockly.utils.dom.removeClass(this.svgBlockCanvas_,"blocklyCanvasTransitioning");Blockly.utils.dom.removeClass(this.svgBubbleCanvas_,"blocklyCanvasTransitioning")};Blockly.WorkspaceSvg.prototype.scrollCenter=function(){if(!this.isMovable()){console.warn("Tried to move a non-movable workspace. This could result in blocks becoming inaccessible.");return}var e=this.getMetrics(),o=(e.contentWidth-e.viewWidth)/2,t=(e.contentHeight-e.viewHeight)/2;o=-o-e.contentLeft;t=-t-e.contentTop;this.scroll(o,t)};Blockly.WorkspaceSvg.prototype.centerOnBlock=function(e){if(!this.isMovable()){console.warn("Tried to move a non-movable workspace. This could result in blocks becoming inaccessible.");return}var o=e?this.getBlockById(e):null;if(!o){return}var t=o.getRelativeToSurfaceXY(),r=o.getHeightWidth(),s=t.y+r.height/2,a=this.RTL?-1:1,n=t.x+a*r.width/2,l=this.scale,i=this.getMetrics(),c=i.viewWidth/2,p=i.viewHeight/2;this.scroll(-(n*l-c),-(s*l-p))};Blockly.WorkspaceSvg.prototype.setScale=function(e){if(this.options.zoomOptions.maxScale&&e>this.options.zoomOptions.maxScale){e=this.options.zoomOptions.maxScale}else if(this.options.zoomOptions.minScale&&e<this.options.zoomOptions.minScale){e=this.options.zoomOptions.minScale}this.scale=e;Blockly.hideChaff(!1);if(this.flyout_){this.flyout_.reflow();this.recordDeleteAreas()}if(this.grid_){this.grid_.update(this.scale)}var o=this.getMetrics();this.scrollX-=o.absoluteLeft;this.scrollY-=o.absoluteTop;o.viewLeft+=o.absoluteLeft;o.viewTop+=o.absoluteTop;this.scroll(this.scrollX,this.scrollY);if(this.scrollbar){if(this.flyout_){this.scrollbar.hScroll.resizeViewHorizontal(o);this.scrollbar.vScroll.resizeViewVertical(o)}else{this.scrollbar.hScroll.resizeContentHorizontal(o);this.scrollbar.vScroll.resizeContentVertical(o)}}};Blockly.WorkspaceSvg.prototype.getScale=function(){if(this.options.parentWorkspace){return this.options.parentWorkspace.getScale()}return this.scale};Blockly.WorkspaceSvg.prototype.scroll=function(e,o){Blockly.hideChaff(!0);var t=this.getMetrics(),r=t.contentWidth+t.contentLeft-t.viewWidth,s=t.contentHeight+t.contentTop-t.viewHeight;e=Math.min(e,-t.contentLeft);o=Math.min(o,-t.contentTop);e=Math.max(e,-r);o=Math.max(o,-s);this.scrollX=e;this.scrollY=o;if(this.scrollbar){this.scrollbar.hScroll.setHandlePosition(-(e+t.contentLeft)*this.scrollbar.hScroll.ratio);this.scrollbar.vScroll.setHandlePosition(-(o+t.contentTop)*this.scrollbar.vScroll.ratio)}e+=t.absoluteLeft;o+=t.absoluteTop;this.translate(e,o)};Blockly.WorkspaceSvg.getDimensionsPx_=function(e){var o=0,t=0;if(e){o=e.getWidth();t=e.getHeight()}return new Blockly.utils.Size(o,t)};Blockly.WorkspaceSvg.getContentDimensions_=function(e,o){if(e.isContentBounded()){return Blockly.WorkspaceSvg.getContentDimensionsBounded_(e,o)}else{return Blockly.WorkspaceSvg.getContentDimensionsExact_(e)}};Blockly.WorkspaceSvg.getContentDimensionsExact_=function(e){var o=e.getBlocksBoundingBox(),t=e.scale,r=o.top*t,s=o.bottom*t,a=o.left*t,n=o.right*t;return{top:r,bottom:s,left:a,right:n,width:n-a,height:s-r}};Blockly.WorkspaceSvg.getContentDimensionsBounded_=function(e,o){var t=Blockly.WorkspaceSvg.getContentDimensionsExact_(e),r=o.width,s=o.height,a=r/2,n=s/2,l=Math.min(t.left-a,t.right-r),i=Math.max(t.right+a,t.left+r),c=Math.min(t.top-n,t.bottom-s),p=Math.max(t.bottom+n,t.top+s);return{left:l,top:c,height:p-c,width:i-l}};Blockly.WorkspaceSvg.getTopLevelWorkspaceMetrics_=function(){var e=Blockly.WorkspaceSvg.getDimensionsPx_(this.toolbox_),o=Blockly.WorkspaceSvg.getDimensionsPx_(this.flyout_),t=Blockly.svgSize(this.getParentSvg()),r={height:t.height,width:t.width};if(this.toolbox_){if(this.toolboxPosition==Blockly.TOOLBOX_AT_TOP||this.toolboxPosition==Blockly.TOOLBOX_AT_BOTTOM){r.height-=e.height}else if(this.toolboxPosition==Blockly.TOOLBOX_AT_LEFT||this.toolboxPosition==Blockly.TOOLBOX_AT_RIGHT){r.width-=e.width}}else if(this.flyout_){if(this.toolboxPosition==Blockly.TOOLBOX_AT_TOP||this.toolboxPosition==Blockly.TOOLBOX_AT_BOTTOM){r.height-=o.height}else if(this.toolboxPosition==Blockly.TOOLBOX_AT_LEFT||this.toolboxPosition==Blockly.TOOLBOX_AT_RIGHT){r.width-=o.width}}var s=Blockly.WorkspaceSvg.getContentDimensions_(this,r),a=0;if(this.toolbox_&&this.toolboxPosition==Blockly.TOOLBOX_AT_LEFT){a=e.width}else if(this.flyout_&&this.toolboxPosition==Blockly.TOOLBOX_AT_LEFT){a=o.width}var n=0;if(this.toolbox_&&this.toolboxPosition==Blockly.TOOLBOX_AT_TOP){n=e.height}else if(this.flyout_&&this.toolboxPosition==Blockly.TOOLBOX_AT_TOP){n=o.height}var l={contentHeight:s.height,contentWidth:s.width,contentTop:s.top,contentLeft:s.left,viewHeight:r.height,viewWidth:r.width,viewTop:-this.scrollY,viewLeft:-this.scrollX,absoluteTop:n,absoluteLeft:a,svgHeight:t.height,svgWidth:t.width,toolboxWidth:e.width,toolboxHeight:e.height,toolboxPosition:this.toolboxPosition,flyoutWidth:o.width,flyoutHeight:o.height};return l};Blockly.WorkspaceSvg.setTopLevelWorkspaceMetrics_=function(e){var o=this.getMetrics();if("number"==typeof e.x){this.scrollX=-o.contentWidth*e.x-o.contentLeft}if("number"==typeof e.y){this.scrollY=-o.contentHeight*e.y-o.contentTop}var t=this.scrollX+o.absoluteLeft,r=this.scrollY+o.absoluteTop;this.translate(t,r)};Blockly.WorkspaceSvg.prototype.getBlockById=function(e){return Blockly.WorkspaceSvg.superClass_.getBlockById.call(this,e)};Blockly.WorkspaceSvg.prototype.getTopBlocks=function(e){return Blockly.WorkspaceSvg.superClass_.getTopBlocks.call(this,e)};Blockly.WorkspaceSvg.prototype.addTopBlock=function(e){this.addTopBoundedElement(e);Blockly.WorkspaceSvg.superClass_.addTopBlock.call(this,e)};Blockly.WorkspaceSvg.prototype.removeTopBlock=function(e){this.removeTopBoundedElement(e);Blockly.WorkspaceSvg.superClass_.removeTopBlock.call(this,e)};Blockly.WorkspaceSvg.prototype.addTopComment=function(e){this.addTopBoundedElement(e);Blockly.WorkspaceSvg.superClass_.addTopComment.call(this,e)};Blockly.WorkspaceSvg.prototype.removeTopComment=function(e){this.removeTopBoundedElement(e);Blockly.WorkspaceSvg.superClass_.removeTopComment.call(this,e)};Blockly.WorkspaceSvg.prototype.addTopBoundedElement=function(e){this.topBoundedElements_.push(e)};Blockly.WorkspaceSvg.prototype.removeTopBoundedElement=function(e){Blockly.utils.arrayRemove(this.topBoundedElements_,e)};Blockly.WorkspaceSvg.prototype.getTopBoundedElements=function(){return[].concat(this.topBoundedElements_)};Blockly.WorkspaceSvg.prototype.setResizesEnabled=function(e){var o=!this.resizesEnabled_&&e;this.resizesEnabled_=e;if(o){this.resizeContents()}};Blockly.WorkspaceSvg.prototype.clear=function(){this.setResizesEnabled(!1);Blockly.WorkspaceSvg.superClass_.clear.call(this);this.topBoundedElements_=[];this.setResizesEnabled(!0)};Blockly.WorkspaceSvg.prototype.registerButtonCallback=function(e,o){if("function"!=typeof o){throw TypeError("Button callbacks must be functions.")}this.flyoutButtonCallbacks_[e]=o};Blockly.WorkspaceSvg.prototype.getButtonCallback=function(e){var o=this.flyoutButtonCallbacks_[e];return o?o:null};Blockly.WorkspaceSvg.prototype.removeButtonCallback=function(e){this.flyoutButtonCallbacks_[e]=null};Blockly.WorkspaceSvg.prototype.registerToolboxCategoryCallback=function(e,o){if("function"!=typeof o){throw TypeError("Toolbox category callbacks must be functions.")}this.toolboxCategoryCallbacks_[e]=o};Blockly.WorkspaceSvg.prototype.getToolboxCategoryCallback=function(e){return this.toolboxCategoryCallbacks_[e]||null};Blockly.WorkspaceSvg.prototype.removeToolboxCategoryCallback=function(e){this.toolboxCategoryCallbacks_[e]=null};Blockly.WorkspaceSvg.prototype.getGesture=function(o){var e="mousedown"==o.type||"touchstart"==o.type||"pointerdown"==o.type,t=this.currentGesture_;if(t){if(e&&t.hasStarted()){console.warn("Tried to start the same gesture twice.");t.cancel();return null}return t}if(e){this.currentGesture_=new Blockly.TouchGesture(o,this);return this.currentGesture_}return null};Blockly.WorkspaceSvg.prototype.clearGesture=function(){this.currentGesture_=null};Blockly.WorkspaceSvg.prototype.cancelCurrentGesture=function(){if(this.currentGesture_){this.currentGesture_.cancel()}};Blockly.WorkspaceSvg.prototype.getAudioManager=function(){return this.audioManager_};Blockly.WorkspaceSvg.prototype.getGrid=function(){return this.grid_};
//# sourceMappingURL=workspace_svg.min.js.map
