'use strict';goog.provide("Blockly.Mutator");goog.require("Blockly.Bubble");goog.require("Blockly.Events");goog.require("Blockly.Events.BlockChange");goog.require("Blockly.Events.Ui");goog.require("Blockly.Icon");goog.require("Blockly.navigation");goog.require("Blockly.utils");goog.require("Blockly.utils.dom");goog.require("Blockly.utils.global");goog.require("Blockly.utils.object");goog.require("Blockly.utils.xml");goog.require("Blockly.WorkspaceSvg");goog.require("Blockly.Xml");goog.requireType("Blockly.utils.Metrics");Blockly.Mutator=function(a){Blockly.Mutator.superClass_.constructor.call(this,null);this.quarkNames_=a};Blockly.utils.object.inherits(Blockly.Mutator,Blockly.Icon);Blockly.Mutator.prototype.workspaceWidth_=0;Blockly.Mutator.prototype.workspaceHeight_=0;Blockly.Mutator.prototype.setBlock=function(a){this.block_=a};Blockly.Mutator.prototype.getWorkspace=function(){return this.workspace_};Blockly.Mutator.prototype.drawIcon_=function(a){Blockly.utils.dom.createSvgElement("rect",{class:"blocklyIconShape",rx:"4",ry:"4",height:"16",width:"16"},a);Blockly.utils.dom.createSvgElement("path",{class:"blocklyIconSymbol",d:"m4.203,7.296 0,1.368 -0.92,0.677 -0.11,0.41 0.9,1.559 0.41,0.11 1.043,-0.457 1.187,0.683 0.127,1.134 0.3,0.3 1.8,0 0.3,-0.299 0.127,-1.138 1.185,-0.682 1.046,0.458 0.409,-0.11 0.9,-1.559 -0.11,-0.41 -0.92,-0.677 0,-1.366 0.92,-0.677 0.11,-0.41 -0.9,-1.559 -0.409,-0.109 -1.046,0.458 -1.185,-0.682 -0.127,-1.138 -0.3,-0.299 -1.8,0 -0.3,0.3 -0.126,1.135 -1.187,0.682 -1.043,-0.457 -0.41,0.11 -0.899,1.559 0.108,0.409z"},a);Blockly.utils.dom.createSvgElement("circle",{class:"blocklyIconShape",r:"2.7",cx:"8",cy:"8"},a)};Blockly.Mutator.prototype.iconClick_=function(a){if(this.block_.isEditable()){Blockly.Icon.prototype.iconClick_.call(this,a)}};Blockly.Mutator.prototype.createEditor_=function(){this.svgDialog_=Blockly.utils.dom.createSvgElement("svg",{x:Blockly.Bubble.BORDER_WIDTH,y:Blockly.Bubble.BORDER_WIDTH},null);if(this.quarkNames_.length){for(var a=Blockly.utils.xml.createElement("xml"),b=0,c,d;c=this.quarkNames_[b];b++){d=Blockly.utils.xml.createElement("block");d.setAttribute("type",c);a.appendChild(d)}}else{var a=null}var e=new Blockly.Options({disable:!1,parentWorkspace:this.block_.workspace,media:this.block_.workspace.options.pathToMedia,rtl:this.block_.RTL,horizontalLayout:!1,renderer:this.block_.workspace.options.renderer,rendererOverrides:this.block_.workspace.options.rendererOverrides});e.toolboxPosition=this.block_.RTL?Blockly.TOOLBOX_AT_RIGHT:Blockly.TOOLBOX_AT_LEFT;var f=!!a;if(f){e.languageTree=Blockly.utils.toolbox.convertToolboxToJSON(a);e.getMetrics=this.getFlyoutMetrics_.bind(this)}this.workspace_=new Blockly.WorkspaceSvg(e);this.workspace_.isMutator=!0;this.workspace_.addChangeListener(Blockly.Events.disableOrphans);var g=f?this.workspace_.addFlyout("g"):null,h=this.workspace_.createDom("blocklyMutatorBackground");if(g){h.insertBefore(g,this.workspace_.svgBlockCanvas_)}this.svgDialog_.appendChild(h);return this.svgDialog_};Blockly.Mutator.prototype.updateEditable=function(){Blockly.Mutator.superClass_.updateEditable.call(this);if(!this.block_.isInFlyout){if(this.block_.isEditable()){if(this.iconGroup_){Blockly.utils.dom.removeClass(this.iconGroup_,"blocklyIconGroupReadonly")}}else{this.setVisible(!1);if(this.iconGroup_){Blockly.utils.dom.addClass(this.iconGroup_,"blocklyIconGroupReadonly")}}}};Blockly.Mutator.prototype.resizeBubble_=function(){var a=2*Blockly.Bubble.BORDER_WIDTH,b=this.workspace_.getCanvas().getBBox(),c;if(this.block_.RTL){c=-b.x}else{c=b.width+b.x}var d=b.height+3*a,e=this.workspace_.getFlyout();if(e){var f=e.getMetrics_();d=Math.max(d,f.contentHeight+20)}c+=3*a;if(Math.abs(this.workspaceWidth_-c)>a||Math.abs(this.workspaceHeight_-d)>a){this.workspaceWidth_=c;this.workspaceHeight_=d;this.bubble_.setBubbleSize(c+a,d+a);this.svgDialog_.setAttribute("width",this.workspaceWidth_);this.svgDialog_.setAttribute("height",this.workspaceHeight_)}if(this.block_.RTL){var g="translate("+this.workspaceWidth_+",0)";this.workspace_.getCanvas().setAttribute("transform",g)}this.workspace_.resize()};Blockly.Mutator.prototype.onBubbleMove_=function(){if(this.workspace_){this.workspace_.recordDeleteAreas()}};Blockly.Mutator.prototype.setVisible=function(a){if(a==this.isVisible()){return}Blockly.Events.fire(new Blockly.Events.Ui(this.block_,"mutatorOpen",!a,a));if(a){this.bubble_=new Blockly.Bubble(this.block_.workspace,this.createEditor_(),this.block_.pathObject.svgPath,this.iconXY_,null,null);this.bubble_.setSvgId(this.block_.id);this.bubble_.registerMoveEvent(this.onBubbleMove_.bind(this));var b=this.workspace_.options.languageTree,c=this.workspace_.getFlyout();if(b){c.init(this.workspace_);c.show(b)}this.rootBlock_=this.block_.decompose(this.workspace_);for(var d=this.rootBlock_.getDescendants(!1),e=0,f;f=d[e];e++){f.render()}this.rootBlock_.setMovable(!1);this.rootBlock_.setDeletable(!1);if(c){var g=2*c.CORNER_RADIUS,h=c.getWidth()+g}else{var g=16,h=g}if(this.block_.RTL){h=-h}this.rootBlock_.moveBy(h,g);if(this.block_.saveConnections){var j=this,k=this.block_;k.saveConnections(this.rootBlock_);this.sourceListener_=function(){k.saveConnections(j.rootBlock_)};this.block_.workspace.addChangeListener(this.sourceListener_)}this.resizeBubble_();this.workspace_.addChangeListener(this.workspaceChanged_.bind(this));this.applyColour()}else{this.svgDialog_=null;this.workspace_.dispose();this.workspace_=null;this.rootBlock_=null;this.bubble_.dispose();this.bubble_=null;this.workspaceWidth_=0;this.workspaceHeight_=0;if(this.sourceListener_){this.block_.workspace.removeChangeListener(this.sourceListener_);this.sourceListener_=null}}};Blockly.Mutator.prototype.workspaceChanged_=function(a){if(a.type==Blockly.Events.UI||a.type==Blockly.Events.CHANGE&&"disabled"==a.element){return}if(!this.workspace_.isDragging()){for(var c=this.workspace_.getTopBlocks(!1),d=20,e=0,f;f=c[e];e++){var g=f.getRelativeToSurfaceXY(),h=f.getHeightWidth();if(g.y+h.height<d){f.moveBy(0,d-h.height-g.y)}}}if(this.rootBlock_.workspace==this.workspace_){Blockly.Events.setGroup(!0);var f=this.block_,i=f.mutationToDom(),j=i&&Blockly.Xml.domToText(i);f.compose(this.rootBlock_);f.initSvg();f.render();if(Blockly.getMainWorkspace().keyboardAccessibilityMode){Blockly.navigation.moveCursorOnBlockMutation(f)}var k=f.mutationToDom(),l=k&&Blockly.Xml.domToText(k);if(j!=l){Blockly.Events.fire(new Blockly.Events.BlockChange(f,"mutation",null,j,l))}if(!this.workspace_.isDragging()){this.resizeBubble_()}Blockly.Events.setGroup(!1)}};Blockly.Mutator.prototype.getFlyoutMetrics_=function(){return{contentHeight:0,contentWidth:0,contentTop:0,contentLeft:0,viewHeight:this.workspaceHeight_,viewWidth:this.workspaceWidth_-this.workspace_.getFlyout().getWidth(),viewTop:0,viewLeft:0,absoluteTop:0,absoluteLeft:this.workspace_.RTL?0:this.workspace_.getFlyout().getWidth()}};Blockly.Mutator.prototype.dispose=function(){this.block_.mutator=null;Blockly.Icon.prototype.dispose.call(this)};Blockly.Mutator.prototype.updateBlockStyle=function(){var a=this.workspace_;if(a&&a.getAllBlocks(!1)){for(var b=a.getAllBlocks(!1),c=0,d;c<b.length;c++){d=b[c];d.setStyle(d.getStyleName())}for(var e=a.getFlyout().workspace_.getAllBlocks(!1),c=0,d;c<e.length;c++){d=e[c];d.setStyle(d.getStyleName())}}};Blockly.Mutator.reconnect=function(a,b,c){if(!a||!a.getSourceBlock().workspace){return!1}var d=b.getInput(c).connection,e=a.targetBlock();if((!e||e==b)&&d.targetConnection!=a){if(d.isConnected()){d.disconnect()}d.connect(a);return!0}return!1};Blockly.Mutator.findParentWs=function(a){var b=null;if(a&&a.options){var c=a.options.parentWorkspace;if(a.isFlyout){if(c&&c.options){b=c.options.parentWorkspace}}else if(c){b=c}}return b};
//# sourceMappingURL=mutator.min.js.map
