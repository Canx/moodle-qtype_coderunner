'use strict';goog.provide("Blockly.Gesture");goog.require("Blockly.ASTNode");goog.require("Blockly.blockAnimations");goog.require("Blockly.BlockDragger");goog.require("Blockly.BubbleDragger");goog.require("Blockly.constants");goog.require("Blockly.Events");goog.require("Blockly.Events.Ui");goog.require("Blockly.FlyoutDragger");goog.require("Blockly.navigation");goog.require("Blockly.Tooltip");goog.require("Blockly.Touch");goog.require("Blockly.utils");goog.require("Blockly.utils.Coordinate");goog.require("Blockly.WorkspaceDragger");Blockly.Gesture=function(a,b){this.mouseDownXY_=null;this.currentDragDeltaXY_=new Blockly.utils.Coordinate(0,0);this.startBubble_=null;this.startField_=null;this.startBlock_=null;this.targetBlock_=null;this.startWorkspace_=null;this.creatorWorkspace_=b;this.hasExceededDragRadius_=!1;this.isDraggingWorkspace_=!1;this.isDraggingBlock_=!1;this.isDraggingBubble_=!1;this.mostRecentEvent_=a;this.onMoveWrapper_=null;this.onUpWrapper_=null;this.bubbleDragger_=null;this.blockDragger_=null;this.workspaceDragger_=null;this.flyout_=null;this.calledUpdateIsDragging_=!1;this.hasStarted_=!1;this.isEnding_=!1;this.healStack_=!Blockly.DRAG_STACK};Blockly.Gesture.prototype.dispose=function(){Blockly.Touch.clearTouchIdentifier();Blockly.Tooltip.unblock();this.creatorWorkspace_.clearGesture();if(this.onMoveWrapper_){Blockly.unbindEvent_(this.onMoveWrapper_)}if(this.onUpWrapper_){Blockly.unbindEvent_(this.onUpWrapper_)}if(this.blockDragger_){this.blockDragger_.dispose()}if(this.workspaceDragger_){this.workspaceDragger_.dispose()}if(this.bubbleDragger_){this.bubbleDragger_.dispose()}};Blockly.Gesture.prototype.updateFromEvent_=function(a){var b=new Blockly.utils.Coordinate(a.clientX,a.clientY),c=this.updateDragDelta_(b);if(c){this.updateIsDragging_();Blockly.longStop_()}this.mostRecentEvent_=a};Blockly.Gesture.prototype.updateDragDelta_=function(a){this.currentDragDeltaXY_=Blockly.utils.Coordinate.difference(a,this.mouseDownXY_);if(!this.hasExceededDragRadius_){var b=Blockly.utils.Coordinate.magnitude(this.currentDragDeltaXY_),c=this.flyout_?Blockly.FLYOUT_DRAG_RADIUS:Blockly.DRAG_RADIUS;this.hasExceededDragRadius_=b>c;return this.hasExceededDragRadius_}return!1};Blockly.Gesture.prototype.updateIsDraggingFromFlyout_=function(){if(!this.targetBlock_){return!1}if(!this.flyout_.isBlockCreatable_(this.targetBlock_)){return!1}if(!this.flyout_.isScrollable()||this.flyout_.isDragTowardWorkspace(this.currentDragDeltaXY_)){this.startWorkspace_=this.flyout_.targetWorkspace;this.startWorkspace_.updateScreenCalculationsIfScrolled();if(!Blockly.Events.getGroup()){Blockly.Events.setGroup(!0)}this.startBlock_=null;this.targetBlock_=this.flyout_.createBlock(this.targetBlock_);this.targetBlock_.select();return!0}return!1};Blockly.Gesture.prototype.updateIsDraggingBubble_=function(){if(!this.startBubble_){return!1}this.isDraggingBubble_=!0;this.startDraggingBubble_();return!0};Blockly.Gesture.prototype.updateIsDraggingBlock_=function(){if(!this.targetBlock_){return!1}if(this.flyout_){this.isDraggingBlock_=this.updateIsDraggingFromFlyout_()}else if(this.targetBlock_.isMovable()){this.isDraggingBlock_=!0}if(this.isDraggingBlock_){this.startDraggingBlock_();return!0}return!1};Blockly.Gesture.prototype.updateIsDraggingWorkspace_=function(){var a=this.flyout_?this.flyout_.isScrollable():this.startWorkspace_&&this.startWorkspace_.isDraggable();if(!a){return}if(this.flyout_){this.workspaceDragger_=new Blockly.FlyoutDragger(this.flyout_)}else{this.workspaceDragger_=new Blockly.WorkspaceDragger(this.startWorkspace_)}this.isDraggingWorkspace_=!0;this.workspaceDragger_.startDrag()};Blockly.Gesture.prototype.updateIsDragging_=function(){if(this.calledUpdateIsDragging_){throw Error("updateIsDragging_ should only be called once per gesture.")}this.calledUpdateIsDragging_=!0;if(this.updateIsDraggingBubble_()){return}if(this.updateIsDraggingBlock_()){return}this.updateIsDraggingWorkspace_()};Blockly.Gesture.prototype.startDraggingBlock_=function(){this.blockDragger_=new Blockly.BlockDragger(this.targetBlock_,this.startWorkspace_);this.blockDragger_.startBlockDrag(this.currentDragDeltaXY_,this.healStack_);this.blockDragger_.dragBlock(this.mostRecentEvent_,this.currentDragDeltaXY_)};Blockly.Gesture.prototype.startDraggingBubble_=function(){this.bubbleDragger_=new Blockly.BubbleDragger(this.startBubble_,this.startWorkspace_);this.bubbleDragger_.startBubbleDrag();this.bubbleDragger_.dragBubble(this.mostRecentEvent_,this.currentDragDeltaXY_)};Blockly.Gesture.prototype.doStart=function(a){if(Blockly.utils.isTargetInput(a)){this.cancel();return}this.hasStarted_=!0;Blockly.blockAnimations.disconnectUiStop();this.startWorkspace_.updateScreenCalculationsIfScrolled();if(this.startWorkspace_.isMutator){this.startWorkspace_.resize()}Blockly.hideChaff(!!this.flyout_);this.startWorkspace_.markFocused();this.mostRecentEvent_=a;Blockly.Tooltip.block();if(this.targetBlock_){if(!this.targetBlock_.isInFlyout&&a.shiftKey&&this.targetBlock_.workspace.keyboardAccessibilityMode){this.creatorWorkspace_.getCursor().setCurNode(Blockly.ASTNode.createTopNode(this.targetBlock_))}else{this.targetBlock_.select()}}if(Blockly.utils.isRightButton(a)){this.handleRightClick(a);return}if(("touchstart"==a.type.toLowerCase()||"pointerdown"==a.type.toLowerCase())&&"mouse"!=a.pointerType){Blockly.longStart(a,this)}this.mouseDownXY_=new Blockly.utils.Coordinate(a.clientX,a.clientY);this.healStack_=a.altKey||a.ctrlKey||a.metaKey;this.bindMouseEvents(a)};Blockly.Gesture.prototype.bindMouseEvents=function(a){this.onMoveWrapper_=Blockly.bindEventWithChecks_(document,"mousemove",null,this.handleMove.bind(this));this.onUpWrapper_=Blockly.bindEventWithChecks_(document,"mouseup",null,this.handleUp.bind(this));a.preventDefault();a.stopPropagation()};Blockly.Gesture.prototype.handleMove=function(a){this.updateFromEvent_(a);if(this.isDraggingWorkspace_){this.workspaceDragger_.drag(this.currentDragDeltaXY_)}else if(this.isDraggingBlock_){this.blockDragger_.dragBlock(this.mostRecentEvent_,this.currentDragDeltaXY_)}else if(this.isDraggingBubble_){this.bubbleDragger_.dragBubble(this.mostRecentEvent_,this.currentDragDeltaXY_)}a.preventDefault();a.stopPropagation()};Blockly.Gesture.prototype.handleUp=function(a){this.updateFromEvent_(a);Blockly.longStop_();if(this.isEnding_){console.log("Trying to end a gesture recursively.");return}this.isEnding_=!0;if(this.isDraggingBubble_){this.bubbleDragger_.endBubbleDrag(a,this.currentDragDeltaXY_)}else if(this.isDraggingBlock_){this.blockDragger_.endBlockDrag(a,this.currentDragDeltaXY_)}else if(this.isDraggingWorkspace_){this.workspaceDragger_.endDrag(this.currentDragDeltaXY_)}else if(this.isBubbleClick_()){this.doBubbleClick_()}else if(this.isFieldClick_()){this.doFieldClick_()}else if(this.isBlockClick_()){this.doBlockClick_()}else if(this.isWorkspaceClick_()){this.doWorkspaceClick_(a)}a.preventDefault();a.stopPropagation();this.dispose()};Blockly.Gesture.prototype.cancel=function(){if(this.isEnding_){return}Blockly.longStop_();if(this.isDraggingBubble_){this.bubbleDragger_.endBubbleDrag(this.mostRecentEvent_,this.currentDragDeltaXY_)}else if(this.isDraggingBlock_){this.blockDragger_.endBlockDrag(this.mostRecentEvent_,this.currentDragDeltaXY_)}else if(this.isDraggingWorkspace_){this.workspaceDragger_.endDrag(this.currentDragDeltaXY_)}this.dispose()};Blockly.Gesture.prototype.handleRightClick=function(a){if(this.targetBlock_){this.bringBlockToFront_();Blockly.hideChaff(!!this.flyout_);this.targetBlock_.showContextMenu(a)}else if(this.startBubble_){this.startBubble_.showContextMenu(a)}else if(this.startWorkspace_&&!this.flyout_){Blockly.hideChaff();this.startWorkspace_.showContextMenu(a)}a.preventDefault();a.stopPropagation();this.dispose()};Blockly.Gesture.prototype.handleWsStart=function(a,b){if(this.hasStarted_){throw Error("Tried to call gesture.handleWsStart, but the gesture had already been started.")}this.setStartWorkspace_(b);this.mostRecentEvent_=a;this.doStart(a);if(this.startWorkspace_.keyboardAccessibilityMode){Blockly.navigation.setState(Blockly.navigation.STATE_WS)}};Blockly.Gesture.prototype.fireWorkspaceClick_=function(a){var b=new Blockly.Events.Ui(null,"workspaceClick",null,null);b.workspaceId=a.id;Blockly.Events.fire(b)};Blockly.Gesture.prototype.handleFlyoutStart=function(a,b){if(this.hasStarted_){throw Error("Tried to call gesture.handleFlyoutStart, but the gesture had already been started.")}this.setStartFlyout_(b);this.handleWsStart(a,b.getWorkspace())};Blockly.Gesture.prototype.handleBlockStart=function(a,b){if(this.hasStarted_){throw Error("Tried to call gesture.handleBlockStart, but the gesture had already been started.")}this.setStartBlock(b);this.mostRecentEvent_=a};Blockly.Gesture.prototype.handleBubbleStart=function(a,b){if(this.hasStarted_){throw Error("Tried to call gesture.handleBubbleStart, but the gesture had already been started.")}this.setStartBubble(b);this.mostRecentEvent_=a};Blockly.Gesture.prototype.doBubbleClick_=function(){this.startBubble_.setFocus&&this.startBubble_.setFocus();this.startBubble_.select&&this.startBubble_.select()};Blockly.Gesture.prototype.doFieldClick_=function(){this.startField_.showEditor(this.mostRecentEvent_);this.bringBlockToFront_()};Blockly.Gesture.prototype.doBlockClick_=function(){if(this.flyout_&&this.flyout_.autoClose){if(this.targetBlock_.isEnabled()){if(!Blockly.Events.getGroup()){Blockly.Events.setGroup(!0)}var a=this.flyout_.createBlock(this.targetBlock_);a.scheduleSnapAndBump()}}else{Blockly.Events.fire(new Blockly.Events.Ui(this.startBlock_,"click",void 0,void 0))}this.bringBlockToFront_();Blockly.Events.setGroup(!1)};Blockly.Gesture.prototype.doWorkspaceClick_=function(a){var b=this.creatorWorkspace_;if(a.shiftKey&&b.keyboardAccessibilityMode){var c=new Blockly.utils.Coordinate(a.clientX,a.clientY),d=Blockly.utils.screenToWsCoordinates(b,c),e=Blockly.ASTNode.createWorkspaceNode(b,d);b.getCursor().setCurNode(e)}else if(Blockly.selected){Blockly.selected.unselect()}this.fireWorkspaceClick_(b)};Blockly.Gesture.prototype.bringBlockToFront_=function(){if(this.targetBlock_&&!this.flyout_){this.targetBlock_.bringToFront()}};Blockly.Gesture.prototype.setStartField=function(a){if(this.hasStarted_){throw Error("Tried to call gesture.setStartField, but the gesture had already been started.")}if(!this.startField_){this.startField_=a}};Blockly.Gesture.prototype.setStartBubble=function(a){if(!this.startBubble_){this.startBubble_=a}};Blockly.Gesture.prototype.setStartBlock=function(a){if(!this.startBlock_&&!this.startBubble_){this.startBlock_=a;if(a.isInFlyout&&a!=a.getRootBlock()){this.setTargetBlock_(a.getRootBlock())}else{this.setTargetBlock_(a)}}};Blockly.Gesture.prototype.setTargetBlock_=function(a){if(a.isShadow()){this.setTargetBlock_(a.getParent())}else{this.targetBlock_=a}};Blockly.Gesture.prototype.setStartWorkspace_=function(a){if(!this.startWorkspace_){this.startWorkspace_=a}};Blockly.Gesture.prototype.setStartFlyout_=function(a){if(!this.flyout_){this.flyout_=a}};Blockly.Gesture.prototype.isBubbleClick_=function(){var a=!!this.startBubble_;return a&&!this.hasExceededDragRadius_};Blockly.Gesture.prototype.isBlockClick_=function(){var a=!!this.startBlock_;return a&&!this.hasExceededDragRadius_&&!this.isFieldClick_()};Blockly.Gesture.prototype.isFieldClick_=function(){var a=this.startField_?this.startField_.isClickable():!1;return a&&!this.hasExceededDragRadius_&&(!this.flyout_||!this.flyout_.autoClose)};Blockly.Gesture.prototype.isWorkspaceClick_=function(){var a=!this.startBlock_&&!this.startBubble_&&!this.startField_;return a&&!this.hasExceededDragRadius_};Blockly.Gesture.prototype.isDragging=function(){return this.isDraggingWorkspace_||this.isDraggingBlock_||this.isDraggingBubble_};Blockly.Gesture.prototype.hasStarted=function(){return this.hasStarted_};Blockly.Gesture.prototype.getInsertionMarkers=function(){if(this.blockDragger_){return this.blockDragger_.getInsertionMarkers()}return[]};Blockly.Gesture.inProgress=function(){for(var a=Blockly.Workspace.getAll(),b=0,c;c=a[b];b++){if(c.currentGesture_){return!0}}return!1};
//# sourceMappingURL=gesture.min.js.map
