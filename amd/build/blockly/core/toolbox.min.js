'use strict';goog.provide("Blockly.Toolbox");goog.require("Blockly.Css");goog.require("Blockly.Events");goog.require("Blockly.Events.Ui");goog.require("Blockly.navigation");goog.require("Blockly.registry");goog.require("Blockly.Touch");goog.require("Blockly.tree.TreeControl");goog.require("Blockly.tree.TreeNode");goog.require("Blockly.utils");goog.require("Blockly.utils.aria");goog.require("Blockly.utils.colour");goog.require("Blockly.utils.dom");goog.require("Blockly.utils.object");goog.require("Blockly.utils.Rect");goog.require("Blockly.utils.toolbox");goog.requireType("Blockly.IBlocklyActionable");goog.requireType("Blockly.IDeleteArea");goog.requireType("Blockly.IStyleable");goog.requireType("Blockly.IToolbox");Blockly.Toolbox=function(a){this.workspace_=a;this.RTL=a.options.RTL;this.horizontalLayout_=a.options.horizontalLayout;this.toolboxPosition=a.options.toolboxPosition;this.config_={indentWidth:19,cssRoot:"blocklyTreeRoot",cssHideRoot:"blocklyHidden",cssTreeRow:"blocklyTreeRow",cssItemLabel:"blocklyTreeLabel",cssTreeIcon:"blocklyTreeIcon",cssExpandedFolderIcon:"blocklyTreeIconOpen",cssFileIcon:"blocklyTreeIconNone",cssSelectedRow:"blocklyTreeSelected"};this.treeSeparatorConfig_={cssTreeRow:"blocklyTreeSeparator"};if(this.horizontalLayout_){this.config_.cssTreeRow=this.config_.cssTreeRow+(a.RTL?" blocklyHorizontalTreeRtl":" blocklyHorizontalTree");this.treeSeparatorConfig_.cssTreeRow="blocklyTreeSeparatorHorizontal "+(a.RTL?"blocklyHorizontalTreeRtl":"blocklyHorizontalTree");this.config_.cssTreeIcon=""}this.flyout_=null;this.width=0;this.height=0;this.lastCategory_=null};Blockly.Toolbox.prototype.init=function(){var a=this.workspace_,b=this.workspace_.getParentSvg();this.HtmlDiv=document.createElement("div");this.HtmlDiv.className="blocklyToolboxDiv blocklyNonSelectable";this.HtmlDiv.setAttribute("dir",a.RTL?"RTL":"LTR");b.parentNode.insertBefore(this.HtmlDiv,b);var c=a.getThemeManager();c.subscribe(this.HtmlDiv,"toolboxBackgroundColour","background-color");c.subscribe(this.HtmlDiv,"toolboxForegroundColour","color");Blockly.bindEventWithChecks_(this.HtmlDiv,"mousedown",this,function(a){if(Blockly.utils.isRightButton(a)||a.target==this.HtmlDiv){Blockly.hideChaff(!1)}else{Blockly.hideChaff(!0)}Blockly.Touch.clearTouchIdentifier()},!1,!0);var d=new Blockly.Options({parentWorkspace:a,rtl:a.RTL,oneBasedIndex:a.options.oneBasedIndex,horizontalLayout:a.horizontalLayout,renderer:a.options.renderer,rendererOverrides:a.options.rendererOverrides});d.toolboxPosition=a.options.toolboxPosition;if(a.horizontalLayout){if(!Blockly.HorizontalFlyout){throw Error("Missing require for Blockly.HorizontalFlyout")}this.flyout_=new Blockly.HorizontalFlyout(d)}else{if(!Blockly.VerticalFlyout){throw Error("Missing require for Blockly.VerticalFlyout")}this.flyout_=new Blockly.VerticalFlyout(d)}if(!this.flyout_){throw Error("One of Blockly.VerticalFlyout or Blockly.Horizontal must berequired.")}Blockly.utils.dom.insertAfter(this.flyout_.createDom("svg"),b);this.flyout_.init(a);this.config_.cssCollapsedFolderIcon="blocklyTreeIconClosed"+(a.RTL?"Rtl":"Ltr");this.render(a.options.languageTree)};Blockly.Toolbox.prototype.render=function(a){if(this.tree_){this.tree_.dispose();this.lastCategory_=null}var b=new Blockly.tree.TreeControl(this,this.config_);this.tree_=b;b.setSelectedItem(null);b.onBeforeSelected(this.handleBeforeTreeSelected_);b.onAfterSelected(this.handleAfterTreeSelected_);var c=null;if(a){this.tree_.contents=[];this.hasColours_=!1;c=this.createTree_(a,this.tree_);if(this.tree_.contents.length){throw Error("Toolbox cannot have both blocks and categories in the root level.")}this.workspace_.resizeContents()}b.render(this.HtmlDiv);if(c){b.setSelectedItem(c)}this.addColour_();this.position();if(this.horizontalLayout_){Blockly.utils.aria.setState(this.tree_.getElement(),Blockly.utils.aria.State.ORIENTATION,"horizontal")}};Blockly.Toolbox.prototype.createTree_=function(a,b){var c=null,d=null;if(!a){return null}for(var e=0,f;f=a[e];e++){switch(f.kind.toUpperCase()){case"CATEGORY":var g=f;c=this.addCategory_(g,b)||c;d=f;break;case"SEP":var h=f;d=this.addSeparator_(h,b,d)||d;break;case"BLOCK":case"SHADOW":case"LABEL":case"BUTTON":b.contents.push(f);d=f;break;}}return c};Blockly.Toolbox.prototype.addCategory_=function(a,b){var c=null,d=Blockly.utils.replaceMessageReferences(a.name),e=this.tree_.createNode(d);e.onSizeChanged(this.handleNodeSizeChanged_);e.contents=[];b.add(e);var f=a.custom;if(f){e.contents=f}else{c=this.createTree_(a.contents,e)||c}this.setColourOrStyle_(a,e,d);c=this.setExpanded_(a,e)||c;return c};Blockly.Toolbox.prototype.setColourOrStyle_=function(a,b,c){var d=a.categorystyle,e=a.colour;if(e&&d){b.hexColour="";console.warn("Toolbox category \""+c+"\" must not have both a style and a colour")}else if(d){this.setColourFromStyle_(d,b,c)}else{this.setColour_(e,b,c)}};Blockly.Toolbox.prototype.addSeparator_=function(a,b,c){if(c&&"CATEGORY"==c.kind.toUpperCase()){b.add(new Blockly.Toolbox.TreeSeparator(this.treeSeparatorConfig_))}else{b.contents.push(a);return a}return null};Blockly.Toolbox.prototype.setExpanded_=function(a,b){var c=null;if("true"==a.expanded){if(b.contents.length){c=b}b.setExpanded(!0)}else{b.setExpanded(!1)}return c};Blockly.Toolbox.prototype.handleBeforeTreeSelected_=function(a){if(a==this.tree_){return!1}if(this.lastCategory_){this.lastCategory_.getRowElement().style.backgroundColor=""}if(a){var b=a.hexColour||"#57e";a.getRowElement().style.backgroundColor=b;this.addColour_(a)}return!0};Blockly.Toolbox.prototype.handleAfterTreeSelected_=function(a,b){if(b&&b.contents&&b.contents.length){this.flyout_.show(b.contents);if(this.lastCategory_!=b){this.flyout_.scrollToStart()}if(this.workspace_.keyboardAccessibilityMode){Blockly.navigation.setState(Blockly.navigation.STATE_TOOLBOX)}}else{this.flyout_.hide();if(this.workspace_.keyboardAccessibilityMode&&!(b instanceof Blockly.Toolbox.TreeSeparator)){Blockly.navigation.setState(Blockly.navigation.STATE_WS)}}if(a!=b&&a!=this){var c=new Blockly.Events.Ui(null,"category",a&&a.content,b&&b.content);c.workspaceId=this.workspace_.id;Blockly.Events.fire(c)}if(b){this.lastCategory_=b}};Blockly.Toolbox.prototype.handleNodeSizeChanged_=function(){Blockly.svgResize(this.workspace_)};Blockly.Toolbox.prototype.onBlocklyAction=function(a){var b=this.tree_.getSelectedItem();if(!b){return!1}switch(a.name){case Blockly.navigation.actionNames.PREVIOUS:return b.selectPrevious();case Blockly.navigation.actionNames.OUT:return b.selectParent();case Blockly.navigation.actionNames.NEXT:return b.selectNext();case Blockly.navigation.actionNames.IN:return b.selectChild();default:return!1;}};Blockly.Toolbox.prototype.dispose=function(){this.flyout_.dispose();this.tree_.dispose();this.workspace_.getThemeManager().unsubscribe(this.HtmlDiv);Blockly.utils.dom.removeNode(this.HtmlDiv);this.lastCategory_=null};Blockly.Toolbox.prototype.setVisible=function(a){this.HtmlDiv.style.display=a?"block":"none"};Blockly.Toolbox.prototype.getWidth=function(){return this.width};Blockly.Toolbox.prototype.getHeight=function(){return this.height};Blockly.Toolbox.prototype.getFlyout=function(){return this.flyout_};Blockly.Toolbox.prototype.position=function(){var a=this.HtmlDiv;if(!a){return}var b=Blockly.svgSize(this.workspace_.getParentSvg());if(this.horizontalLayout_){a.style.left="0";a.style.height="auto";a.style.width=b.width+"px";this.height=a.offsetHeight;if(this.toolboxPosition==Blockly.TOOLBOX_AT_TOP){a.style.top="0"}else{a.style.bottom="0"}}else{if(this.toolboxPosition==Blockly.TOOLBOX_AT_RIGHT){a.style.right="0"}else{a.style.left="0"}a.style.height=b.height+"px";this.width=a.offsetWidth}this.flyout_.position()};Blockly.Toolbox.prototype.setColour_=function(a,b,c){var d=Blockly.utils.replaceMessageReferences(a);if(null===d||""===d){b.hexColour=""}else{var e=+d;if(!isNaN(e)){b.hexColour=Blockly.hueToHex(e);this.hasColours_=!0}else{var f=Blockly.utils.colour.parse(d);if(f){b.hexColour=f;this.hasColours_=!0}else{b.hexColour="";console.warn("Toolbox category \""+c+"\" has unrecognized colour attribute: "+d)}}}};Blockly.Toolbox.prototype.setColourFromStyle_=function(a,b,c){b.styleName=a;var d=this.workspace_.getTheme();if(a&&d){var e=d.categoryStyles[a];if(e&&e.colour){this.setColour_(e.colour,b,c)}else{console.warn("Style \""+a+"\" must exist and contain a colour value")}}};Blockly.Toolbox.prototype.updateColourFromTheme_=function(a){var b=a||this.tree_;if(b){for(var c=b.getChildren(!1),d=0,e;e=c[d];d++){if(e.styleName){this.setColourFromStyle_(e.styleName,e,"");this.addColour_()}this.updateColourFromTheme_(e)}}};Blockly.Toolbox.prototype.refreshTheme=function(){var a=this.tree_;if(a){this.updateColourFromTheme_(a);this.updateSelectedItemColour_(a)}};Blockly.Toolbox.prototype.updateSelectedItemColour_=function(a){var b=a.getSelectedItem();if(b){var c=b.hexColour||"#57e";b.getRowElement().style.backgroundColor=c;this.addColour_(b)}};Blockly.Toolbox.prototype.addColour_=function(a){for(var b=a||this.tree_,c=b.getChildren(!1),d=0,e,f;e=c[d];d++){f=e.getRowElement();if(f){if(this.hasColours_){var g="8px solid "+(e.hexColour||"#ddd")}else{var g="none"}if(this.workspace_.RTL){f.style.borderRight=g}else{f.style.borderLeft=g}}this.addColour_(e)}};Blockly.Toolbox.prototype.clearSelection=function(){this.tree_.setSelectedItem(null)};Blockly.Toolbox.prototype.addStyle=function(a){Blockly.utils.dom.addClass(this.HtmlDiv,a)};Blockly.Toolbox.prototype.removeStyle=function(a){Blockly.utils.dom.removeClass(this.HtmlDiv,a)};Blockly.Toolbox.prototype.getClientRect=function(){if(!this.HtmlDiv){return null}var a=this.HtmlDiv.getBoundingClientRect(),b=a.top,c=b+a.height,d=a.left,e=d+a.width;if(this.toolboxPosition==Blockly.TOOLBOX_AT_TOP){return new Blockly.utils.Rect(-10000000,c,-10000000,10000000)}else if(this.toolboxPosition==Blockly.TOOLBOX_AT_BOTTOM){return new Blockly.utils.Rect(b,10000000,-10000000,10000000)}else if(this.toolboxPosition==Blockly.TOOLBOX_AT_LEFT){return new Blockly.utils.Rect(-10000000,10000000,-10000000,e)}else{return new Blockly.utils.Rect(-10000000,10000000,d,10000000)}};Blockly.Toolbox.prototype.refreshSelection=function(){var a=this.tree_.getSelectedItem();if(a&&a.contents){this.flyout_.show(a.contents)}};Blockly.Toolbox.prototype.selectFirstCategory=function(){var a=this.tree_.getSelectedItem();if(!a){this.tree_.selectChild()}};Blockly.Toolbox.TreeSeparator=function(a){Blockly.tree.TreeNode.call(this,null,"",a)};Blockly.utils.object.inherits(Blockly.Toolbox.TreeSeparator,Blockly.tree.TreeNode);Blockly.Css.register([".blocklyToolboxDelete {","cursor: url(\"<<<PATH>>>/handdelete.cur\"), auto;","}",".blocklyToolboxGrab {","cursor: url(\"<<<PATH>>>/handclosed.cur\"), auto;","cursor: grabbing;","cursor: -webkit-grabbing;","}",".blocklyToolboxDiv {","background-color: #ddd;","overflow-x: visible;","overflow-y: auto;","position: absolute;","z-index: 70;","-webkit-tap-highlight-color: transparent;","}",".blocklyTreeRoot {","padding: 4px 0;","}",".blocklyTreeRoot:focus {","outline: none;","}",".blocklyTreeRow {","height: 22px;","line-height: 22px;","margin-bottom: 3px;","padding-right: 8px;","white-space: nowrap;","}",".blocklyHorizontalTree {","float: left;","margin: 1px 5px 8px 0;","}",".blocklyHorizontalTreeRtl {","float: right;","margin: 1px 0 8px 5px;","}",".blocklyToolboxDiv[dir=\"RTL\"] .blocklyTreeRow {","margin-left: 8px;","}",".blocklyTreeRow:not(.blocklyTreeSelected):hover {","background-color: rgba(255, 255, 255, 0.2);","}",".blocklyTreeSeparator {","border-bottom: solid #e5e5e5 1px;","height: 0;","margin: 5px 0;","}",".blocklyTreeSeparatorHorizontal {","border-right: solid #e5e5e5 1px;","width: 0;","padding: 5px 0;","margin: 0 5px;","}",".blocklyTreeIcon {","background-image: url(<<<PATH>>>/sprites.png);","height: 16px;","vertical-align: middle;","width: 16px;","}",".blocklyTreeIconClosedLtr {","background-position: -32px -1px;","}",".blocklyTreeIconClosedRtl {","background-position: 0 -1px;","}",".blocklyTreeIconOpen {","background-position: -16px -1px;","}",".blocklyTreeSelected>.blocklyTreeIconClosedLtr {","background-position: -32px -17px;","}",".blocklyTreeSelected>.blocklyTreeIconClosedRtl {","background-position: 0 -17px;","}",".blocklyTreeSelected>.blocklyTreeIconOpen {","background-position: -16px -17px;","}",".blocklyTreeIconNone,",".blocklyTreeSelected>.blocklyTreeIconNone {","background-position: -48px -1px;","}",".blocklyTreeLabel {","cursor: default;","font: 16px sans-serif;","padding: 0 3px;","vertical-align: middle;","}",".blocklyToolboxDelete .blocklyTreeLabel {","cursor: url(\"<<<PATH>>>/handdelete.cur\"), auto;","}",".blocklyTreeSelected .blocklyTreeLabel {","color: #fff;","}"]);Blockly.registry.register(Blockly.registry.Type.TOOLBOX,Blockly.registry.DEFAULT,Blockly.Toolbox);
//# sourceMappingURL=toolbox.min.js.map
