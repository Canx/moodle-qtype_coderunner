'use strict';goog.provide("Blockly.Field");goog.require("Blockly.Events");goog.require("Blockly.Events.BlockChange");goog.require("Blockly.Gesture");goog.require("Blockly.utils");goog.require("Blockly.utils.dom");goog.require("Blockly.utils.Rect");goog.require("Blockly.utils.Size");goog.require("Blockly.utils.style");goog.require("Blockly.utils.userAgent");goog.requireType("Blockly.blockRendering.ConstantProvider");goog.requireType("Blockly.IASTNodeLocationSvg");goog.requireType("Blockly.IASTNodeLocationWithBlock");goog.requireType("Blockly.IBlocklyActionable");goog.requireType("Blockly.IRegistrable");Blockly.Field=function(a,b,c){this.value_=this.DEFAULT_VALUE;this.validator_=null;this.tooltip_=null;this.size_=new Blockly.utils.Size(0,0);this.cursorSvg_=null;this.markerSvg_=null;this.fieldGroup_=null;this.borderRect_=null;this.textElement_=null;this.textContent_=null;this.mouseDownWrapper_=null;this.constants_=null;c&&this.configure_(c);this.setValue(a);b&&this.setValidator(b)};Blockly.Field.prototype.DEFAULT_VALUE=null;Blockly.Field.prototype.name=void 0;Blockly.Field.prototype.disposed=!1;Blockly.Field.prototype.maxDisplayLength=50;Blockly.Field.prototype.sourceBlock_=null;Blockly.Field.prototype.isDirty_=!0;Blockly.Field.prototype.visible_=!0;Blockly.Field.prototype.clickTarget_=null;Blockly.Field.prototype.getText_;Blockly.Field.prototype.showEditor_;Blockly.Field.NBSP="\xA0";Blockly.Field.prototype.EDITABLE=!0;Blockly.Field.prototype.SERIALIZABLE=!1;Blockly.Field.prototype.configure_=function(a){var b=a.tooltip;if("string"==typeof b){b=Blockly.utils.replaceMessageReferences(a.tooltip)}b&&this.setTooltip(b)};Blockly.Field.prototype.setSourceBlock=function(a){if(this.sourceBlock_){throw Error("Field already bound to a block.")}this.sourceBlock_=a};Blockly.Field.prototype.getConstants=function(){if(!this.constants_&&this.sourceBlock_&&this.sourceBlock_.workspace&&this.sourceBlock_.workspace.rendered){this.constants_=this.sourceBlock_.workspace.getRenderer().getConstants()}return this.constants_};Blockly.Field.prototype.getSourceBlock=function(){return this.sourceBlock_};Blockly.Field.prototype.init=function(){if(this.fieldGroup_){return}this.fieldGroup_=Blockly.utils.dom.createSvgElement("g",{},null);if(!this.isVisible()){this.fieldGroup_.style.display="none"}var a=this.sourceBlock_;a.getSvgRoot().appendChild(this.fieldGroup_);this.initView();this.updateEditable();this.setTooltip(this.tooltip_);this.bindEvents_();this.initModel()};Blockly.Field.prototype.initView=function(){this.createBorderRect_();this.createTextElement_()};Blockly.Field.prototype.initModel=function(){};Blockly.Field.prototype.createBorderRect_=function(){this.borderRect_=Blockly.utils.dom.createSvgElement("rect",{rx:this.getConstants().FIELD_BORDER_RECT_RADIUS,ry:this.getConstants().FIELD_BORDER_RECT_RADIUS,x:0,y:0,height:this.size_.height,width:this.size_.width,class:"blocklyFieldRect"},this.fieldGroup_)};Blockly.Field.prototype.createTextElement_=function(){this.textElement_=Blockly.utils.dom.createSvgElement("text",{class:"blocklyText"},this.fieldGroup_);if(this.getConstants().FIELD_TEXT_BASELINE_CENTER){this.textElement_.setAttribute("dominant-baseline","central")}this.textContent_=document.createTextNode("");this.textElement_.appendChild(this.textContent_)};Blockly.Field.prototype.bindEvents_=function(){Blockly.Tooltip.bindMouseEvents(this.getClickTarget_());this.mouseDownWrapper_=Blockly.bindEventWithChecks_(this.getClickTarget_(),"mousedown",this,this.onMouseDown_)};Blockly.Field.prototype.fromXml=function(a){this.setValue(a.textContent)};Blockly.Field.prototype.toXml=function(a){a.textContent=this.getValue();return a};Blockly.Field.prototype.dispose=function(){Blockly.DropDownDiv.hideIfOwner(this);Blockly.WidgetDiv.hideIfOwner(this);Blockly.Tooltip.unbindMouseEvents(this.getClickTarget_());if(this.mouseDownWrapper_){Blockly.unbindEvent_(this.mouseDownWrapper_)}Blockly.utils.dom.removeNode(this.fieldGroup_);this.disposed=!0};Blockly.Field.prototype.updateEditable=function(){var a=this.fieldGroup_;if(!this.EDITABLE||!a){return}if(this.sourceBlock_.isEditable()){Blockly.utils.dom.addClass(a,"blocklyEditableText");Blockly.utils.dom.removeClass(a,"blocklyNonEditableText");a.style.cursor=this.CURSOR}else{Blockly.utils.dom.addClass(a,"blocklyNonEditableText");Blockly.utils.dom.removeClass(a,"blocklyEditableText");a.style.cursor=""}};Blockly.Field.prototype.isClickable=function(){return!!this.sourceBlock_&&this.sourceBlock_.isEditable()&&!!this.showEditor_&&"function"==typeof this.showEditor_};Blockly.Field.prototype.isCurrentlyEditable=function(){return this.EDITABLE&&!!this.sourceBlock_&&this.sourceBlock_.isEditable()};Blockly.Field.prototype.isSerializable=function(){var a=!1;if(this.name){if(this.SERIALIZABLE){a=!0}else if(this.EDITABLE){console.warn("Detected an editable field that was not serializable. Please define SERIALIZABLE property as true on all editable custom fields. Proceeding with serialization.");a=!0}}return a};Blockly.Field.prototype.isVisible=function(){return this.visible_};Blockly.Field.prototype.setVisible=function(a){if(this.visible_==a){return}this.visible_=a;var b=this.getSvgRoot();if(b){b.style.display=a?"block":"none"}};Blockly.Field.prototype.setValidator=function(a){this.validator_=a};Blockly.Field.prototype.getValidator=function(){return this.validator_};Blockly.Field.prototype.classValidator=function(a){return a};Blockly.Field.prototype.callValidator=function(a){var b=this.classValidator(a);if(null===b){return null}else if(b!==void 0){a=b}var c=this.getValidator();if(c){var d=c.call(this,a);if(null===d){return null}else if(d!==void 0){a=d}}return a};Blockly.Field.prototype.getSvgRoot=function(){return this.fieldGroup_};Blockly.Field.prototype.applyColour=function(){};Blockly.Field.prototype.render_=function(){if(this.textContent_){this.textContent_.nodeValue=this.getDisplayText_()}this.updateSize_()};Blockly.Field.prototype.showEditor=function(a){if(this.isClickable()){this.showEditor_(a)}};Blockly.Field.prototype.updateWidth=function(){console.warn("Deprecated call to updateWidth, call Blockly.Field.updateSize_ to force an update to the size of the field, or Blockly.utils.dom.getTextWidth() to check the size of the field.");this.updateSize_()};Blockly.Field.prototype.updateSize_=function(a){var b=this.getConstants(),c=a!=void 0?a:this.borderRect_?this.getConstants().FIELD_BORDER_RECT_X_PADDING:0,d=2*c,e=b.FIELD_TEXT_HEIGHT,f=0;if(this.textElement_){f=Blockly.utils.dom.getFastTextWidth(this.textElement_,b.FIELD_TEXT_FONTSIZE,b.FIELD_TEXT_FONTWEIGHT,b.FIELD_TEXT_FONTFAMILY);d+=f}if(this.borderRect_){e=Math.max(e,b.FIELD_BORDER_RECT_HEIGHT)}this.size_.height=e;this.size_.width=d;this.positionTextElement_(c,f);this.positionBorderRect_()};Blockly.Field.prototype.positionTextElement_=function(a,b){if(!this.textElement_){return}var c=this.getConstants(),d=this.size_.height/2;this.textElement_.setAttribute("x",this.sourceBlock_.RTL?this.size_.width-b-a:a);this.textElement_.setAttribute("y",c.FIELD_TEXT_BASELINE_CENTER?d:d-c.FIELD_TEXT_HEIGHT/2+c.FIELD_TEXT_BASELINE)};Blockly.Field.prototype.positionBorderRect_=function(){if(!this.borderRect_){return}this.borderRect_.setAttribute("width",this.size_.width);this.borderRect_.setAttribute("height",this.size_.height);this.borderRect_.setAttribute("rx",this.getConstants().FIELD_BORDER_RECT_RADIUS);this.borderRect_.setAttribute("ry",this.getConstants().FIELD_BORDER_RECT_RADIUS)};Blockly.Field.prototype.getSize=function(){if(!this.isVisible()){return new Blockly.utils.Size(0,0)}if(this.isDirty_){this.render_();this.isDirty_=!1}else if(this.visible_&&0==this.size_.width){console.warn("Deprecated use of setting size_.width to 0 to rerender a field. Set field.isDirty_ to true instead.");this.render_()}return this.size_};Blockly.Field.prototype.getScaledBBox=function(){if(!this.borderRect_){var a=this.sourceBlock_.getHeightWidth(),b=this.sourceBlock_.workspace.scale,c=this.getAbsoluteXY_(),d=a.width*b,e=a.height*b;if(Blockly.utils.userAgent.GECKO){c.x+=1.5*b;c.y+=1.5*b;d+=1*b;e+=1*b}else{if(!Blockly.utils.userAgent.EDGE&&!Blockly.utils.userAgent.IE){c.x-=.5*b;c.y-=.5*b}d+=1*b;e+=1*b}}else{var a=this.borderRect_.getBoundingClientRect(),c=Blockly.utils.style.getPageOffset(this.borderRect_),d=a.width,e=a.height}return new Blockly.utils.Rect(c.y,c.y+e,c.x,c.x+d)};Blockly.Field.prototype.getDisplayText_=function(){var a=this.getText();if(!a){return Blockly.Field.NBSP}if(a.length>this.maxDisplayLength){a=a.substring(0,this.maxDisplayLength-2)+"\u2026"}a=a.replace(/\s/g,Blockly.Field.NBSP);if(this.sourceBlock_&&this.sourceBlock_.RTL){a+="\u200F"}return a};Blockly.Field.prototype.getText=function(){if(this.getText_){var a=this.getText_.call(this);if(null!==a){return a+""}}return this.getValue()+""};Blockly.Field.prototype.setText=function(){throw Error("setText method is deprecated")};Blockly.Field.prototype.markDirty=function(){this.isDirty_=!0;this.constants_=null};Blockly.Field.prototype.forceRerender=function(){this.isDirty_=!0;if(this.sourceBlock_&&this.sourceBlock_.rendered){this.sourceBlock_.render();this.sourceBlock_.bumpNeighbours();this.updateMarkers_()}};Blockly.Field.prototype.setValue=function(a){if(null===a){return}var b=this.doClassValidation_(a);a=this.processValidation_(a,b);if(a instanceof Error){return}var c=this.getValidator();if(c){b=c.call(this,a);a=this.processValidation_(a,b);if(a instanceof Error){return}}var d=this.sourceBlock_;if(d&&d.disposed){return}var e=this.getValue();if(e===a){return}if(d&&Blockly.Events.isEnabled()){Blockly.Events.fire(new Blockly.Events.BlockChange(d,"field",this.name||null,e,a))}this.doValueUpdate_(a);if(this.isDirty_){this.forceRerender()}};Blockly.Field.prototype.processValidation_=function(a,b){if(null===b){this.doValueInvalid_(a);if(this.isDirty_){this.forceRerender()}return Error()}if(b!==void 0){a=b}return a};Blockly.Field.prototype.getValue=function(){return this.value_};Blockly.Field.prototype.doClassValidation_=function(a){if(null===a||a===void 0){return null}a=this.classValidator(a);return a};Blockly.Field.prototype.doValueUpdate_=function(a){this.value_=a;this.isDirty_=!0};Blockly.Field.prototype.doValueInvalid_=function(){};Blockly.Field.prototype.onMouseDown_=function(a){if(!this.sourceBlock_||!this.sourceBlock_.workspace){return}var b=this.sourceBlock_.workspace.getGesture(a);if(b){b.setStartField(this)}};Blockly.Field.prototype.setTooltip=function(a){var b=this.getClickTarget_();if(!b){this.tooltip_=a;return}if(!a&&""!==a){b.tooltip=this.sourceBlock_}else{b.tooltip=a}};Blockly.Field.prototype.getClickTarget_=function(){return this.clickTarget_||this.getSvgRoot()};Blockly.Field.prototype.getAbsoluteXY_=function(){return Blockly.utils.style.getPageOffset(this.getClickTarget_())};Blockly.Field.prototype.referencesVariables=function(){return!1};Blockly.Field.prototype.getParentInput=function(){for(var a=null,b=this.sourceBlock_,c=b.inputList,d=0;d<b.inputList.length;d++){for(var e=c[d],f=e.fieldRow,g=0;g<f.length;g++){if(f[g]===this){a=e;break}}}return a};Blockly.Field.prototype.getFlipRtl=function(){return!1};Blockly.Field.prototype.isTabNavigable=function(){return!1};Blockly.Field.prototype.onBlocklyAction=function(){return!1};Blockly.Field.prototype.setCursorSvg=function(a){if(!a){this.cursorSvg_=null;return}this.fieldGroup_.appendChild(a);this.cursorSvg_=a};Blockly.Field.prototype.setMarkerSvg=function(a){if(!a){this.markerSvg_=null;return}this.fieldGroup_.appendChild(a);this.markerSvg_=a};Blockly.Field.prototype.updateMarkers_=function(){var a=this.sourceBlock_.workspace;if(a.keyboardAccessibilityMode&&this.cursorSvg_){a.getCursor().draw()}if(a.keyboardAccessibilityMode&&this.markerSvg_){a.getMarker(Blockly.navigation.MARKER_NAME).draw()}};
//# sourceMappingURL=field.min.js.map
