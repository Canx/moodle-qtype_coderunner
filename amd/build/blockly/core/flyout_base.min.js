'use strict';goog.provide("Blockly.Flyout");goog.require("Blockly.Block");goog.require("Blockly.blockRendering");goog.require("Blockly.Events");goog.require("Blockly.Events.BlockCreate");goog.require("Blockly.Events.VarCreate");goog.require("Blockly.FlyoutCursor");goog.require("Blockly.Gesture");goog.require("Blockly.Marker");goog.require("Blockly.Scrollbar");goog.require("Blockly.Tooltip");goog.require("Blockly.Touch");goog.require("Blockly.utils");goog.require("Blockly.utils.Coordinate");goog.require("Blockly.utils.dom");goog.require("Blockly.WorkspaceSvg");goog.require("Blockly.Xml");goog.requireType("Blockly.IBlocklyActionable");goog.requireType("Blockly.IDeleteArea");goog.requireType("Blockly.utils.Metrics");Blockly.Flyout=function(a){a.getMetrics=this.getMetrics_.bind(this);a.setMetrics=this.setMetrics_.bind(this);this.workspace_=new Blockly.WorkspaceSvg(a);this.workspace_.isFlyout=!0;this.workspace_.setVisible(this.isVisible_);this.RTL=!!a.RTL;this.horizontalLayout=!1;this.toolboxPosition_=a.toolboxPosition;this.eventWrappers_=[];this.mats_=[];this.buttons_=[];this.listeners_=[];this.permanentlyDisabled_=[];this.tabWidth_=this.workspace_.getRenderer().getConstants().TAB_WIDTH;this.targetWorkspace=null};Blockly.Flyout.prototype.autoClose=!0;Blockly.Flyout.prototype.isVisible_=!1;Blockly.Flyout.prototype.containerVisible_=!0;Blockly.Flyout.prototype.CORNER_RADIUS=8;Blockly.Flyout.prototype.MARGIN=Blockly.Flyout.prototype.CORNER_RADIUS;Blockly.Flyout.prototype.GAP_X=3*Blockly.Flyout.prototype.MARGIN;Blockly.Flyout.prototype.GAP_Y=3*Blockly.Flyout.prototype.MARGIN;Blockly.Flyout.prototype.SCROLLBAR_PADDING=2;Blockly.Flyout.prototype.width_=0;Blockly.Flyout.prototype.height_=0;Blockly.Flyout.prototype.dragAngleRange_=70;Blockly.Flyout.prototype.createDom=function(a){this.svgGroup_=Blockly.utils.dom.createSvgElement(a,{class:"blocklyFlyout",style:"display: none"},null);this.svgBackground_=Blockly.utils.dom.createSvgElement("path",{class:"blocklyFlyoutBackground"},this.svgGroup_);this.svgGroup_.appendChild(this.workspace_.createDom());this.workspace_.getThemeManager().subscribe(this.svgBackground_,"flyoutBackgroundColour","fill");this.workspace_.getThemeManager().subscribe(this.svgBackground_,"flyoutOpacity","fill-opacity");this.workspace_.getMarkerManager().setCursor(new Blockly.FlyoutCursor);return this.svgGroup_};Blockly.Flyout.prototype.init=function(a){this.targetWorkspace=a;this.workspace_.targetWorkspace=a;this.scrollbar=new Blockly.Scrollbar(this.workspace_,this.horizontalLayout,!1,"blocklyFlyoutScrollbar");this.hide();Array.prototype.push.apply(this.eventWrappers_,Blockly.bindEventWithChecks_(this.svgGroup_,"wheel",this,this.wheel_));if(!this.autoClose){this.filterWrapper_=this.filterForCapacity_.bind(this);this.targetWorkspace.addChangeListener(this.filterWrapper_)}Array.prototype.push.apply(this.eventWrappers_,Blockly.bindEventWithChecks_(this.svgBackground_,"mousedown",this,this.onMouseDown_));this.workspace_.getGesture=this.targetWorkspace.getGesture.bind(this.targetWorkspace);this.workspace_.setVariableMap(this.targetWorkspace.getVariableMap());this.workspace_.createPotentialVariableMap()};Blockly.Flyout.prototype.dispose=function(){this.hide();Blockly.unbindEvent_(this.eventWrappers_);if(this.filterWrapper_){this.targetWorkspace.removeChangeListener(this.filterWrapper_);this.filterWrapper_=null}if(this.scrollbar){this.scrollbar.dispose();this.scrollbar=null}if(this.workspace_){this.workspace_.getThemeManager().unsubscribe(this.svgBackground_);this.workspace_.targetWorkspace=null;this.workspace_.dispose();this.workspace_=null}if(this.svgGroup_){Blockly.utils.dom.removeNode(this.svgGroup_);this.svgGroup_=null}this.svgBackground_=null;this.targetWorkspace=null};Blockly.Flyout.prototype.getWidth=function(){return this.width_};Blockly.Flyout.prototype.getHeight=function(){return this.height_};Blockly.Flyout.prototype.getWorkspace=function(){return this.workspace_};Blockly.Flyout.prototype.isVisible=function(){return this.isVisible_};Blockly.Flyout.prototype.setVisible=function(a){var b=a!=this.isVisible();this.isVisible_=a;if(b){this.updateDisplay_()}};Blockly.Flyout.prototype.setContainerVisible=function(a){var b=a!=this.containerVisible_;this.containerVisible_=a;if(b){this.updateDisplay_()}};Blockly.Flyout.prototype.updateDisplay_=function(){var a=!0;if(!this.containerVisible_){a=!1}else{a=this.isVisible()}this.svgGroup_.style.display=a?"block":"none";this.scrollbar.setContainerVisible(a)};Blockly.Flyout.prototype.positionAt_=function(a,b,c,d){this.svgGroup_.setAttribute("width",a);this.svgGroup_.setAttribute("height",b);if("svg"==this.svgGroup_.tagName){var e="translate("+c+"px,"+d+"px)";Blockly.utils.dom.setCssTransform(this.svgGroup_,e)}else{var e="translate("+c+","+d+")";this.svgGroup_.setAttribute("transform",e)}if(this.scrollbar){this.scrollbar.setOrigin(c,d);this.scrollbar.resize();this.scrollbar.setPosition(this.scrollbar.position.x,this.scrollbar.position.y)}};Blockly.Flyout.prototype.hide=function(){if(!this.isVisible()){return}this.setVisible(!1);for(var a=0,b;b=this.listeners_[a];a++){Blockly.unbindEvent_(b)}this.listeners_.length=0;if(this.reflowWrapper_){this.workspace_.removeChangeListener(this.reflowWrapper_);this.reflowWrapper_=null}};Blockly.Flyout.prototype.show=function(a){this.workspace_.setResizesEnabled(!1);this.hide();this.clearOldBlocks_();if("string"==typeof a){var b=this.workspace_.targetWorkspace.getToolboxCategoryCallback(a);if("function"!=typeof b){throw TypeError("Couldn't find a callback function when opening a toolbox category.")}a=b(this.workspace_.targetWorkspace);if(!Array.isArray(a)){throw TypeError("Result of toolbox category callback must be an array.")}}this.setVisible(!0);var c=Blockly.utils.toolbox.convertToolboxToJSON(a),d=this.createFlyoutInfo_(c);this.layout_(d.contents,d.gaps);this.listeners_.push(Blockly.bindEventWithChecks_(this.svgBackground_,"mouseover",this,function deselectAll(){for(var a=this.workspace_.getTopBlocks(!1),b=0,c;c=a[b];b++){c.removeSelect()}}));if(this.horizontalLayout){this.height_=0}else{this.width_=0}this.workspace_.setResizesEnabled(!0);this.reflow();this.filterForCapacity_();this.position();this.reflowWrapper_=this.reflow.bind(this);this.workspace_.addChangeListener(this.reflowWrapper_)};Blockly.Flyout.prototype.createFlyoutInfo_=function(a){var b=[],c=[];this.permanentlyDisabled_.length=0;for(var d=this.horizontalLayout?this.GAP_X:this.GAP_Y,e=0,f;f=a[e];e++){switch(f.kind.toUpperCase()){case"BLOCK":var g=f,h=this.getBlockXml_(g),j=this.createBlock_(h),k=parseInt(g.gap||h.getAttribute("gap"),10);c.push(isNaN(k)?d:k);b.push({type:"block",block:j});break;case"SEP":var l=f;this.addSeparatorGap_(l,c,d);break;case"LABEL":var m=f,n=this.createButton_(m,!0);b.push({type:"button",button:n});c.push(d);break;case"BUTTON":var o=f,p=this.createButton_(o,!1);b.push({type:"button",button:p});c.push(d);break;}}return{contents:b,gaps:c}};Blockly.Flyout.prototype.createButton_=function(a,b){if(!Blockly.FlyoutButton){throw Error("Missing require for Blockly.FlyoutButton")}var c=new Blockly.FlyoutButton(this.workspace_,this.targetWorkspace,a,b);return c};Blockly.Flyout.prototype.createBlock_=function(a){var b=Blockly.Xml.domToBlock(a,this.workspace_);if(!b.isEnabled()){this.permanentlyDisabled_.push(b)}return b};Blockly.Flyout.prototype.getBlockXml_=function(a){var b=null,c=a.blockxml;if(c&&"string"!=typeof c){b=c}else if(c&&"string"==typeof c){b=Blockly.Xml.textToDom(c)}else if(a.type){b=Blockly.utils.xml.createElement("xml");b.setAttribute("type",a.type);b.setAttribute("disabled",a.disabled)}if(!b){throw Error("Error: Invalid block definition. Block definition must have blockxml or type.")}return b};Blockly.Flyout.prototype.addSeparatorGap_=function(a,b,c){var d=parseInt(a.gap,10);if(!isNaN(d)&&0<b.length){b[b.length-1]=d}else{b.push(c)}};Blockly.Flyout.prototype.clearOldBlocks_=function(){for(var a=this.workspace_.getTopBlocks(!1),b=0,c;c=a[b];b++){if(c.workspace==this.workspace_){c.dispose(!1,!1)}}for(var d=0,e;d<this.mats_.length;d++){e=this.mats_[d];if(e){Blockly.Tooltip.unbindMouseEvents(e);Blockly.utils.dom.removeNode(e)}}this.mats_.length=0;for(var b=0,f;f=this.buttons_[b];b++){f.dispose()}this.buttons_.length=0;this.workspace_.getPotentialVariableMap().clear()};Blockly.Flyout.prototype.addBlockListeners_=function(a,b,c){this.listeners_.push(Blockly.bindEventWithChecks_(a,"mousedown",null,this.blockMouseDown_(b)));this.listeners_.push(Blockly.bindEventWithChecks_(c,"mousedown",null,this.blockMouseDown_(b)));this.listeners_.push(Blockly.bindEvent_(a,"mouseenter",b,b.addSelect));this.listeners_.push(Blockly.bindEvent_(a,"mouseleave",b,b.removeSelect));this.listeners_.push(Blockly.bindEvent_(c,"mouseenter",b,b.addSelect));this.listeners_.push(Blockly.bindEvent_(c,"mouseleave",b,b.removeSelect))};Blockly.Flyout.prototype.blockMouseDown_=function(a){var b=this;return function(c){var d=b.targetWorkspace.getGesture(c);if(d){d.setStartBlock(a);d.handleFlyoutStart(c,b)}}};Blockly.Flyout.prototype.onMouseDown_=function(a){var b=this.targetWorkspace.getGesture(a);if(b){b.handleFlyoutStart(a,this)}};Blockly.Flyout.prototype.isBlockCreatable_=function(a){return a.isEnabled()};Blockly.Flyout.prototype.createBlock=function(a){var b=null;Blockly.Events.disable();var c=this.targetWorkspace.getAllVariables();this.targetWorkspace.setResizesEnabled(!1);try{b=this.placeNewBlock_(a);Blockly.hideChaff()}finally{Blockly.Events.enable()}var d=Blockly.Variables.getAddedVariables(this.targetWorkspace,c);if(Blockly.Events.isEnabled()){Blockly.Events.setGroup(!0);Blockly.Events.fire(new Blockly.Events.Create(b));for(var e=0,f;e<d.length;e++){f=d[e];Blockly.Events.fire(new Blockly.Events.VarCreate(f))}}if(this.autoClose){this.hide()}else{this.filterForCapacity_()}return b};Blockly.Flyout.prototype.initFlyoutButton_=function(a,b,c){var d=a.createDom();a.moveTo(b,c);a.show();this.listeners_.push(Blockly.bindEventWithChecks_(d,"mousedown",this,this.onMouseDown_));this.buttons_.push(a)};Blockly.Flyout.prototype.createRect_=function(a,b,c,d,e){var f=Blockly.utils.dom.createSvgElement("rect",{"fill-opacity":0,x:b,y:c,height:d.height,width:d.width},null);f.tooltip=a;Blockly.Tooltip.bindMouseEvents(f);this.workspace_.getCanvas().insertBefore(f,a.getSvgRoot());a.flyoutRect_=f;this.mats_[e]=f;return f};Blockly.Flyout.prototype.moveRectToBlock_=function(a,b){var c=b.getHeightWidth();a.setAttribute("width",c.width);a.setAttribute("height",c.height);var d=b.getRelativeToSurfaceXY();a.setAttribute("y",d.y);a.setAttribute("x",this.RTL?d.x-c.width:d.x)};Blockly.Flyout.prototype.filterForCapacity_=function(){for(var a=this.workspace_.getTopBlocks(!1),b=0,c;c=a[b];b++){if(-1==this.permanentlyDisabled_.indexOf(c)){var d=this.targetWorkspace.isCapacityAvailable(Blockly.utils.getBlockTypeCounts(c));while(c){c.setEnabled(d);c=c.getNextBlock()}}}};Blockly.Flyout.prototype.reflow=function(){if(this.reflowWrapper_){this.workspace_.removeChangeListener(this.reflowWrapper_)}this.reflowInternal_();if(this.reflowWrapper_){this.workspace_.addChangeListener(this.reflowWrapper_)}};Blockly.Flyout.prototype.isScrollable=function(){return this.scrollbar?this.scrollbar.isVisible():!1};Blockly.Flyout.prototype.placeNewBlock_=function(a){var b=this.targetWorkspace,c=a.getSvgRoot();if(!c){throw Error("oldBlock is not rendered.")}var d=Blockly.Xml.blockToDom(a,!0);b.setResizesEnabled(!1);var e=Blockly.Xml.domToBlock(d,b),f=e.getSvgRoot();if(!f){throw Error("block is not rendered.")}var g=b.getOriginOffsetInPixels(),h=this.workspace_.getOriginOffsetInPixels(),i=a.getRelativeToSurfaceXY();i.scale(this.workspace_.scale);var j=Blockly.utils.Coordinate.sum(h,i),k=Blockly.utils.Coordinate.difference(j,g);k.scale(1/b.scale);e.moveBy(k.x,k.y);return e};Blockly.Flyout.prototype.onBlocklyAction=function(a){var b=this.workspace_.getCursor();return b.onBlocklyAction(a)};Blockly.Flyout.prototype.getClientRect;Blockly.Flyout.prototype.position;Blockly.Flyout.prototype.isDragTowardWorkspace;Blockly.Flyout.prototype.getMetrics_;Blockly.Flyout.prototype.setMetrics_;Blockly.Flyout.prototype.layout_;Blockly.Flyout.prototype.wheel_;Blockly.Flyout.prototype.reflowInternal_;
//# sourceMappingURL=flyout_base.min.js.map
