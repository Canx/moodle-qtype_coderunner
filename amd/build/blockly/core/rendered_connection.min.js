'use strict';goog.provide("Blockly.RenderedConnection");goog.require("Blockly.Connection");goog.require("Blockly.Events");goog.require("Blockly.utils");goog.require("Blockly.utils.Coordinate");goog.require("Blockly.utils.dom");goog.require("Blockly.utils.object");Blockly.RenderedConnection=function(a,b){Blockly.RenderedConnection.superClass_.constructor.call(this,a,b);this.db_=a.workspace.connectionDBList[b];this.dbOpposite_=a.workspace.connectionDBList[Blockly.OPPOSITE_TYPE[b]];this.offsetInBlock_=new Blockly.utils.Coordinate(0,0);this.trackedState_=Blockly.RenderedConnection.TrackedState.WILL_TRACK;this.targetConnection=null};Blockly.utils.object.inherits(Blockly.RenderedConnection,Blockly.Connection);Blockly.RenderedConnection.TrackedState={WILL_TRACK:-1,UNTRACKED:0,TRACKED:1};Blockly.RenderedConnection.prototype.dispose=function(){Blockly.RenderedConnection.superClass_.dispose.call(this);if(this.trackedState_==Blockly.RenderedConnection.TrackedState.TRACKED){this.db_.removeConnection(this,this.y)}};Blockly.RenderedConnection.prototype.getSourceBlock=function(){return Blockly.RenderedConnection.superClass_.getSourceBlock.call(this)};Blockly.RenderedConnection.prototype.targetBlock=function(){return Blockly.RenderedConnection.superClass_.targetBlock.call(this)};Blockly.RenderedConnection.prototype.distanceFrom=function(a){var b=this.x-a.x,c=this.y-a.y;return Math.sqrt(b*b+c*c)};Blockly.RenderedConnection.prototype.bumpAwayFrom=function(a){if(this.sourceBlock_.workspace.isDragging()){return}var b=this.sourceBlock_.getRootBlock();if(b.isInFlyout){return}var c=!1;if(!b.isMovable()){b=a.getSourceBlock().getRootBlock();if(!b.isMovable()){return}a=this;c=!0}var d=Blockly.selected==b;d||b.addSelect();var e=a.x+Blockly.SNAP_RADIUS+Math.floor(Math.random()*Blockly.BUMP_RANDOMNESS)-this.x,f=a.y+Blockly.SNAP_RADIUS+Math.floor(Math.random()*Blockly.BUMP_RANDOMNESS)-this.y;if(c){f=-f}if(b.RTL){e=a.x-Blockly.SNAP_RADIUS-Math.floor(Math.random()*Blockly.BUMP_RANDOMNESS)-this.x}b.moveBy(e,f);d||b.removeSelect()};Blockly.RenderedConnection.prototype.moveTo=function(a,b){if(this.trackedState_==Blockly.RenderedConnection.TrackedState.WILL_TRACK){this.db_.addConnection(this,b);this.trackedState_=Blockly.RenderedConnection.TrackedState.TRACKED}else if(this.trackedState_==Blockly.RenderedConnection.TrackedState.TRACKED){this.db_.removeConnection(this,this.y);this.db_.addConnection(this,b)}this.x=a;this.y=b};Blockly.RenderedConnection.prototype.moveBy=function(a,b){this.moveTo(this.x+a,this.y+b)};Blockly.RenderedConnection.prototype.moveToOffset=function(a){this.moveTo(a.x+this.offsetInBlock_.x,a.y+this.offsetInBlock_.y)};Blockly.RenderedConnection.prototype.setOffsetInBlock=function(a,b){this.offsetInBlock_.x=a;this.offsetInBlock_.y=b};Blockly.RenderedConnection.prototype.getOffsetInBlock=function(){return this.offsetInBlock_};Blockly.RenderedConnection.prototype.tighten=function(){var a=this.targetConnection.x-this.x,b=this.targetConnection.y-this.y;if(0!=a||0!=b){var c=this.targetBlock(),d=c.getSvgRoot();if(!d){throw Error("block is not rendered.")}var e=Blockly.utils.getRelativeXY(d);c.getSvgRoot().setAttribute("transform","translate("+(e.x-a)+","+(e.y-b)+")");c.moveConnections(-a,-b)}};Blockly.RenderedConnection.prototype.closest=function(a,b){return this.dbOpposite_.searchForClosest(this,a,b)};Blockly.RenderedConnection.prototype.highlight=function(){var a,b=this.sourceBlock_,c=b.workspace.getRenderer().getConstants(),d=c.shapeFor(this);if(this.type==Blockly.INPUT_VALUE||this.type==Blockly.OUTPUT_VALUE){var e=c.TAB_OFFSET_FROM_TOP;a=Blockly.utils.svgPaths.moveBy(0,-e)+Blockly.utils.svgPaths.lineOnAxis("v",e)+d.pathDown+Blockly.utils.svgPaths.lineOnAxis("v",e)}else{var f=c.NOTCH_OFFSET_LEFT-c.CORNER_RADIUS;a=Blockly.utils.svgPaths.moveBy(-f,0)+Blockly.utils.svgPaths.lineOnAxis("h",f)+d.pathLeft+Blockly.utils.svgPaths.lineOnAxis("h",f)}var g=this.sourceBlock_.getRelativeToSurfaceXY(),h=this.x-g.x,i=this.y-g.y;Blockly.Connection.highlightedPath_=Blockly.utils.dom.createSvgElement("path",{class:"blocklyHighlightedConnectionPath",d:a,transform:"translate("+h+","+i+")"+(this.sourceBlock_.RTL?" scale(-1 1)":"")},this.sourceBlock_.getSvgRoot())};Blockly.RenderedConnection.prototype.unhighlight=function(){Blockly.utils.dom.removeNode(Blockly.Connection.highlightedPath_);delete Blockly.Connection.highlightedPath_};Blockly.RenderedConnection.prototype.setTracking=function(a){if(a&&this.trackedState_==Blockly.RenderedConnection.TrackedState.TRACKED||!a&&this.trackedState_==Blockly.RenderedConnection.TrackedState.UNTRACKED){return}if(this.sourceBlock_.isInFlyout){return}if(a){this.db_.addConnection(this,this.y);this.trackedState_=Blockly.RenderedConnection.TrackedState.TRACKED;return}if(this.trackedState_==Blockly.RenderedConnection.TrackedState.TRACKED){this.db_.removeConnection(this,this.y)}this.trackedState_=Blockly.RenderedConnection.TrackedState.UNTRACKED};Blockly.RenderedConnection.prototype.stopTrackingAll=function(){this.setTracking(!1);if(this.targetConnection){for(var a=this.targetBlock().getDescendants(!1),b=0;b<a.length;b++){for(var c=a[b],d=c.getConnections_(!0),e=0;e<d.length;e++){d[e].setTracking(!1)}for(var f=c.getIcons(),e=0;e<f.length;e++){f[e].setVisible(!1)}}}};Blockly.RenderedConnection.prototype.startTrackingAll=function(){this.setTracking(!0);var a=[];if(this.type!=Blockly.INPUT_VALUE&&this.type!=Blockly.NEXT_STATEMENT){return a}var b=this.targetBlock();if(b){var c;if(b.isCollapsed()){c=[];b.outputConnection&&c.push(b.outputConnection);b.nextConnection&&c.push(b.nextConnection);b.previousConnection&&c.push(b.previousConnection)}else{c=b.getConnections_(!0)}for(var d=0;d<c.length;d++){a.push.apply(a,c[d].startTrackingAll())}if(!a.length){a[0]=b}}return a};Blockly.RenderedConnection.prototype.isConnectionAllowed=function(a,b){if(this.distanceFrom(a)>b){return!1}return Blockly.RenderedConnection.superClass_.isConnectionAllowed.call(this,a)};Blockly.RenderedConnection.prototype.onFailedConnect=function(a){this.bumpAwayFrom(a)};Blockly.RenderedConnection.prototype.disconnectInternal_=function(a,b){Blockly.RenderedConnection.superClass_.disconnectInternal_.call(this,a,b);if(a.rendered){a.render()}if(b.rendered){b.updateDisabled();b.render();b.getSvgRoot().style.display="block"}};Blockly.RenderedConnection.prototype.respawnShadow_=function(){var a=this.getSourceBlock(),b=this.getShadowDom();if(a.workspace&&b&&Blockly.Events.recordUndo){Blockly.RenderedConnection.superClass_.respawnShadow_.call(this);var c=this.targetBlock();if(!c){throw Error("Couldn't respawn the shadow block that should exist here.")}c.initSvg();c.render(!1);if(a.rendered){a.render()}}};Blockly.RenderedConnection.prototype.neighbours=function(a){return this.dbOpposite_.getNeighbours(this,a)};Blockly.RenderedConnection.prototype.connect_=function(a){Blockly.RenderedConnection.superClass_.connect_.call(this,a);var b=this,c=b.getSourceBlock(),d=a.getSourceBlock(),e=c.rendered,f=d.rendered;if(e){c.updateDisabled()}if(f){d.updateDisabled()}if(e&&f){if(b.type==Blockly.NEXT_STATEMENT||b.type==Blockly.PREVIOUS_STATEMENT){d.render()}else{c.render()}}var g=c.getInputWithBlock(d);if(g){var h=g.isVisible();d.getSvgRoot().style.display=h?"block":"none"}};Blockly.RenderedConnection.prototype.onCheckChanged_=function(){if(this.isConnected()&&(!this.targetConnection||!this.checkType(this.targetConnection))){var a=this.isSuperior()?this.targetBlock():this.sourceBlock_;a.unplug();this.sourceBlock_.bumpNeighbours()}};
//# sourceMappingURL=rendered_connection.min.js.map
