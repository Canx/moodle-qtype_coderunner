'use strict';goog.provide("Blockly.navigation");goog.require("Blockly.Action");goog.require("Blockly.ASTNode");goog.require("Blockly.utils.Coordinate");goog.require("Blockly.user.keyMap");Blockly.navigation.loggingCallback=null;Blockly.navigation.STATE_FLYOUT=1;Blockly.navigation.STATE_WS=2;Blockly.navigation.STATE_TOOLBOX=3;Blockly.navigation.WS_MOVE_DISTANCE=40;Blockly.navigation.currentState_=Blockly.navigation.STATE_WS;Blockly.navigation.actionNames={PREVIOUS:"previous",NEXT:"next",IN:"in",OUT:"out",INSERT:"insert",MARK:"mark",DISCONNECT:"disconnect",TOOLBOX:"toolbox",EXIT:"exit",TOGGLE_KEYBOARD_NAV:"toggle_keyboard_nav",MOVE_WS_CURSOR_UP:"move workspace cursor up",MOVE_WS_CURSOR_DOWN:"move workspace cursor down",MOVE_WS_CURSOR_LEFT:"move workspace cursor left",MOVE_WS_CURSOR_RIGHT:"move workspace cursor right"};Blockly.navigation.MARKER_NAME="local_marker_1";Blockly.navigation.getMarker=function(){return Blockly.navigation.getNavigationWorkspace().getMarker(Blockly.navigation.MARKER_NAME)};Blockly.navigation.getNavigationWorkspace=function(){return Blockly.getMainWorkspace()};Blockly.navigation.focusToolbox_=function(){var a=Blockly.navigation.getNavigationWorkspace().getToolbox();if(a){Blockly.navigation.currentState_=Blockly.navigation.STATE_TOOLBOX;Blockly.navigation.resetFlyout_(!1);if(!Blockly.navigation.getMarker().getCurNode()){Blockly.navigation.markAtCursor_()}a.selectFirstCategory()}};Blockly.navigation.focusFlyout_=function(){var a=null;Blockly.navigation.currentState_=Blockly.navigation.STATE_FLYOUT;var b=Blockly.navigation.getNavigationWorkspace(),c=b.getToolbox(),d=c?c.getFlyout():b.getFlyout();if(!Blockly.navigation.getMarker().getCurNode()){Blockly.navigation.markAtCursor_()}if(d&&d.getWorkspace()){var e=d.getWorkspace().getTopBlocks(!0);if(0<e.length){a=e[0];var f=Blockly.ASTNode.createStackNode(a);Blockly.navigation.getFlyoutCursor_().setCurNode(f)}}};Blockly.navigation.focusWorkspace_=function(){Blockly.hideChaff();var a=Blockly.navigation.getNavigationWorkspace(),b=a.getCursor(),c=!!a.getToolbox(),d=a.getTopBlocks(!0);Blockly.navigation.resetFlyout_(c);Blockly.navigation.currentState_=Blockly.navigation.STATE_WS;if(0<d.length){b.setCurNode(Blockly.ASTNode.createTopNode(d[0]))}else{var e=new Blockly.utils.Coordinate(100,100),f=Blockly.ASTNode.createWorkspaceNode(a,e);b.setCurNode(f)}};Blockly.navigation.getFlyoutCursor_=function(){var a=Blockly.navigation.getNavigationWorkspace(),b=null;if(a.rendered){var c=a.getToolbox(),d=c?c.getFlyout():a.getFlyout();b=d?d.getWorkspace().getCursor():null}return b};Blockly.navigation.insertFromFlyout=function(){var a=Blockly.navigation.getNavigationWorkspace(),b=a.getFlyout();if(!b||!b.isVisible()){Blockly.navigation.warn_("Trying to insert from the flyout when the flyout does not  exist or is not visible");return}var c=Blockly.navigation.getFlyoutCursor_().getCurNode().getLocation();if(!c.isEnabled()){Blockly.navigation.warn_("Can't insert a disabled block.");return}var d=b.createBlock(c);d.render();d.setConnectionTracking(!0);a.getCursor().setCurNode(Blockly.ASTNode.createBlockNode(d));if(!Blockly.navigation.modify_()){Blockly.navigation.warn_("Something went wrong while inserting a block from the flyout.")}Blockly.navigation.focusWorkspace_();a.getCursor().setCurNode(Blockly.ASTNode.createTopNode(d));Blockly.navigation.removeMark_()};Blockly.navigation.resetFlyout_=function(a){if(Blockly.navigation.getFlyoutCursor_()){Blockly.navigation.getFlyoutCursor_().hide();if(a){Blockly.navigation.getNavigationWorkspace().getFlyout().hide()}}};Blockly.navigation.modifyWarn_=function(){var a=Blockly.navigation.getMarker().getCurNode(),b=Blockly.navigation.getNavigationWorkspace().getCursor().getCurNode();if(!a){Blockly.navigation.warn_("Cannot insert with no marked node.");return!1}if(!b){Blockly.navigation.warn_("Cannot insert with no cursor node.");return!1}var c=a.getType(),d=b.getType();if(c==Blockly.ASTNode.types.FIELD){Blockly.navigation.warn_("Should not have been able to mark a field.");return!1}else if(c==Blockly.ASTNode.types.BLOCK){Blockly.navigation.warn_("Should not have been able to mark a block.");return!1}else if(c==Blockly.ASTNode.types.STACK){Blockly.navigation.warn_("Should not have been able to mark a stack.");return!1}if(d==Blockly.ASTNode.types.FIELD){Blockly.navigation.warn_("Cannot attach a field to anything else.");return!1}else if(d==Blockly.ASTNode.types.WORKSPACE){Blockly.navigation.warn_("Cannot attach a workspace to anything else.");return!1}return!0};Blockly.navigation.moveBlockToWorkspace_=function(a,b){if(!a){return!1}if(a.isShadow()){Blockly.navigation.warn_("Cannot move a shadow block to the workspace.");return!1}if(a.getParent()){a.unplug(!1)}a.moveTo(b.getWsCoordinate());return!0};Blockly.navigation.modify_=function(){var a=Blockly.navigation.getMarker().getCurNode(),b=Blockly.navigation.getNavigationWorkspace().getCursor().getCurNode();if(!Blockly.navigation.modifyWarn_()){return!1}var c=a.getType(),d=b.getType(),e=b.getLocation(),f=a.getLocation();if(a.isConnection()&&b.isConnection()){e=e;f=f;return Blockly.navigation.connect_(e,f)}else if(a.isConnection()&&(d==Blockly.ASTNode.types.BLOCK||d==Blockly.ASTNode.types.STACK)){e=e;f=f;return Blockly.navigation.insertBlock(e,f)}else if(c==Blockly.ASTNode.types.WORKSPACE){var g=b?b.getSourceBlock():null;return Blockly.navigation.moveBlockToWorkspace_(g,a)}Blockly.navigation.warn_("Unexpected state in Blockly.navigation.modify_.");return!1};Blockly.navigation.disconnectChild_=function(a,b){var c=a.getSourceBlock(),d=b.getSourceBlock();if(c.getRootBlock()==d.getRootBlock()){if(-1<c.getDescendants(!1).indexOf(d)){Blockly.navigation.getInferiorConnection_(b).disconnect()}else{Blockly.navigation.getInferiorConnection_(a).disconnect()}}};Blockly.navigation.moveAndConnect_=function(a,b){if(!a||!b){return!1}var c=a.getSourceBlock();if(b.canConnectWithReason(a)==Blockly.Connection.CAN_CONNECT){Blockly.navigation.disconnectChild_(a,b);if(!b.isSuperior()){var d=c.getRootBlock();d.positionNearConnection(a,b)}b.connect(a);return!0}return!1};Blockly.navigation.getInferiorConnection_=function(a){var b=a.getSourceBlock();if(!a.isSuperior()){return a}else if(b.previousConnection){return b.previousConnection}else if(b.outputConnection){return b.outputConnection}else{return null}};Blockly.navigation.getSuperiorConnection_=function(a){if(a.isSuperior()){return a}else if(a.targetConnection){return a.targetConnection}return null};Blockly.navigation.connect_=function(a,b){if(!a||!b){return!1}var c=Blockly.navigation.getInferiorConnection_(a),d=Blockly.navigation.getSuperiorConnection_(b),e=Blockly.navigation.getSuperiorConnection_(a),f=Blockly.navigation.getInferiorConnection_(b);if(c&&d&&Blockly.navigation.moveAndConnect_(c,d)){return!0}else if(e&&f&&Blockly.navigation.moveAndConnect_(e,f)){return!0}else if(Blockly.navigation.moveAndConnect_(a,b)){return!0}else{try{b.checkConnection(a)}catch(a){Blockly.navigation.warn_("Connection failed with error: "+a)}return!1}};Blockly.navigation.insertBlock=function(a,b){switch(b.type){case Blockly.PREVIOUS_STATEMENT:if(Blockly.navigation.connect_(a.nextConnection,b)){return!0}break;case Blockly.NEXT_STATEMENT:if(Blockly.navigation.connect_(a.previousConnection,b)){return!0}break;case Blockly.INPUT_VALUE:if(Blockly.navigation.connect_(a.outputConnection,b)){return!0}break;case Blockly.OUTPUT_VALUE:for(var c=0,d;c<a.inputList.length;c++){d=a.inputList[c].connection;if(d&&d.type===Blockly.INPUT_VALUE&&Blockly.navigation.connect_(d,b)){return!0}}if(a.outputConnection&&Blockly.navigation.connect_(a.outputConnection,b)){return!0}break;}Blockly.navigation.warn_("This block can not be inserted at the marked location.");return!1};Blockly.navigation.disconnectBlocks_=function(){var a=Blockly.navigation.getNavigationWorkspace(),b=a.getCursor().getCurNode();if(!b.isConnection()){Blockly.navigation.log_("Cannot disconnect blocks when the cursor is not on a connection");return}var c=b.getLocation();if(!c.isConnected()){Blockly.navigation.log_("Cannot disconnect unconnected connection");return}var d=c.isSuperior()?c:c.targetConnection,e=c.isSuperior()?c.targetConnection:c;if(e.getSourceBlock().isShadow()){Blockly.navigation.log_("Cannot disconnect a shadow block");return}d.disconnect();e.bumpAwayFrom(d);var f=d.getSourceBlock().getRootBlock();f.bringToFront();var g=Blockly.ASTNode.createConnectionNode(d);a.getCursor().setCurNode(g)};Blockly.navigation.markAtCursor_=function(){Blockly.navigation.getMarker().setCurNode(Blockly.navigation.getNavigationWorkspace().getCursor().getCurNode())};Blockly.navigation.removeMark_=function(){var a=Blockly.navigation.getMarker();a.setCurNode(null);a.hide()};Blockly.navigation.setState=function(a){Blockly.navigation.currentState_=a};Blockly.navigation.moveCursorOnBlockDelete=function(a){var b=Blockly.navigation.getNavigationWorkspace();if(!b){return}var c=b.getCursor();if(c){var d=c.getCurNode(),e=d?d.getSourceBlock():null;if(e===a){if(e.getParent()){var f=e.previousConnection||e.outputConnection;if(f){c.setCurNode(Blockly.ASTNode.createConnectionNode(f.targetConnection))}}else{c.setCurNode(Blockly.ASTNode.createWorkspaceNode(e.workspace,e.getRelativeToSurfaceXY()))}}else if(e&&-1<a.getChildren(!1).indexOf(e)){c.setCurNode(Blockly.ASTNode.createWorkspaceNode(e.workspace,e.getRelativeToSurfaceXY()))}}};Blockly.navigation.moveCursorOnBlockMutation=function(a){var b=Blockly.navigation.getNavigationWorkspace().getCursor();if(b){var c=b.getCurNode(),d=c?c.getSourceBlock():null;if(d===a){b.setCurNode(Blockly.ASTNode.createBlockNode(d))}}};Blockly.navigation.enableKeyboardAccessibility=function(){var a=Blockly.navigation.getNavigationWorkspace();if(!a.keyboardAccessibilityMode){a.keyboardAccessibilityMode=!0;Blockly.navigation.focusWorkspace_()}};Blockly.navigation.disableKeyboardAccessibility=function(){var a=Blockly.navigation.getNavigationWorkspace();if(a.keyboardAccessibilityMode){a.keyboardAccessibilityMode=!1;a.getCursor().hide();Blockly.navigation.getMarker().hide();if(Blockly.navigation.getFlyoutCursor_()){Blockly.navigation.getFlyoutCursor_().hide()}}};Blockly.navigation.log_=function(a){if(Blockly.navigation.loggingCallback){Blockly.navigation.loggingCallback("log",a)}else{console.log(a)}};Blockly.navigation.warn_=function(a){if(Blockly.navigation.loggingCallback){Blockly.navigation.loggingCallback("warn",a)}else{console.warn(a)}};Blockly.navigation.error_=function(a){if(Blockly.navigation.loggingCallback){Blockly.navigation.loggingCallback("error",a)}else{console.error(a)}};Blockly.navigation.onKeyPress=function(a){var b=Blockly.user.keyMap.serializeKeyEvent(a),c=Blockly.user.keyMap.getActionByKeyCode(b);if(c){return Blockly.navigation.onBlocklyAction(c)}return!1};Blockly.navigation.onBlocklyAction=function(a){var b=Blockly.navigation.getNavigationWorkspace(),c=b.options.readOnly,d=!1;if(b.keyboardAccessibilityMode){if(!c){d=Blockly.navigation.handleActions_(a)}else if(-1<Blockly.navigation.READONLY_ACTION_LIST.indexOf(a)){d=Blockly.navigation.handleActions_(a)}}else if(a.name===Blockly.navigation.actionNames.TOGGLE_KEYBOARD_NAV){Blockly.navigation.enableKeyboardAccessibility();d=!0}return d};Blockly.navigation.handleActions_=function(a){if(a.name==Blockly.navigation.actionNames.TOOLBOX||Blockly.navigation.currentState_==Blockly.navigation.STATE_TOOLBOX){return Blockly.navigation.toolboxOnAction_(a)}else if(a.name==Blockly.navigation.actionNames.TOGGLE_KEYBOARD_NAV){Blockly.navigation.disableKeyboardAccessibility();return!0}if(Blockly.navigation.currentState_==Blockly.navigation.STATE_WS){return Blockly.navigation.workspaceOnAction_(a)}else if(Blockly.navigation.currentState_==Blockly.navigation.STATE_FLYOUT){return Blockly.navigation.flyoutOnAction_(a)}return!1};Blockly.navigation.flyoutOnAction_=function(a){var b=Blockly.navigation.getNavigationWorkspace(),c=b.getToolbox(),d=c?c.getFlyout():b.getFlyout();if(d&&d.onBlocklyAction(a)){return!0}switch(a.name){case Blockly.navigation.actionNames.OUT:Blockly.navigation.focusToolbox_();return!0;case Blockly.navigation.actionNames.MARK:Blockly.navigation.insertFromFlyout();return!0;case Blockly.navigation.actionNames.EXIT:Blockly.navigation.focusWorkspace_();return!0;default:return!1;}};Blockly.navigation.toolboxOnAction_=function(a){var b=Blockly.navigation.getNavigationWorkspace(),c=b.getToolbox(),d=c&&"function"==typeof c.onBlocklyAction?c.onBlocklyAction(a):!1;if(d){return!0}if(a.name===Blockly.navigation.actionNames.TOOLBOX){if(!b.getToolbox()){Blockly.navigation.focusFlyout_()}else{Blockly.navigation.focusToolbox_()}return!0}else if(a.name===Blockly.navigation.actionNames.IN){Blockly.navigation.focusFlyout_();return!0}else if(a.name===Blockly.navigation.actionNames.EXIT){Blockly.navigation.focusWorkspace_();return!0}return!1};Blockly.navigation.moveWSCursor_=function(a,b){var c=Blockly.navigation.getNavigationWorkspace(),d=c.getCursor(),e=c.getCursor().getCurNode();if(e.getType()!==Blockly.ASTNode.types.WORKSPACE){return!1}var f=e.getWsCoordinate(),g=a*Blockly.navigation.WS_MOVE_DISTANCE+f.x,h=b*Blockly.navigation.WS_MOVE_DISTANCE+f.y;d.setCurNode(Blockly.ASTNode.createWorkspaceNode(c,new Blockly.utils.Coordinate(g,h)));return!0};Blockly.navigation.workspaceOnAction_=function(a){var b=Blockly.navigation.getNavigationWorkspace();if(b.getCursor().onBlocklyAction(a)){return!0}switch(a.name){case Blockly.navigation.actionNames.INSERT:Blockly.navigation.modify_();return!0;case Blockly.navigation.actionNames.MARK:Blockly.navigation.handleEnterForWS_();return!0;case Blockly.navigation.actionNames.DISCONNECT:Blockly.navigation.disconnectBlocks_();return!0;case Blockly.navigation.actionNames.MOVE_WS_CURSOR_UP:return Blockly.navigation.moveWSCursor_(0,-1);case Blockly.navigation.actionNames.MOVE_WS_CURSOR_DOWN:return Blockly.navigation.moveWSCursor_(0,1);case Blockly.navigation.actionNames.MOVE_WS_CURSOR_LEFT:return Blockly.navigation.moveWSCursor_(-1,0);case Blockly.navigation.actionNames.MOVE_WS_CURSOR_RIGHT:return Blockly.navigation.moveWSCursor_(1,0);default:return!1;}};Blockly.navigation.handleEnterForWS_=function(){var a=Blockly.navigation.getNavigationWorkspace().getCursor(),b=a.getCurNode(),c=b.getType();if(c==Blockly.ASTNode.types.FIELD){b.getLocation().showEditor()}else if(b.isConnection()||c==Blockly.ASTNode.types.WORKSPACE){Blockly.navigation.markAtCursor_()}else if(c==Blockly.ASTNode.types.BLOCK){Blockly.navigation.warn_("Cannot mark a block.")}else if(c==Blockly.ASTNode.types.STACK){Blockly.navigation.warn_("Cannot mark a stack.")}};Blockly.navigation.ACTION_PREVIOUS=new Blockly.Action(Blockly.navigation.actionNames.PREVIOUS,"Go to the previous location.");Blockly.navigation.ACTION_OUT=new Blockly.Action(Blockly.navigation.actionNames.OUT,"Go to the parent of the current location.");Blockly.navigation.ACTION_NEXT=new Blockly.Action(Blockly.navigation.actionNames.NEXT,"Go to the next location.");Blockly.navigation.ACTION_IN=new Blockly.Action(Blockly.navigation.actionNames.IN,"Go to the first child of the current location.");Blockly.navigation.ACTION_INSERT=new Blockly.Action(Blockly.navigation.actionNames.INSERT,"Connect the current location to the marked location.");Blockly.navigation.ACTION_MARK=new Blockly.Action(Blockly.navigation.actionNames.MARK,"Mark the current location.");Blockly.navigation.ACTION_DISCONNECT=new Blockly.Action(Blockly.navigation.actionNames.DISCONNECT,"Disconnect the block at the current location from its parent.");Blockly.navigation.ACTION_TOOLBOX=new Blockly.Action(Blockly.navigation.actionNames.TOOLBOX,"Open the toolbox.");Blockly.navigation.ACTION_EXIT=new Blockly.Action(Blockly.navigation.actionNames.EXIT,"Close the current modal, such as a toolbox or field editor.");Blockly.navigation.ACTION_TOGGLE_KEYBOARD_NAV=new Blockly.Action(Blockly.navigation.actionNames.TOGGLE_KEYBOARD_NAV,"Turns on and off keyboard navigation.");Blockly.navigation.ACTION_MOVE_WS_CURSOR_LEFT=new Blockly.Action(Blockly.navigation.actionNames.MOVE_WS_CURSOR_LEFT,"Move the workspace cursor to the lefts.");Blockly.navigation.ACTION_MOVE_WS_CURSOR_RIGHT=new Blockly.Action(Blockly.navigation.actionNames.MOVE_WS_CURSOR_RIGHT,"Move the workspace cursor to the right.");Blockly.navigation.ACTION_MOVE_WS_CURSOR_UP=new Blockly.Action(Blockly.navigation.actionNames.MOVE_WS_CURSOR_UP,"Move the workspace cursor up.");Blockly.navigation.ACTION_MOVE_WS_CURSOR_DOWN=new Blockly.Action(Blockly.navigation.actionNames.MOVE_WS_CURSOR_DOWN,"Move the workspace cursor down.");Blockly.navigation.READONLY_ACTION_LIST=[Blockly.navigation.ACTION_PREVIOUS,Blockly.navigation.ACTION_OUT,Blockly.navigation.ACTION_IN,Blockly.navigation.ACTION_NEXT,Blockly.navigation.ACTION_TOGGLE_KEYBOARD_NAV];
//# sourceMappingURL=navigation.min.js.map
