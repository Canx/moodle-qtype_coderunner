'use strict';function _typeof(a){"@babel/helpers - typeof";if("function"==typeof Symbol&&"symbol"==typeof Symbol.iterator){_typeof=function(a){return typeof a}}else{_typeof=function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a}}return _typeof(a)}goog.provide("Blockly.FieldDropdown");goog.require("Blockly.Events");goog.require("Blockly.Events.BlockChange");goog.require("Blockly.Field");goog.require("Blockly.fieldRegistry");goog.require("Blockly.Menu");goog.require("Blockly.MenuItem");goog.require("Blockly.navigation");goog.require("Blockly.utils");goog.require("Blockly.utils.aria");goog.require("Blockly.utils.Coordinate");goog.require("Blockly.utils.dom");goog.require("Blockly.utils.object");goog.require("Blockly.utils.Size");goog.require("Blockly.utils.string");goog.require("Blockly.utils.userAgent");Blockly.FieldDropdown=function(a,b,c){if("function"!=typeof a){Blockly.FieldDropdown.validateOptions_(a)}this.menuGenerator_=a;this.generatedOptions_=null;this.prefixField=null;this.suffixField=null;this.trimOptions_();this.selectedOption_=this.getOptions(!1)[0];Blockly.FieldDropdown.superClass_.constructor.call(this,this.selectedOption_[1],b,c);this.selectedMenuItem_=null;this.menu_=null;this.imageElement_=null;this.arrow_=null;this.svgArrow_=null};Blockly.utils.object.inherits(Blockly.FieldDropdown,Blockly.Field);Blockly.FieldDropdown.ImageProperties;Blockly.FieldDropdown.fromJson=function(a){return new Blockly.FieldDropdown(a.options,void 0,a)};Blockly.FieldDropdown.prototype.SERIALIZABLE=!0;Blockly.FieldDropdown.CHECKMARK_OVERHANG=25;Blockly.FieldDropdown.MAX_MENU_HEIGHT_VH=.45;Blockly.FieldDropdown.IMAGE_Y_OFFSET=5;Blockly.FieldDropdown.IMAGE_Y_PADDING=2*Blockly.FieldDropdown.IMAGE_Y_OFFSET;Blockly.FieldDropdown.ARROW_CHAR=Blockly.utils.userAgent.ANDROID?"\u25BC":"\u25BE";Blockly.FieldDropdown.prototype.CURSOR="default";Blockly.FieldDropdown.prototype.initView=function(){if(this.shouldAddBorderRect_()){this.createBorderRect_()}else{this.clickTarget_=this.sourceBlock_.getSvgRoot()}this.createTextElement_();this.imageElement_=Blockly.utils.dom.createSvgElement("image",{},this.fieldGroup_);if(this.getConstants().FIELD_DROPDOWN_SVG_ARROW){this.createSVGArrow_()}else{this.createTextArrow_()}if(this.borderRect_){Blockly.utils.dom.addClass(this.borderRect_,"blocklyDropdownRect")}};Blockly.FieldDropdown.prototype.shouldAddBorderRect_=function(){return!this.getConstants().FIELD_DROPDOWN_NO_BORDER_RECT_SHADOW||this.getConstants().FIELD_DROPDOWN_NO_BORDER_RECT_SHADOW&&!this.sourceBlock_.isShadow()};Blockly.FieldDropdown.prototype.createTextArrow_=function(){this.arrow_=Blockly.utils.dom.createSvgElement("tspan",{},this.textElement_);this.arrow_.appendChild(document.createTextNode(this.sourceBlock_.RTL?Blockly.FieldDropdown.ARROW_CHAR+" ":" "+Blockly.FieldDropdown.ARROW_CHAR));if(this.sourceBlock_.RTL){this.textElement_.insertBefore(this.arrow_,this.textContent_)}else{this.textElement_.appendChild(this.arrow_)}};Blockly.FieldDropdown.prototype.createSVGArrow_=function(){this.svgArrow_=Blockly.utils.dom.createSvgElement("image",{height:this.getConstants().FIELD_DROPDOWN_SVG_ARROW_SIZE+"px",width:this.getConstants().FIELD_DROPDOWN_SVG_ARROW_SIZE+"px"},this.fieldGroup_);this.svgArrow_.setAttributeNS(Blockly.utils.dom.XLINK_NS,"xlink:href",this.getConstants().FIELD_DROPDOWN_SVG_ARROW_DATAURI)};Blockly.FieldDropdown.prototype.showEditor_=function(a){this.menu_=this.dropdownCreate_();if(a&&"number"==typeof a.clientX){this.menu_.openingCoords=new Blockly.utils.Coordinate(a.clientX,a.clientY)}else{this.menu_.openingCoords=null}this.menu_.render(Blockly.DropDownDiv.getContentDiv());var b=this.menu_.getElement();Blockly.utils.dom.addClass(b,"blocklyDropdownMenu");if(this.getConstants().FIELD_DROPDOWN_COLOURED_DIV){var c=this.sourceBlock_.isShadow()?this.sourceBlock_.getParent().getColour():this.sourceBlock_.getColour(),d=this.sourceBlock_.isShadow()?this.sourceBlock_.getParent().style.colourTertiary:this.sourceBlock_.style.colourTertiary;Blockly.DropDownDiv.setColour(c,d)}Blockly.DropDownDiv.showPositionedByField(this,this.dropdownDispose_.bind(this));this.menu_.focus();if(this.selectedMenuItem_){this.menu_.setHighlighted(this.selectedMenuItem_)}this.applyColour()};Blockly.FieldDropdown.prototype.dropdownCreate_=function(){var a=new Blockly.Menu;a.setRole(Blockly.utils.aria.Role.LISTBOX);var b=this.getOptions(!1);this.selectedMenuItem_=null;for(var c=0;c<b.length;c++){var d=b[c][0],e=b[c][1];if("object"==_typeof(d)){var f=new Image(d.width,d.height);f.src=d.src;f.alt=d.alt||"";d=f}var g=new Blockly.MenuItem(d,e);g.setRole(Blockly.utils.aria.Role.OPTION);g.setRightToLeft(this.sourceBlock_.RTL);g.setCheckable(!0);a.addChild(g);g.setChecked(e==this.value_);if(e==this.value_){this.selectedMenuItem_=g}g.onAction(this.handleMenuActionEvent_,this)}return a};Blockly.FieldDropdown.prototype.dropdownDispose_=function(){if(this.menu_){this.menu_.dispose()}this.menu_=null;this.selectedMenuItem_=null;this.applyColour()};Blockly.FieldDropdown.prototype.handleMenuActionEvent_=function(a){Blockly.DropDownDiv.hideIfOwner(this,!0);this.onItemSelected_(this.menu_,a)};Blockly.FieldDropdown.prototype.onItemSelected_=function(a,b){this.setValue(b.getValue())};Blockly.FieldDropdown.prototype.trimOptions_=function(){var a=this.menuGenerator_;if(!Array.isArray(a)){return}for(var b=!1,c=0,d;c<a.length;c++){d=a[c][0];if("string"==typeof d){a[c][0]=Blockly.utils.replaceMessageReferences(d)}else{if(null!=d.alt){a[c][0].alt=Blockly.utils.replaceMessageReferences(d.alt)}b=!0}}if(b||2>a.length){return}for(var e=[],c=0;c<a.length;c++){e.push(a[c][0])}var f=Blockly.utils.string.shortestStringLength(e),g=Blockly.utils.string.commonWordPrefix(e,f),h=Blockly.utils.string.commonWordSuffix(e,f);if(!g&&!h){return}if(f<=g+h){return}if(g){this.prefixField=e[0].substring(0,g-1)}if(h){this.suffixField=e[0].substr(1-h)}this.menuGenerator_=Blockly.FieldDropdown.applyTrim_(a,g,h)};Blockly.FieldDropdown.applyTrim_=function(a,b,c){for(var d=[],e=0;e<a.length;e++){var f=a[e][0],g=a[e][1];f=f.substring(b,f.length-c);d[e]=[f,g]}return d};Blockly.FieldDropdown.prototype.isOptionListDynamic=function(){return"function"==typeof this.menuGenerator_};Blockly.FieldDropdown.prototype.getOptions=function(a){if(this.isOptionListDynamic()){if(!this.generatedOptions_||!a){this.generatedOptions_=this.menuGenerator_.call(this);Blockly.FieldDropdown.validateOptions_(this.generatedOptions_)}return this.generatedOptions_}return this.menuGenerator_};Blockly.FieldDropdown.prototype.doClassValidation_=function(a){for(var b=!1,c=this.getOptions(!0),d=0,e;e=c[d];d++){if(e[1]==a){b=!0;break}}if(!b){if(this.sourceBlock_){console.warn("Cannot set the dropdown's value to an unavailable option. Block type: "+this.sourceBlock_.type+", Field name: "+this.name+", Value: "+a)}return null}return a};Blockly.FieldDropdown.prototype.doValueUpdate_=function(a){Blockly.FieldDropdown.superClass_.doValueUpdate_.call(this,a);for(var b=this.getOptions(!0),c=0,d;d=b[c];c++){if(d[1]==this.value_){this.selectedOption_=d}}};Blockly.FieldDropdown.prototype.applyColour=function(){if(this.borderRect_){this.borderRect_.setAttribute("stroke",this.sourceBlock_.style.colourTertiary);if(this.menu_){this.borderRect_.setAttribute("fill",this.sourceBlock_.style.colourTertiary)}else{this.borderRect_.setAttribute("fill","transparent")}}if(this.sourceBlock_&&this.arrow_){if(this.sourceBlock_.isShadow()){this.arrow_.style.fill=this.sourceBlock_.style.colourSecondary}else{this.arrow_.style.fill=this.sourceBlock_.style.colourPrimary}}};Blockly.FieldDropdown.prototype.render_=function(){this.textContent_.nodeValue="";this.imageElement_.style.display="none";var a=this.selectedOption_&&this.selectedOption_[0];if(a&&"object"==_typeof(a)){this.renderSelectedImage_(a)}else{this.renderSelectedText_()}this.positionBorderRect_()};Blockly.FieldDropdown.prototype.renderSelectedImage_=function(a){this.imageElement_.style.display="";this.imageElement_.setAttributeNS(Blockly.utils.dom.XLINK_NS,"xlink:href",a.src);this.imageElement_.setAttribute("height",a.height);this.imageElement_.setAttribute("width",a.width);var b=+a.height,c=+a.width,d=!!this.borderRect_,e=Math.max(d?this.getConstants().FIELD_DROPDOWN_BORDER_RECT_HEIGHT:0,b+Blockly.FieldDropdown.IMAGE_Y_PADDING),f=d?this.getConstants().FIELD_BORDER_RECT_X_PADDING:0,g=0;if(this.svgArrow_){g=this.positionSVGArrow_(c+f,e/2-this.getConstants().FIELD_DROPDOWN_SVG_ARROW_SIZE/2)}else{g=Blockly.utils.dom.getFastTextWidth(this.arrow_,this.getConstants().FIELD_TEXT_FONTSIZE,this.getConstants().FIELD_TEXT_FONTWEIGHT,this.getConstants().FIELD_TEXT_FONTFAMILY)}this.size_.width=c+g+2*f;this.size_.height=e;var h=0;if(this.sourceBlock_.RTL){var i=f+g;this.imageElement_.setAttribute("x",i)}else{h=c+g;this.textElement_.setAttribute("text-anchor","end");this.imageElement_.setAttribute("x",f)}this.imageElement_.setAttribute("y",e/2-b/2);this.positionTextElement_(h+f,c+g)};Blockly.FieldDropdown.prototype.renderSelectedText_=function(){this.textContent_.nodeValue=this.getDisplayText_();Blockly.utils.dom.addClass(this.textElement_,"blocklyDropdownText");this.textElement_.setAttribute("text-anchor","start");var a=!!this.borderRect_,b=Math.max(a?this.getConstants().FIELD_DROPDOWN_BORDER_RECT_HEIGHT:0,this.getConstants().FIELD_TEXT_HEIGHT),c=Blockly.utils.dom.getFastTextWidth(this.textElement_,this.getConstants().FIELD_TEXT_FONTSIZE,this.getConstants().FIELD_TEXT_FONTWEIGHT,this.getConstants().FIELD_TEXT_FONTFAMILY),d=a?this.getConstants().FIELD_BORDER_RECT_X_PADDING:0,e=0;if(this.svgArrow_){e=this.positionSVGArrow_(c+d,b/2-this.getConstants().FIELD_DROPDOWN_SVG_ARROW_SIZE/2)}this.size_.width=c+e+2*d;this.size_.height=b;this.positionTextElement_(d,c)};Blockly.FieldDropdown.prototype.positionSVGArrow_=function(a,b){if(!this.svgArrow_){return 0}var c=!!this.borderRect_,d=c?this.getConstants().FIELD_BORDER_RECT_X_PADDING:0,e=this.getConstants().FIELD_DROPDOWN_SVG_ARROW_PADDING,f=this.getConstants().FIELD_DROPDOWN_SVG_ARROW_SIZE,g=this.sourceBlock_.RTL?d:a+e;this.svgArrow_.setAttribute("transform","translate("+g+","+b+")");return f+e};Blockly.FieldDropdown.prototype.getText_=function(){if(!this.selectedOption_){return null}var a=this.selectedOption_[0];if("object"==_typeof(a)){return a.alt}return a};Blockly.FieldDropdown.validateOptions_=function(a){if(!Array.isArray(a)){throw TypeError("FieldDropdown options must be an array.")}if(!a.length){throw TypeError("FieldDropdown options must not be an empty array.")}for(var b=!1,c=0,d;c<a.length;++c){d=a[c];if(!Array.isArray(d)){b=!0;console.error("Invalid option["+c+"]: Each FieldDropdown option must be an array. Found: ",d)}else if("string"!=typeof d[1]){b=!0;console.error("Invalid option["+c+"]: Each FieldDropdown option id must be a string. Found "+d[1]+" in: ",d)}else if(d[0]&&"string"!=typeof d[0]&&"string"!=typeof d[0].src){b=!0;console.error("Invalid option["+c+"]: Each FieldDropdown option must have a string label or image description. Found"+d[0]+" in: ",d)}}if(b){throw TypeError("Found invalid FieldDropdown options.")}};Blockly.FieldDropdown.prototype.onBlocklyAction=function(a){if(this.menu_){if(a===Blockly.navigation.ACTION_PREVIOUS){this.menu_.highlightPrevious();return!0}else if(a===Blockly.navigation.ACTION_NEXT){this.menu_.highlightNext();return!0}}return Blockly.FieldDropdown.superClass_.onBlocklyAction.call(this,a)};Blockly.fieldRegistry.register("field_dropdown",Blockly.FieldDropdown);
//# sourceMappingURL=field_dropdown.min.js.map
