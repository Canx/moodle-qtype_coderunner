'use strict';goog.provide("Blockly.Blocks.procedures");goog.require("Blockly");goog.require("Blockly.Blocks");goog.require("Blockly.Comment");goog.require("Blockly.FieldCheckbox");goog.require("Blockly.FieldLabel");goog.require("Blockly.FieldTextInput");goog.require("Blockly.Mutator");goog.require("Blockly.Warning");Blockly.Blocks.procedures_defnoreturn={init:function init(){var a=new Blockly.FieldTextInput("",Blockly.Procedures.rename);a.setSpellcheck(!1);this.appendDummyInput().appendField(Blockly.Msg.PROCEDURES_DEFNORETURN_TITLE).appendField(a,"NAME").appendField("","PARAMS");this.setMutator(new Blockly.Mutator(["procedures_mutatorarg"]));if((this.workspace.options.comments||this.workspace.options.parentWorkspace&&this.workspace.options.parentWorkspace.options.comments)&&Blockly.Msg.PROCEDURES_DEFNORETURN_COMMENT){this.setCommentText(Blockly.Msg.PROCEDURES_DEFNORETURN_COMMENT)}this.setStyle("procedure_blocks");this.setTooltip(Blockly.Msg.PROCEDURES_DEFNORETURN_TOOLTIP);this.setHelpUrl(Blockly.Msg.PROCEDURES_DEFNORETURN_HELPURL);this.arguments_=[];this.argumentVarModels_=[];this.setStatements_(!0);this.statementConnection_=null},setStatements_:function setStatements_(a){if(this.hasStatements_===a){return}if(a){this.appendStatementInput("STACK").appendField(Blockly.Msg.PROCEDURES_DEFNORETURN_DO);if(this.getInput("RETURN")){this.moveInputBefore("STACK","RETURN")}}else{this.removeInput("STACK",!0)}this.hasStatements_=a},updateParams_:function updateParams_(){var a="";if(this.arguments_.length){a=Blockly.Msg.PROCEDURES_BEFORE_PARAMS+" "+this.arguments_.join(", ")}Blockly.Events.disable();try{this.setFieldValue(a,"PARAMS")}finally{Blockly.Events.enable()}},mutationToDom:function mutationToDom(a){var b=Blockly.utils.xml.createElement("mutation");if(a){b.setAttribute("name",this.getFieldValue("NAME"))}for(var c=0;c<this.argumentVarModels_.length;c++){var d=Blockly.utils.xml.createElement("arg"),e=this.argumentVarModels_[c];d.setAttribute("name",e.name);d.setAttribute("varid",e.getId());if(a&&this.paramIds_){d.setAttribute("paramId",this.paramIds_[c])}b.appendChild(d)}if(!this.hasStatements_){b.setAttribute("statements","false")}return b},domToMutation:function domToMutation(a){this.arguments_=[];this.argumentVarModels_=[];for(var b=0,c;c=a.childNodes[b];b++){if("arg"==c.nodeName.toLowerCase()){var d=c.getAttribute("name"),e=c.getAttribute("varid")||c.getAttribute("varId");this.arguments_.push(d);var f=Blockly.Variables.getOrCreateVariablePackage(this.workspace,e,d,"");if(null!=f){this.argumentVarModels_.push(f)}else{console.log("Failed to create a variable with name "+d+", ignoring.")}}}this.updateParams_();Blockly.Procedures.mutateCallers(this);this.setStatements_("false"!==a.getAttribute("statements"))},decompose:function decompose(a){var b=Blockly.utils.xml.createElement("block");b.setAttribute("type","procedures_mutatorcontainer");var c=Blockly.utils.xml.createElement("statement");c.setAttribute("name","STACK");b.appendChild(c);for(var d=c,e=0,f;e<this.arguments_.length;e++){f=Blockly.utils.xml.createElement("block");f.setAttribute("type","procedures_mutatorarg");var g=Blockly.utils.xml.createElement("field");g.setAttribute("name","NAME");var h=Blockly.utils.xml.createTextNode(this.arguments_[e]);g.appendChild(h);f.appendChild(g);var j=Blockly.utils.xml.createElement("next");f.appendChild(j);d.appendChild(f);d=j}var k=Blockly.Xml.domToBlock(b,a);if("procedures_defreturn"==this.type){k.setFieldValue(this.hasStatements_,"STATEMENTS")}else{k.removeInput("STATEMENT_INPUT")}Blockly.Procedures.mutateCallers(this);return k},compose:function compose(a){this.arguments_=[];this.paramIds_=[];this.argumentVarModels_=[];var b=a.getInputTargetBlock("STACK");while(b){var c=b.getFieldValue("NAME");this.arguments_.push(c);var d=this.workspace.getVariable(c,"");this.argumentVarModels_.push(d);this.paramIds_.push(b.id);b=b.nextConnection&&b.nextConnection.targetBlock()}this.updateParams_();Blockly.Procedures.mutateCallers(this);var e=a.getFieldValue("STATEMENTS");if(null!==e){e="TRUE"==e;if(this.hasStatements_!=e){if(e){this.setStatements_(!0);Blockly.Mutator.reconnect(this.statementConnection_,this,"STACK");this.statementConnection_=null}else{var f=this.getInput("STACK").connection;this.statementConnection_=f.targetConnection;if(this.statementConnection_){var g=f.targetBlock();g.unplug();g.bumpNeighbours()}this.setStatements_(!1)}}}},getProcedureDef:function getProcedureDef(){return[this.getFieldValue("NAME"),this.arguments_,!1]},getVars:function getVars(){return this.arguments_},getVarModels:function getVarModels(){return this.argumentVarModels_},renameVarById:function renameVarById(a,b){var c=this.workspace.getVariableById(a);if(""!=c.type){return}for(var d=c.name,e=this.workspace.getVariableById(b),f=!1,g=0;g<this.argumentVarModels_.length;g++){if(this.argumentVarModels_[g].getId()==a){this.arguments_[g]=e.name;this.argumentVarModels_[g]=e;f=!0}}if(f){this.displayRenamedVar_(d,e.name);Blockly.Procedures.mutateCallers(this)}},updateVarName:function updateVarName(a){for(var b=a.name,c=!1,d=0;d<this.argumentVarModels_.length;d++){if(this.argumentVarModels_[d].getId()==a.getId()){var e=this.arguments_[d];this.arguments_[d]=b;c=!0}}if(c){this.displayRenamedVar_(e,b);Blockly.Procedures.mutateCallers(this)}},displayRenamedVar_:function displayRenamedVar_(a,b){this.updateParams_();if(this.mutator&&this.mutator.isVisible()){for(var c=this.mutator.workspace_.getAllBlocks(!1),d=0,e;e=c[d];d++){if("procedures_mutatorarg"==e.type&&Blockly.Names.equals(a,e.getFieldValue("NAME"))){e.setFieldValue(b,"NAME")}}}},customContextMenu:function customContextMenu(a){if(this.isInFlyout){return}var b={enabled:!0},c=this.getFieldValue("NAME");b.text=Blockly.Msg.PROCEDURES_CREATE_DO.replace("%1",c);var d=Blockly.utils.xml.createElement("mutation");d.setAttribute("name",c);for(var e=0,f;e<this.arguments_.length;e++){f=Blockly.utils.xml.createElement("arg");f.setAttribute("name",this.arguments_[e]);d.appendChild(f)}var g=Blockly.utils.xml.createElement("block");g.setAttribute("type",this.callType_);g.appendChild(d);b.callback=Blockly.ContextMenu.callbackFactory(this,g);a.push(b);if(!this.isCollapsed()){for(var e=0;e<this.argumentVarModels_.length;e++){var h={enabled:!0},j=this.argumentVarModels_[e];h.text=Blockly.Msg.VARIABLES_SET_CREATE_GET.replace("%1",j.name);var k=Blockly.Variables.generateVariableFieldDom(j),l=Blockly.utils.xml.createElement("block");l.setAttribute("type","variables_get");l.appendChild(k);h.callback=Blockly.ContextMenu.callbackFactory(this,l);a.push(h)}}},callType_:"procedures_callnoreturn"};Blockly.Blocks.procedures_defreturn={init:function init(){var a=new Blockly.FieldTextInput("",Blockly.Procedures.rename);a.setSpellcheck(!1);this.appendDummyInput().appendField(Blockly.Msg.PROCEDURES_DEFRETURN_TITLE).appendField(a,"NAME").appendField("","PARAMS");this.appendValueInput("RETURN").setAlign(Blockly.ALIGN_RIGHT).appendField(Blockly.Msg.PROCEDURES_DEFRETURN_RETURN);this.setMutator(new Blockly.Mutator(["procedures_mutatorarg"]));if((this.workspace.options.comments||this.workspace.options.parentWorkspace&&this.workspace.options.parentWorkspace.options.comments)&&Blockly.Msg.PROCEDURES_DEFRETURN_COMMENT){this.setCommentText(Blockly.Msg.PROCEDURES_DEFRETURN_COMMENT)}this.setStyle("procedure_blocks");this.setTooltip(Blockly.Msg.PROCEDURES_DEFRETURN_TOOLTIP);this.setHelpUrl(Blockly.Msg.PROCEDURES_DEFRETURN_HELPURL);this.arguments_=[];this.argumentVarModels_=[];this.setStatements_(!0);this.statementConnection_=null},setStatements_:Blockly.Blocks.procedures_defnoreturn.setStatements_,updateParams_:Blockly.Blocks.procedures_defnoreturn.updateParams_,mutationToDom:Blockly.Blocks.procedures_defnoreturn.mutationToDom,domToMutation:Blockly.Blocks.procedures_defnoreturn.domToMutation,decompose:Blockly.Blocks.procedures_defnoreturn.decompose,compose:Blockly.Blocks.procedures_defnoreturn.compose,getProcedureDef:function getProcedureDef(){return[this.getFieldValue("NAME"),this.arguments_,!0]},getVars:Blockly.Blocks.procedures_defnoreturn.getVars,getVarModels:Blockly.Blocks.procedures_defnoreturn.getVarModels,renameVarById:Blockly.Blocks.procedures_defnoreturn.renameVarById,updateVarName:Blockly.Blocks.procedures_defnoreturn.updateVarName,displayRenamedVar_:Blockly.Blocks.procedures_defnoreturn.displayRenamedVar_,customContextMenu:Blockly.Blocks.procedures_defnoreturn.customContextMenu,callType_:"procedures_callreturn"};Blockly.Blocks.procedures_mutatorcontainer={init:function init(){this.appendDummyInput().appendField(Blockly.Msg.PROCEDURES_MUTATORCONTAINER_TITLE);this.appendStatementInput("STACK");this.appendDummyInput("STATEMENT_INPUT").appendField(Blockly.Msg.PROCEDURES_ALLOW_STATEMENTS).appendField(new Blockly.FieldCheckbox("TRUE"),"STATEMENTS");this.setStyle("procedure_blocks");this.setTooltip(Blockly.Msg.PROCEDURES_MUTATORCONTAINER_TOOLTIP);this.contextMenu=!1}};Blockly.Blocks.procedures_mutatorarg={init:function init(){var a=new Blockly.FieldTextInput(Blockly.Procedures.DEFAULT_ARG,this.validator_);a.oldShowEditorFn_=a.showEditor_;a.showEditor_=function newShowEditorFn(){this.createdVariables_=[];this.oldShowEditorFn_()};this.appendDummyInput().appendField(Blockly.Msg.PROCEDURES_MUTATORARG_TITLE).appendField(a,"NAME");this.setPreviousStatement(!0);this.setNextStatement(!0);this.setStyle("procedure_blocks");this.setTooltip(Blockly.Msg.PROCEDURES_MUTATORARG_TOOLTIP);this.contextMenu=!1;a.onFinishEditing_=this.deleteIntermediateVars_;a.createdVariables_=[];a.onFinishEditing_("x")},validator_:function validator_(a){var b=this.getSourceBlock(),c=Blockly.Mutator.findParentWs(b.workspace);a=a.replace(/[\s\xa0]+/g," ").replace(/^ | $/g,"");if(!a){return null}for(var d=b.workspace.targetWorkspace||b.workspace,e=d.getAllBlocks(!1),f=a.toLowerCase(),g=0;g<e.length;g++){if(e[g].id==this.getSourceBlock().id){continue}var h=e[g].getFieldValue("NAME");if(h&&h.toLowerCase()==f){return null}}if(b.isInFlyout){return a}var j=c.getVariable(a,"");if(j&&j.name!=a){c.renameVariableById(j.getId(),a)}if(!j){j=c.createVariable(a,"");if(j&&this.createdVariables_){this.createdVariables_.push(j)}}return a},deleteIntermediateVars_:function deleteIntermediateVars_(a){var b=Blockly.Mutator.findParentWs(this.getSourceBlock().workspace);if(!b){return}for(var c=0,d;c<this.createdVariables_.length;c++){d=this.createdVariables_[c];if(d.name!=a){b.deleteVariableById(d.getId())}}}};Blockly.Blocks.procedures_callnoreturn={init:function init(){this.appendDummyInput("TOPROW").appendField(this.id,"NAME");this.setPreviousStatement(!0);this.setNextStatement(!0);this.setStyle("procedure_blocks");this.setHelpUrl(Blockly.Msg.PROCEDURES_CALLNORETURN_HELPURL);this.arguments_=[];this.argumentVarModels_=[];this.quarkConnections_={};this.quarkIds_=null;this.previousEnabledState_=!0},getProcedureCall:function getProcedureCall(){return this.getFieldValue("NAME")},renameProcedure:function renameProcedure(a,b){if(Blockly.Names.equals(a,this.getProcedureCall())){this.setFieldValue(b,"NAME");var c=this.outputConnection?Blockly.Msg.PROCEDURES_CALLRETURN_TOOLTIP:Blockly.Msg.PROCEDURES_CALLNORETURN_TOOLTIP;this.setTooltip(c.replace("%1",b))}},setProcedureParameters_:function setProcedureParameters_(a,b){var c=Blockly.Procedures.getDefinition(this.getProcedureCall(),this.workspace),d=c&&c.mutator&&c.mutator.isVisible();if(!d){this.quarkConnections_={};this.quarkIds_=null}if(!b){return}if(a.join("\n")==this.arguments_.join("\n")){this.quarkIds_=b;return}if(b.length!=a.length){throw RangeError("paramNames and paramIds must be the same length.")}this.setCollapsed(!1);if(!this.quarkIds_){this.quarkConnections_={};this.quarkIds_=[]}var e=this.rendered;this.rendered=!1;for(var f=0,g;f<this.arguments_.length;f++){g=this.getInput("ARG"+f);if(g){var h=g.connection.targetConnection;this.quarkConnections_[this.quarkIds_[f]]=h;if(d&&h&&-1==b.indexOf(this.quarkIds_[f])){h.disconnect();h.getSourceBlock().bumpNeighbours()}}}this.arguments_=[].concat(a);this.argumentVarModels_=[];for(var f=0,j;f<this.arguments_.length;f++){j=Blockly.Variables.getOrCreateVariablePackage(this.workspace,null,this.arguments_[f],"");this.argumentVarModels_.push(j)}this.updateShape_();this.quarkIds_=b;if(this.quarkIds_){for(var f=0,k;f<this.arguments_.length;f++){k=this.quarkIds_[f];if(k in this.quarkConnections_){var h=this.quarkConnections_[k];if(!Blockly.Mutator.reconnect(h,this,"ARG"+f)){delete this.quarkConnections_[k]}}}}this.rendered=e;if(this.rendered){this.render()}},updateShape_:function updateShape_(){for(var a=0,b;a<this.arguments_.length;a++){b=this.getField("ARGNAME"+a);if(b){Blockly.Events.disable();try{b.setValue(this.arguments_[a])}finally{Blockly.Events.enable()}}else{b=new Blockly.FieldLabel(this.arguments_[a]);var c=this.appendValueInput("ARG"+a).setAlign(Blockly.ALIGN_RIGHT).appendField(b,"ARGNAME"+a);c.init()}}while(this.getInput("ARG"+a)){this.removeInput("ARG"+a);a++}var d=this.getInput("TOPROW");if(d){if(this.arguments_.length){if(!this.getField("WITH")){d.appendField(Blockly.Msg.PROCEDURES_CALL_BEFORE_PARAMS,"WITH");d.init()}}else{if(this.getField("WITH")){d.removeField("WITH")}}}},mutationToDom:function mutationToDom(){var a=Blockly.utils.xml.createElement("mutation");a.setAttribute("name",this.getProcedureCall());for(var b=0,c;b<this.arguments_.length;b++){c=Blockly.utils.xml.createElement("arg");c.setAttribute("name",this.arguments_[b]);a.appendChild(c)}return a},domToMutation:function domToMutation(a){var b=a.getAttribute("name");this.renameProcedure(this.getProcedureCall(),b);for(var c=[],d=[],e=0,f;f=a.childNodes[e];e++){if("arg"==f.nodeName.toLowerCase()){c.push(f.getAttribute("name"));d.push(f.getAttribute("paramId"))}}this.setProcedureParameters_(c,d)},getVars:function getVars(){return this.arguments_},getVarModels:function getVarModels(){return this.argumentVarModels_},onchange:function onchange(a){if(!this.workspace||this.workspace.isFlyout){return}if(!a.recordUndo){return}if(a.type==Blockly.Events.BLOCK_CREATE&&-1!=a.ids.indexOf(this.id)){var b=this.getProcedureCall(),c=Blockly.Procedures.getDefinition(b,this.workspace);if(c&&(c.type!=this.defType_||JSON.stringify(c.getVars())!=JSON.stringify(this.arguments_))){c=null}if(!c){Blockly.Events.setGroup(a.group);var d=Blockly.utils.xml.createElement("xml"),e=Blockly.utils.xml.createElement("block");e.setAttribute("type",this.defType_);var f=this.getRelativeToSurfaceXY(),g=f.x+Blockly.SNAP_RADIUS*(this.RTL?-1:1),h=f.y+2*Blockly.SNAP_RADIUS;e.setAttribute("x",g);e.setAttribute("y",h);var i=this.mutationToDom();e.appendChild(i);var j=Blockly.utils.xml.createElement("field");j.setAttribute("name","NAME");j.appendChild(Blockly.utils.xml.createTextNode(this.getProcedureCall()));e.appendChild(j);d.appendChild(e);Blockly.Xml.domToWorkspace(d,this.workspace);Blockly.Events.setGroup(!1)}}else if(a.type==Blockly.Events.BLOCK_DELETE){var b=this.getProcedureCall(),c=Blockly.Procedures.getDefinition(b,this.workspace);if(!c){Blockly.Events.setGroup(a.group);this.dispose(!0);Blockly.Events.setGroup(!1)}}else if(a.type==Blockly.Events.CHANGE&&"disabled"==a.element){var b=this.getProcedureCall(),c=Blockly.Procedures.getDefinition(b,this.workspace);if(c&&c.id==a.blockId){var k=Blockly.Events.getGroup();if(k){console.log("Saw an existing group while responding to a definition change")}Blockly.Events.setGroup(a.group);if(a.newValue){this.previousEnabledState_=this.isEnabled();this.setEnabled(!1)}else{this.setEnabled(this.previousEnabledState_)}Blockly.Events.setGroup(k)}}},customContextMenu:function customContextMenu(a){if(!this.workspace.isMovable()){return}var b={enabled:!0,text:Blockly.Msg.PROCEDURES_HIGHLIGHT_DEF},c=this.getProcedureCall(),d=this.workspace;b.callback=function(){var a=Blockly.Procedures.getDefinition(c,d);if(a){d.centerOnBlock(a.id);a.select()}};a.push(b)},defType_:"procedures_defnoreturn"};Blockly.Blocks.procedures_callreturn={init:function init(){this.appendDummyInput("TOPROW").appendField("","NAME");this.setOutput(!0);this.setStyle("procedure_blocks");this.setHelpUrl(Blockly.Msg.PROCEDURES_CALLRETURN_HELPURL);this.arguments_=[];this.quarkConnections_={};this.quarkIds_=null;this.previousEnabledState_=!0},getProcedureCall:Blockly.Blocks.procedures_callnoreturn.getProcedureCall,renameProcedure:Blockly.Blocks.procedures_callnoreturn.renameProcedure,setProcedureParameters_:Blockly.Blocks.procedures_callnoreturn.setProcedureParameters_,updateShape_:Blockly.Blocks.procedures_callnoreturn.updateShape_,mutationToDom:Blockly.Blocks.procedures_callnoreturn.mutationToDom,domToMutation:Blockly.Blocks.procedures_callnoreturn.domToMutation,getVars:Blockly.Blocks.procedures_callnoreturn.getVars,getVarModels:Blockly.Blocks.procedures_callnoreturn.getVarModels,onchange:Blockly.Blocks.procedures_callnoreturn.onchange,customContextMenu:Blockly.Blocks.procedures_callnoreturn.customContextMenu,defType_:"procedures_defreturn"};Blockly.Blocks.procedures_ifreturn={init:function init(){this.appendValueInput("CONDITION").setCheck("Boolean").appendField(Blockly.Msg.CONTROLS_IF_MSG_IF);this.appendValueInput("VALUE").appendField(Blockly.Msg.PROCEDURES_DEFRETURN_RETURN);this.setInputsInline(!0);this.setPreviousStatement(!0);this.setNextStatement(!0);this.setStyle("procedure_blocks");this.setTooltip(Blockly.Msg.PROCEDURES_IFRETURN_TOOLTIP);this.setHelpUrl(Blockly.Msg.PROCEDURES_IFRETURN_HELPURL);this.hasReturnValue_=!0},mutationToDom:function mutationToDom(){var a=Blockly.utils.xml.createElement("mutation");a.setAttribute("value",+this.hasReturnValue_);return a},domToMutation:function domToMutation(a){var b=a.getAttribute("value");this.hasReturnValue_=1==b;if(!this.hasReturnValue_){this.removeInput("VALUE");this.appendDummyInput("VALUE").appendField(Blockly.Msg.PROCEDURES_DEFRETURN_RETURN)}},onchange:function onchange(){if(!this.workspace.isDragging||this.workspace.isDragging()){return}var a=!1,b=this;do{if(-1!=this.FUNCTION_TYPES.indexOf(b.type)){a=!0;break}b=b.getSurroundParent()}while(b);if(a){if("procedures_defnoreturn"==b.type&&this.hasReturnValue_){this.removeInput("VALUE");this.appendDummyInput("VALUE").appendField(Blockly.Msg.PROCEDURES_DEFRETURN_RETURN);this.hasReturnValue_=!1}else if("procedures_defreturn"==b.type&&!this.hasReturnValue_){this.removeInput("VALUE");this.appendValueInput("VALUE").appendField(Blockly.Msg.PROCEDURES_DEFRETURN_RETURN);this.hasReturnValue_=!0}this.setWarningText(null);if(!this.isInFlyout){this.setEnabled(!0)}}else{this.setWarningText(Blockly.Msg.PROCEDURES_IFRETURN_WARNING);if(!this.isInFlyout&&!this.getInheritedDisabled()){this.setEnabled(!1)}}},FUNCTION_TYPES:["procedures_defnoreturn","procedures_defreturn"]};
//# sourceMappingURL=procedures.min.js.map
