define(["jquery","qtype_coderunner/graphutil","qtype_coderunner/graphelements"],function(a,b,c){function d(b,c,d,e){this.HANDLE_SIZE=10,this.parent=b,this.canvas=a(document.createElement("canvas")),this.canvas.attr({id:c,"class":"coderunner_graphcanvas",tabindex:1}),this.canvas.css({"background-color":"white"}),this.canvas.on("mousedown",function(a){return b.mousedown(a)}),this.canvas.on("mouseup",function(a){return b.mouseup(a)}),this.canvas.on("dblclick",function(a){return b.dblclick(a)}),this.canvas.on("keydown",function(a){return b.keydown(a)}),this.canvas.on("mousemove",function(a){return b.mousemove(a)}),this.canvas.on("keypress",function(a){return b.keypress(a)}),this.resize=function(a,b){this.canvas.attr("width",a),this.canvas.attr("height",b)},this.resize(d,e)}function e(b,e,f,g){var h=this;this.SNAP_TO_PADDING=6,this.DUPLICATE_LINK_OFFSET=16,this.HIT_TARGET_PADDING=6,this.DEFAULT_NODE_RADIUS=26,this.DEFAULT_FONT_SIZE=20,this.DEFAULT_TEXT_OFFSET=5,this.DEFAULT_LINK_LABEL_REL_DIST=.5,this.MAX_VERSIONS=30,this.canvasId="graphcanvas_"+b,this.textArea=a(document.getElementById(b)),this.helpText="",this.readOnly=this.textArea.prop("readonly"),this.templateParams=g,this.graphCanvas=new d(this,this.canvasId,e,f),this.caretVisible=!0,this.caretTimer=0,this.originalClick=null,this.nodes=[],this.links=[],this.selectedObject=null,this.currentLink=null,this.movingObject=!1,this.fail=!1,this.failString=null,this.versions=[],this.versionIndex=-1,this.helpBox=new c.HelpBox(this,0,0),this.clearButton=new c.Button(this,60,0,"Clear"),this.clearButton.onClick=function(){confirm("Are you sure you want to clear the diagram?")&&this.parent.clear()},this.buttons=[this.helpBox,this.clearButton],"locknodes"in g&&(g.locknodepositions=g.locknodes),"lockedges"in g&&(g.lockedgepositions=g.lockedges),"helpmenutext"in g?this.helpText=g.helpmenutext:require(["core/str"],function(b){var c=b.get_string("graphhelp","qtype_coderunner");a.when(c).done(function(a){h.helpText=a})}),this.reload(),this.fail||this.draw()}return e.prototype.failed=function(){return this.fail},e.prototype.failMessage=function(){return this.failString},e.prototype.getElement=function(){return this.getCanvas()},e.prototype.hasFocus=function(){return document.activeElement==this.getCanvas()},e.prototype.getCanvas=function(){var a=this.graphCanvas.canvas[0];return a},e.prototype.nodeRadius=function(){return this.templateParams.noderadius?this.templateParams.noderadius:this.DEFAULT_NODE_RADIUS},e.prototype.fontSize=function(){return this.templateParams.fontsize?this.templateParams.fontsize:this.DEFAULT_FONT_SIZE},e.prototype.isFsm=function(){return void 0===this.templateParams.isfsm||this.templateParams.isfsm},e.prototype.textOffset=function(){return this.templateParams.textoffset?this.templateParams.textoffset:this.DEFAULT_TEXT_OFFSET},e.prototype.arrowIfReqd=function(a,c,d,e){(void 0===this.templateParams.isdirected||this.templateParams.isdirected)&&b.drawArrow(a,c,d,e)},e.prototype.sync=function(){},e.prototype.keypress=function(a){var c=b.crossBrowserKey(a);if(!this.readOnly)return c>=32&&c<=126&&!a.metaKey&&!a.altKey&&!a.ctrlKey&&37!==c&&39!==c&&null!==this.selectedObject&&this.canEditText()?(this.selectedObject.justMoved&&this.saveVersion(),this.selectedObject.justMoved=!1,this.selectedObject.textBox.insertChar(String.fromCharCode(c)),this.resetCaret(),this.draw(),!1):8!==c&&32!==c&&9!==c&&void 0},e.prototype.mousedown=function(a){var d=b.crossBrowserRelativeMousePos(a);if(!this.readOnly){if(this.selectedObject=this.selectObject(d.x,d.y),this.movingObject=!1,this.movingGraph=!1,this.movingText=!1,this.originalClick=d,this.saveVersion(),this.selectedObject!==this.helpBox&&(this.helpBox.helpOpen=!1),null!==this.selectedObject){if(this.selectedObject instanceof c.Button)this.selectedObject.onClick();else if(a.shiftKey&&this.selectedObject instanceof c.Node)this.templateParams.lockedgeset||(this.currentLink=new c.SelfLink(this,this.selectedObject,d));else if(a.altKey&&this.selectedObject instanceof c.Node){if(!this.templateParams.locknodepositions){this.movingGraph=!0,this.movingNodes=this.selectedObject.traverseGraph(this.links,[]);for(var e=0;e<this.movingNodes.length;e++)this.movingNodes[e].setMouseStart(d.x,d.y)}}else this.selectedObject instanceof c.TextBox?this.templateParams.lockedgelabels||(this.movingText=!0,this.selectedObject.setMouseStart(d.x,d.y),this.selectedObject=this.selectedObject.parent):this.templateParams.locknodepositions&&this.selectedObject instanceof c.Node||this.templateParams.lockedgepositions&&this.selectedObject instanceof c.Link||(this.movingObject=!0,this.selectedObject.setMouseStart&&this.selectedObject.setMouseStart(d.x,d.y));this.selectedObject.justMoved=!0,this.resetCaret()}else a.shiftKey&&this.isFsm()&&(this.currentLink=new c.TemporaryLink(this,d,d));return this.draw(),!this.hasFocus()&&(this.resetCaret(),!0)}},e.prototype.canEditText=function(){var a=this.selectedObject instanceof c.Node,b=this.selectedObject instanceof c.Link||this.selectedObject instanceof c.SelfLink;return"textBox"in this.selectedObject&&(a&&!this.templateParams.locknodelabels||b&&!this.templateParams.lockedgelabels)},e.prototype.keydown=function(a){var c,d=b.crossBrowserKey(a),e=!1;if(!this.readOnly){if(8===d)return null!==this.selectedObject&&this.canEditText()&&(this.selectedObject.textBox.deleteChar(),this.resetCaret(),this.draw()),!1;if(46===d&&null!==this.selectedObject){for(this.saveVersion(),c=0;c<this.nodes.length;c++)this.nodes[c]!==this.selectedObject||this.templateParams.locknodeset||(this.nodes.splice(c--,1),e=!0);for(c=0;c<this.links.length;c++)(this.links[c]===this.selectedObject&&!this.templateParams.lockedgeset||e&&(this.links[c].node===this.selectedObject||this.links[c].nodeA===this.selectedObject||this.links[c].nodeB===this.selectedObject))&&this.links.splice(c--,1);this.selectedObject=null,this.draw()}else 13===d?null!==this.selectedObject&&(this.selectedObject=null,this.draw()):37===d?null!==this.selectedObject&&this.canEditText()&&(this.selectedObject.textBox.caretLeft(),this.resetCaret(),this.draw()):39===d?null!==this.selectedObject&&this.canEditText()&&(this.selectedObject.textBox.caretRight(),this.resetCaret(),this.draw()):90==a.keyCode&&a.ctrlKey&&a.shiftKey||89==a.keyCode&&a.ctrlKey?this.redo():90==a.keyCode&&a.ctrlKey&&this.undo()}},e.prototype.dblclick=function(a){var d=b.crossBrowserRelativeMousePos(a);this.readOnly||this.templateParams.locknodeset||(this.selectedObject=this.selectObject(d.x,d.y),this.saveVersion(),null===this.selectedObject?(this.selectedObject=new c.Node(this,d.x,d.y),this.nodes.push(this.selectedObject),this.selectedObject.justMoved=!0,this.resetCaret(),this.draw()):this.selectedObject instanceof c.Node&&this.isFsm()&&(this.selectedObject.isAcceptState=!this.selectedObject.isAcceptState,this.draw()))},e.prototype.resize=function(a,b){this.graphCanvas.resize(a,b),this.draw()},e.prototype.mousemove=function(a){var d,e=b.crossBrowserRelativeMousePos(a);if(!this.readOnly){for(h=0;h<this.buttons.length;h++)this.buttons[h].containsPoint(e.x,e.y)?this.buttons[h].highLighted=!0:this.buttons[h].highLighted=!1,this.draw();if(null!==this.currentLink){var f=this.selectObject(e.x,e.y);f instanceof c.Node||(f=null),null===this.selectedObject?null!==f?this.currentLink=new c.StartLink(this,f,this.originalClick):this.currentLink=new c.TemporaryLink(this,this.originalClick,e):f===this.selectedObject?this.currentLink=new c.SelfLink(this,this.selectedObject,e):null!==f?this.currentLink=new c.Link(this,this.selectedObject,f):(d=this.selectedObject.closestPointOnCircle(e.x,e.y),this.currentLink=new c.TemporaryLink(this,d,e)),this.draw()}if(this.movingGraph){for(var g=this.movingNodes,h=0;h<g.length;h++)g[h].trackMouse(e.x,e.y),this.snapNode(g[h]);this.draw()}else this.movingText?(this.selectedObject.textBox.setAnchorPoint(e.x,e.y),this.draw()):this.movingObject&&(this.selectedObject.setAnchorPoint(e.x,e.y),this.selectedObject instanceof c.Node&&this.snapNode(this.selectedObject),this.draw())}},e.prototype.mouseup=function(){this.readOnly||(this.movingObject=!1,this.movingGraph=!1,this.movingText=!1,null!==this.currentLink&&(this.currentLink instanceof c.TemporaryLink||(this.selectedObject=this.currentLink,this.addLink(this.currentLink),this.resetCaret()),this.currentLink=null,this.draw()))},e.prototype.selectObject=function(a,b){for(c=0;c<this.buttons.length;c++)if(this.buttons[c].containsPoint(a,b))return this.buttons[c];var c;for(c=0;c<this.nodes.length;c++)if(this.nodes[c].containsPoint(a,b))return this.nodes[c];for(c=0;c<this.links.length;c++){if(this.links[c].containsPoint(a,b))return this.links[c];if("textBox"in this.links[c]&&this.links[c].textBox.containsPoint(a,b))return this.links[c].textBox}return null},e.prototype.snapNode=function(a){for(var b=0;b<this.nodes.length;b++)this.nodes[b]!==a&&(Math.abs(a.x-this.nodes[b].x)<this.SNAP_TO_PADDING&&(a.x=this.nodes[b].x),Math.abs(a.y-this.nodes[b].y)<this.SNAP_TO_PADDING&&(a.y=this.nodes[b].y))},e.prototype.addLink=function(a){for(var b=null,c=0;c<this.links.length;c++){var d=this.links[c];d.nodeA===a.nodeA&&d.nodeB===a.nodeB&&(null===b||d.perpendicularPart>b)&&(b=d.perpendicularPart),d.nodeA===a.nodeB&&d.nodeB===a.nodeA&&(null===b||-d.perpendicularPart>b)&&(b=-d.perpendicularPart)}null!==b&&(a.perpendicularPart=b+this.DUPLICATE_LINK_OFFSET),this.links.push(a)},e.prototype.reload=function(){var b=a(this.textArea).val();if(b)try{var d,e=JSON.parse(b);for(d=0;d<e.nodes.length;d++){var f=e.nodes[d],g=e.nodeGeometry[d],h=new c.Node(this,g[0],g[1]);h.isAcceptState=f[1],h.textBox=new c.TextBox(f[0].toString(),h),this.nodes.push(h)}for(d=0;d<e.edges.length;d++){var i=e.edges[d],j=e.edgeGeometry[d],k=null;i[0]===i[1]?(k=new c.SelfLink(this,this.nodes[i[0]]),k.anchorAngle=j.anchorAngle,k.textBox=new c.TextBox(i[2].toString(),k),i.length>3&&k.textBox.setAnchorPoint(i[3].x,i[3].y)):i[0]===-1?(k=new c.StartLink(this,this.nodes[i[1]]),k.deltaX=j.deltaX,k.deltaY=j.deltaY):(k=new c.Link(this,this.nodes[i[0]],this.nodes[i[1]]),k.parallelPart=j.parallelPart,k.perpendicularPart=j.perpendicularPart,k.lineAngleAdjust=j.lineAngleAdjust,k.textBox=new c.TextBox(i[2].toString(),k),i.length>3&&k.textBox.setAnchorPoint(i[3].x,i[3].y)),null!==k&&this.links.push(k)}}catch(l){this.fail=!0,this.failString="graph_ui_invalidserialisation"}},e.prototype.save=function(){var a,b={edgeGeometry:[],nodeGeometry:[],nodes:[],edges:[]};if(JSON&&(""!==this.textArea.val().trim()||0!==this.nodes.length)){for(a=0;a<this.nodes.length;a++){var d=this.nodes[a],e=[d.textBox.text,d.isAcceptState],f=[d.x,d.y];b.nodeGeometry.push(f),b.nodes.push(e)}for(a=0;a<this.links.length;a++){var g=this.links[a],h=null,i=null;g instanceof c.SelfLink?(i={anchorAngle:g.anchorAngle},h=[this.nodes.indexOf(g.node),this.nodes.indexOf(g.node),g.textBox.text],g.textBox.dragged&&h.push(g.textBox.position)):g instanceof c.StartLink?(i={deltaX:g.deltaX,deltaY:g.deltaY},h=[-1,this.nodes.indexOf(g.node),""]):g instanceof c.Link&&(i={lineAngleAdjust:g.lineAngleAdjust,parallelPart:g.parallelPart,perpendicularPart:g.perpendicularPart},h=[this.nodes.indexOf(g.nodeA),this.nodes.indexOf(g.nodeB),g.textBox.text],g.textBox.dragged&&h.push(g.textBox.position)),null!==h&&null!==i&&(b.edges.push(h),b.edgeGeometry.push(i))}this.textArea.val(JSON.stringify(b))}},e.prototype.saveVersion=function(){var a=this.textArea.val();if(0==this.versions.length||0!=a.localeCompare(this.versions[this.versionIndex])){for(this.versionIndex++;this.versionIndex<this.versions.length;)this.versions.pop();this.versions.push(a),this.versions.length>this.MAX_VERSIONS&&(this.versions.shift(),this.versionIndex--)}},e.prototype.undo=function(){this.saveVersion(),this.versionIndex>0&&(this.versionIndex--,this.textArea.val(this.versions[this.versionIndex]),this.nodes=[],this.links=[],this.reload(),this.draw())},e.prototype.redo=function(){this.versionIndex<this.versions.length-1&&(this.versionIndex++,this.textArea.val(this.versions[this.versionIndex]),this.nodes=[],this.links=[],this.reload(),this.draw())},e.prototype.clear=function(){this.saveVersion(),this.nodes=[],this.links=[],this.save(),this.draw()},e.prototype.destroy=function(){clearInterval(this.caretTimer),this.graphCanvas.canvas.off(),this.graphCanvas.canvas.remove()},e.prototype.resetCaret=function(){var a=this;clearInterval(this.caretTimer),this.caretTimer=setInterval(function(){a.caretVisible=!a.caretVisible,a.draw()},500),this.caretVisible=!0},e.prototype.draw=function(){var a,b=this.getCanvas(),c=b.getContext("2d");for(c.clearRect(0,0,this.getCanvas().width,this.getCanvas().height),c.save(),c.translate(.5,.5),a=0;a<this.buttons.length;a++)this.buttons[a].draw(c);if(!this.helpBox.helpOpen){for(a=0;a<this.nodes.length;a++)c.lineWidth=1,c.fillStyle=c.strokeStyle=this.nodes[a]===this.selectedObject?"blue":"black",this.nodes[a].draw(c);for(a=0;a<this.links.length;a++)c.lineWidth=1,c.fillStyle=c.strokeStyle=this.links[a]===this.selectedObject||this.links[a].textBox===this.selectedObject?"blue":"black",this.links[a].draw(c);null!==this.currentLink&&(c.lineWidth=1,c.fillStyle=c.strokeStyle="black",this.currentLink.draw(c))}c.restore(),this.save()},{Constructor:e}});